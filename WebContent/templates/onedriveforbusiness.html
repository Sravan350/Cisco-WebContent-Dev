<!DOCTYPE html>   
<html>
<head>
<meta charset="UTF-8"/>
<title>OneDrive for Business Configuration</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.css" rel="stylesheet" type="text/css"> 
<link href="https://d24wgzqqegxpap.cloudfront.net/api/css/collab-ui-min.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/styles.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/select2.min.css" rel="stylesheet" />  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.js"></script> 
<script type="text/javascript" src="https://d24wgzqqegxpap.cloudfront.net/api/js/porthole.min.js"></script>
<script type="text/javascript" src="https://183.82.99.100:8443/CiscoWebcontent/js/operations1.js"></script>
<script src="https://183.82.99.100:8443/CiscoWebcontent/js/select2.min.js"></script>
<style>

	.search-btn{
		width: 25% !important;
		margin:-4rem 0 0 16.5rem;
		margin-left : 83%;
    }
	#onedriveforbusiness .search_query_block{
		display:none;
		margin-top:20px;
	}
	#onedriveforbusiness .listOfFilesFolderSelected{
		word-wrap:break-word;
		background-color:#FFFFFF;
		border:1px solid #FFFFFF;
		width:100%;
		padding:5px 2px 5px 2px;
	}
	
	#onedriveforbusiness .addclass{
		background-color:rgb(51, 153, 255);
		cursor:default;
		color:#FFFFFF;
	}
	
	#onedriveforbusiness #search_query_input{
		border:0px;
		width:100%;
		margin:0px;
		outline:none;
		border-radius:0px !important;
		border:0px;
	}
	#onedriveforbusiness #select_resource{
		position:absolute;
		z-index:99999;
		display:none;
		width:86.7%;
		border:0px;
	}
	#onedriveforbusiness .listOfFolderTable{
		border-collapse:collapse;
		padding:2px 5px 2px 5px;
		border:0px;
		list-style:none;
	}
	#onedriveforbusiness #search_query_box {
									width: inherit;
									max-height: 300px;
									margin-top:-28px;
									background-color: #FFFFFF;
									overflow-x: hidden;
									border-bottom: 1px solid #0387B8;
									border-right: 1px solid #0387B8;
									border-left: 1px solid #0387B8;
									-webkit-box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
									-moz-box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
									box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
									position:absolute;
									z-index:2;
								}
	.searchtd{
		border:0px;
	}
	.selected{
		background-color:red;
	}
	#onedrive-tooltip {
						margin: -16px 0 0 40px;
					}
	#onedrive-tooltip1 {
						margin: -33px 0 0 40px;
					}
	.subitems-loading1{
			margin: 0 -53px 0 0;
			}
	
	@media screen and (max-width: 650px) {
											#onedrive-tooltip {
																margin: -7px 0 0 9px;
																}
											#onedrive-tooltip1 {
																margin: -7px 0 0 9px;
																}					
											.subitems-loading1{
																margin: 0 -53px 0 0;
																}				
											#onedriveforbusiness #select_resource {
																			position: absolute;
																			z-index: 99999;
																			display: none;
																			width: 85.4%;
																			border: 0px;
																		}
		
										}
@media screen and (max-width: 360px) {
	#onedrive-tooltip {
    margin: -7px 0 0 9px;
}
nedrive-tooltip1 {
    margin: -7px 0 0 9px;
}
}
@media screen and (max-width: 320px) {
	#onedrive-tooltip {
   margin: -7px 0 0 9px;
}
#onedrive-tooltip1 {
   margin: -7px 0 0 9px;
}
}
@media screen and (max-width: 273px) {
	#onedrive-tooltip {
    margin: -7px 0 0 9px;
}
#onedrive-tooltip1 {
   margin: -7px 0 0 9px;
}
}

</style>

<script>
	integration_app_icon_url="https://d24wgzqqegxpap.cloudfront.net/api/images/onedriveforbusiness/onedriveforbusiness.png";
	clientAppRevokeMsg = '<p class="integrationAuthMsg"><span class="info-icon" title=""> &nbsp;</span><span>We are facing difficulty while accessing your OneDrive for Business account. Please click on Add to authorize.</span></p>';
	var application_id="27";
	var selected_source_id="0";
	var selected_subfolder_id ="0";
	var source_name_old="";	
	var instanceUuid ="";
	var room_id = "";
    var selectedSourceId = "";
	var eventsMatchFlag = true;
	var configFlag = false;
	var folderFlag = false;
	var selectedSubSourceId ="";
	var sub_source_modified = false;
	var sub_source_id_old = "0";
	var saveJsonString = "";
	var selectedRoomName = "";
	var action_url = "";
	var actionType = "";
	var getvalueflag=0;
	var selectedItemId = 0 ;
	var search_item_id = 0;
	var searchItemText = "";
	
	var flagFileSelected = false;
	var y=-1;
	var scrollDownflag=0;
	var getvalueflag = 0;
	var searchqueryflag = false;
	var file_folder_list_save = "";
	var file_folder_list_edit = "";
	var saveinstanceflag = false;
	var editinstanceflag = false;
	var saveInstance = false;
	var isFile=false;
	var subfolders="";
	var notifications="";
	var search_Item_Id_Onedrive=0;
	var validatefilelist={};
	var urlValid=false;
	var entered_url=false;
	var search_query_path="";	
	var search_input_insatance_id="";
	var search_input_insatance_value="";
	var searchQueryPath= "";
	var searchResponse = false;
	var folderFileResponse = "";
	appName = "OneDrive for Business";
	postMessageToSpark = appName+" "+postMessageToSpark;
	updateMessageToSpark= appName+" "+updateMessageToSpark;
	removeMessageToSpark= appName+" "+removeMessageToSpark;
	$(document).ready(function(){
		application_auth_details_url="/api/applications/"+application_id;
		token_url="/api/integrations/"+integration_id+"/authDetails";
		save_spark_token_url="/api/clients/tokens";
		save_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		get_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		configuration_settings_url="/api/integrations/"+integration_id+"/uiSettings";
		save_configuration_settings_url="/api/integrations/instances";
		update_configuration_settings_url="/api/integrations/instances/";
		delete_instance_url="/api/integrations/instances/";
		list_integration_instances_url="/api/integrations/instances";		
		removeall_integration_instances_url="/api/integrations/instances";		
		delete_spark_token_url="/api/clients/tokens";
		delete_integration_token_url="/api/integrations/"+integration_id+"/appTokens";
		getSparkSpaceDetails = "/api/integrations/"+integration_id+"/getSparkSpaceDetailsBySpaceId";
		$('#integration-form').hide();
		action=action.toLowerCase();
		if(action=="connect") {
			formAction="connect";
			$("#integrations-block").hide();
			$("#integration-form").hide();
			$("#onedrivesearchfunction").hide();
			validateIntegrationAppToken();			
		} else if(action=="disconnect") {
			formAction="disconnect";
			removeAllIntegrationInstances(formAction);
		} else {
			var app_code =   gup(document.referrer, 'code');
			if(app_code!="") {
				generateIntegrationAppToken(app_code); 
				console.log("code..." + app_code);
			} else {
				validateIntegrationAppTokenDB();
			}
		}
		$("#rooms").select2();
		$('#onedriveforbusiness-icon').attr("src", integration_app_icon_url);
		$(".spark-icon").attr("src", spark_icon_url);	
		$("#onedriveforbusiness #submit-button").click(function (e){
			e.preventDefault();
			saveOneDriveInstance();
		});
		$("#cancel-button").click(function (e){
			$('#select_resource').hide();
			e.preventDefault();			
			$('#integration-form').hide();
			$('#integrations-block').show();
			if(listResultData.length == 0)listIntegrations();
			resize();
		});
		$("#displayName").keypress(function(e){
			if(e.which == 13)
			e.preventDefault();			
		});
		$('.search-btn').on('click',function(){
		console.log("****************");
		if($("#search_query_input").val() != ""){
			searchFunction();
		}else{
		  alert("Please enter folder/file name.");
		}
		});
		$('#onedriveforbusiness #add-config').click(function(e){
			e.preventDefault();	
			$('#select2-rooms-container').html('Please select a space'); 
			formAction="add";
			search_Item_Id_Onedrive = 0;
			urlValid=false;
			searchResponse= false;
			$("#event_note").show();
			$("#create").attr("disabled",false);
			$(".subfolderSelection").hide();
			$("#onedrivesearchfunction").hide();
			$('.items-loading').hide();
			$('#resources').find("optgroup option").remove();
			if(listResultData.length != 0){
				$("#submit-button").text("Add");
				if(isClientAppTokenValid){
					loadOneDriveForBusinessForm();
					loadRooms();
					$('.client-app-warning').html('');
				}else{
					setIntegrationAppAuthDetails(integration_id);
				}
			}
			else{
				$("#submit-button").text("Add Integration");				
				validateIntegrationAppToken();				
			}
		});
		$("#onedriveforbusiness #resources").on('change',function(){
			if($('#resources').val()!=0&&formAction=="update")
				$(".edit-itemconfig-info").hide();
			$('#subfolders').find("option:gt(0)").remove();
		});	
		$("#subfolders").on('change',function(){
				$('#search_query_input').val('');
				$("#onedrivesearchfunction").hide();
				$(".search-item-info").hide();
				search_item_id = 0;
			if($('#subfolders').val()!=0){
				console.log("subfolders on change");
				$.each(subfolders, function(id,obj){
					if($('#subfolders').val() == obj.id && obj.folder ){
						$("#onedrivesearchfunction").show();
						$("#event_note").show();
						$("#create").attr("disabled",false);
						selectedItemId=$("#subfolders").val();
						console.log("======Sub folder======"+selectedItemId);
						return false;
					}else if($('#subfolders').val() == obj.id && obj.file ) {
						console.log("subfolders change!!!");
						$('#create').prop('checked', false);
						$("#create").attr("disabled",true);
						$("#onedrivesearchfunction").hide();
						$("#event_note").hide();
						selectedItemId=$("#subfolders").val();
						console.log("======Sub File======"+selectedItemId);
						return false;
					}else {
						if(formAction=="update"&& $("#subfolders").val()!=0&&obj.file){
							console.log("subfolder change formaction update!!!");
							$('#create').prop('checked', false);
							$("#create").attr("disabled",true);
							$("#onedrivesearchfunction").hide();
							$("#event_note").hide();
						}
					}
				});
				
			}else{
				$('#create').prop('checked', false);
				$("#create").attr("disabled",false);
				$("#event_note").show();
				$("#onedrivesearchfunction").hide();
			}
			resize();
		});	
		$("#onedriveforbusiness #rooms").on('change',function(){
			if($('#rooms').val()!=0&&formAction=="update")
				$(".edit-roomconfig-info").hide();
		});
		$("#resources").change(function () {
			$("#search_query_input").val("");
			$('#onedrive_folders').show();
			$('#onedrive_files').show();
			$("#onedrivesearchfunction").hide();
			$('.subfolderSelection').hide();
			$(".search-item-info").hide();
			search_item_id = 0;
			var itemData = ui_settings["integrationSpecificSettings"]["settings"]["flodersList"]["value"]; 
			$.each(itemData, function(id,obj){	
				if(obj.hasOwnProperty("file")){
					$('.subfolderSelection').hide();
					$("#onedrivesearchfunction").hide();
					if(obj.id==$("#resources").val()){
						console.log("resource change!!!!");
						$('#event_note').hide();
						$('#create').prop('checked', false);
						$("#create").attr("disabled",true);
					}
					$('#subfolders')[0].options.length = 1;
				}else if($("#resources").val()==obj.id && $("#resources").val() != '0' && $("#resources").val() != 'all' && $("#resources").val() != 'rootfolders' && $("#resources").val() != 'rootfolders'){
						console.log("folder....");
						selected_subfolder_id = 0;
						var jsonObject={};
						$("#onedrivesearchfunction").hide();
						$("#search_query_input").val('');
						$('#event_note').show();
						$("#create").attr("disabled",false);
						jsonObject["integrationId"] = integration_id;
						jsonObject["userId"] = user_id;
						jsonObject["itemId"] = $("#resources").val();
						jsonString=JSON.stringify(jsonObject);
						getNestedFolderList(jsonString);
						return false;
				}else if($("#resources").val()=="all" || $("#resources").val()=="rootfolders" ){
					console.log("all rootFolders....");
					$('.subfolderSelection').hide();
					$("#onedrivesearchfunction").hide();
					$("#search_query_input").val('');
					$("#search_query_input_id").val('');
					$('#event_note').show();
					$("#create").attr("disabled",false);
				}else if($("#resources").val()=="rootfiles"){
					console.log("rootfiles....");
					$('.subfolderSelection').hide();
					$("#onedrivesearchfunction").hide();
					$("#search_query_input").val('');
					$("#search_query_input_id").val('');$("#onedrivesearchfunction").hide();
					$('#event_note').hide();
					$("#create").attr("disabled",false);
				}
			});
			selectedItemId=$("#resources").val();
			resize();
		});
		$(document).on("click", ".same-config-yes" , function(e) {
			console.log("yes clicked!!!!!!!!!!!!!");
			saveOneDriveInstanceConfig();
		});
		$(document).on("click", ".same-config-no" , function(e) {
			console.log("no clicked!!!!!!!!!!!!!");
			$('#same-configuration').foundation('close');
		});
		$(document).on("click", "#onedriveforbusiness #instance-list-block .edit-config" , function() {
			formAction="update";
			$('#select2-rooms-container').html('Please select a space'); 
			listOfFilesFolders = {};
			source_modified=false;
			sub_source_modified=false;
			room_modified=false;
			search_path_id_modified=false;
			urlValid=false;
			searchResponse = false;
			$("#create").attr("disabled",false);
			$('#resources').find("optgroup option").remove();
			$(".search-item-info").hide();
			$(".edit-itemconfig-info").hide();
			$(".edit-subfolderconfig-info").hide();
			$(".edit-roomconfig-info").hide();
			$("#submit-button").text("Save");
			$(".subfolderSelection").hide();
			$("#onedrivesearchfunction").hide();
			instanceId=this.id;
			$.each(listResultData,function(index,value){
				if(value["instanceId"]==instanceId) {
					instanceData=value;
				}
			});
			console.log("instanceData :: "+JSON.stringify(instanceData));
			selected_room_id=instanceData.channelId;
			room_id_old = instanceData.channelId;
			var config=JSON.parse(instanceData.configJson);
			selected_source_id=config.item_id;
			selected_subfolder_id=config.sub_item_id;
			sub_source_id_old=config.sub_item_id;
			search_item_id = config.search_item_id;
			search_query_path = config.search_path;
			
			console.log("Edit selected_subfolder_id..." + selected_subfolder_id);
			var jsonObject2={};
			jsonObject2["integrationId"] = integration_id;
			jsonObject2["userId"] = user_id;
			jsonObject2["itemId"] = config.item_id;
			jsonString=JSON.stringify(jsonObject2);
			loadOneDriveForBusinessForm();
			$('#displayName').val(config.displayName);
			source_name_old = config.item_id;
			console.log("source_name_old...............326.."+source_name_old);
			instanceUuid = instanceData.instanceUuid;
			var events = config.notifications;			
			if($.isArray(events)) {
				$.each(events,function(index,value){
					$("input[type=checkbox][value="+value+"]").prop("checked",true);
				});
			} else {
				$("input[type=checkbox][value="+events+"]").prop("checked",true);
			}
			
		});	
		
		$('#searchitemsicon').click(function(event){
			event.stopPropagation();
		});
		/*$('#search_query_input').focusout(function(e) {
			alert("Done key Pressed!!!!")
		});*/
		$(document).click(function() {
			y=0;
			getvalueflag=1;
			$("#select_resource").hide();
		});
		
		$("#search_query_input").focus(function(){
			flagFileSelected = false;
		});	
		
		var searchFunction = function(){
			$(".subitems-loading1").show();
			var searchQuery = $("#search_query_input").val();
			console.log("in searchFunction!!!" + searchQuery);
			var listFiles="";
			var newjsonObject = {};
			if(searchQuery != ""){
				urlValid = true;
				searchQueryPath = $("#search_query_input").val();
				newjsonObject["userId"] = user_id;
				newjsonObject["integrationId"] = integration_id;
				newjsonObject["itemId"] = $('#subfolders').val();
				newjsonObject["searchQuery"] = searchQuery;
				newjsonObject["searchPath"] =  "/"+$('#resources option:selected').text()+"/"+$('#subfolders option:selected').text();
				searchqueryflag = true;
				newjsonObject = editFileList(newjsonObject);
			}
		}
		$("#search_query_input").keypress(function(e){
			if(e.which == 13) {
				e.preventDefault();
				$(".search-item-info").hide();
				var addclass = document.getElementsByClassName("addclass").length;
				console.log("addclass length!!!" + addclass);
				if($("#search_query_input").val()!=null && $("#search_query_input").val() != '0' && $("#search_query_input").val()!=""){
					urlValid = true;
					if(addclass!=0 && getvalueflag==0){
						validate_search_query=$("#search_query_input").val($(".addclass").html());
						$("#search_query_input").val($(".addclass").html());
						$("#search_query_input_id").val($(".addclass").attr("id"));
						$("#select_resource").hide();
						$("#search_query_box").html("");
						return;
					}else {
						console.log("search_query_input in else !!!!!");
						y=0;
						getvalueflag=0
						searchFunction();
					}
				}else{
					console.log("no input provided!!!!!!!!");
					$(".subitems-loading1").hide();
					urlValid = false;
					searchResponse = false;
					alert("Please Enter text and Press Enter or Click on Search icon.");
					return false;
				}
			}
		});
	
		$("#search_query_input").on("keydown",function(e){
			console.log("urlValid in keyPress ::::--- < "+e.keyCode);
			if(e.keyCode == 13){
				urlValid = true;
			}else{
				console.log("keycode!!!" + e.keyCode);
				if(e.keyCode==37 || e.keyCode==39 || e.keyCode==38 || e.keyCode==40){
					urlValid = true;
				}else if(e.keyCode != 17 || e.keyCode != 16 || e.keyCode != 18 || e.keyCode != 9) {
					console.log("in keycode cond!!!" + e.keyCode + "urlValid!!!!" + urlValid);
					urlValid = false;
					searchResponse= false;
					$(".create-chkbox").prop("disabled", false);
				}
			}
		});	
		$("#searchitemsicon").click(function(){
			if($("#search_query_input").val()!=null && $("#search_query_input").val() != '0' && $("#search_query_input").val()!=""){
				searchFunction();
			}else{
				alert("Please Enter text and Press Enter or Click on Search icon.");
			}
		});
		if (iOS) {
		   $(document).on('touchstart', ".listOfFilesFolderSelected", function (e) {
			   selectSearchItems(this);
		   });
		}
		$(document).on("click", ".listOfFilesFolderSelected", function(e){
			 selectSearchItems(this);
		});
		
		$(document).on("mouseover",".listOfFilesFolderSelected",function(){
			$(".listOfFilesFolderSelected").removeClass("addclass");
			$(this).addClass("addclass");
			y = $(this).index();
		});
	});
		function selectSearchItems(currentData){
			flagFileSelected = true;
			var fileFlag = false;
			var folderFlag = false;
			$("#search_query_input").val($(currentData).html());
			//$("#search_query_input_id").val($(".addclass").attr("id"));
			$("#search_query_input_id").val($(currentData).attr("id"));
			urlValid = true;
			searchResponse = true;
			first_search=($(currentData).html());
			selectedItemId=($(currentData).attr("id"));
			search_Item_Id_Onedrive=($(currentData).attr("id"));
			if($("#search_query_input").val()!="No results found") urlValid = true;
			$(".edit-itemconfig-info").hide();
			$("#select_resource").hide();
			var responseData = folderFileResponse["postSpecificIntegrationSettings"]["searchResponse"];
			$.each(responseData, function(id,obj){
				if(obj.hasOwnProperty("folder") && !fileFlag){
					if($("#search_query_input_id").val()==obj.id && !folderFlag){
						console.log("folder selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
						folderFlag = true;
						$('#event_note').show();
						$(".create-chkbox").prop("disabled", false);
					}
				}else if(!folderFlag){
					if (iOS){alert("file condition!!!!!" +$("#search_query_input_id").val() + "obj.id!!!" + obj.id);}
					if($("#search_query_input_id").val()==obj.id && !fileFlag){
						console.log("file    selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
						fileFlag = true;
						$('#event_note').hide();
						$('.create-chkbox').prop('checked', false);
						$(".create-chkbox").prop("disabled", true);
					}
				}
			});
			console.log("after selecting value!!!!" + $("#search_query_input").val());
		}
		var editFileList = function(newjsonObject){
		alert("in editFileList!!!!");
		var file_folder_list = "";
		folderFileResponse = "";
			$.ajax({
					url: configuration_settings_url,
					async:true,
					headers: { 'userId': user_id, 'x-csrf-jwt' : csrfJwt},
					type: "POST",
					data: JSON.stringify(newjsonObject),
					contentType: "application/json",
					dataType: "json",
					success: function(result, textStatus, request){
						if(request.getResponseHeader('x-csrf-jwt') != null){
							csrfJwt = request.getResponseHeader('x-csrf-jwt');
						}
						file_folder_list = result;
						folderFileResponse = result;
						if(searchqueryflag){
							searchFunction(result);
							searchqueryflag=false;
						}
					},
					error: function(xmlHttpRequest,error) {
						alert(error)
					}
			});
			return file_folder_list;
		};
	
		function validateSearchFolderOrFile(searchItemString){
			console.log("in validateSearchFolderOrFile!!!!!!");
			$.ajax({
				url: configuration_settings_url,
				method: "POST",
				headers: { 'userId': user_id },
				data: searchItemString,
				contentType: "application/json",
				dataType: "json",
				async: false,
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					 if(result["postSpecificIntegrationSettings"]["searchItemDetails"]!= undefined && result["postSpecificIntegrationSettings"]["searchItemDetails"] != ""){
						if(result["postSpecificIntegrationSettings"]["searchItemDetails"] != $("#search_query_input").val())
						{
							entered_url = false;
							console.log("---- > result[postSpecificIntegrationSettings][searchItemDetails] "+result["postSpecificIntegrationSettings"]["searchItemDetails"])
						}else {urlValid= true; searchResponse = true; entered_url = true;console.log(" ----- > <--------")}
					 
					 }
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						alert(" value is modified We've experienced some difficulty. Try again.");
					}
				}
			});
		}
				
		function getSearchItemDetails(searchItemString){
		console.log("getSerachitemDetails");
			$.ajax({
				url: configuration_settings_url,
				method: "POST",
				headers: { 'userId': user_id },
				data: searchItemString,
				contentType: "application/json",
				dataType: "json",
				async: true,
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					 if(result["postSpecificIntegrationSettings"]["searchItemDetails"]!= undefined){
						console.log("fail "+result["postSpecificIntegrationSettings"]["searchItemDetails"])			
							searchItemText = result["postSpecificIntegrationSettings"]["searchItemDetails"];
							console.log("result['postSpecificIntegrationSettings']['folder']!!!" + result["postSpecificIntegrationSettings"]["folder"]);
							if(result["postSpecificIntegrationSettings"]["folder"]==false){
								console.log("in false cond!!!!");
								//$('.create-chkbox').prop('checked', false);
								$("#event_note").hide();
								$(".create-chkbox").prop("disabled", true);
							}else{
								$("#event_note").show();
							}
							console.log("searchItemText "+searchItemText+" search_item_id "+search_item_id);
							if(searchItemText!=false){
								$("#search_query_input").val(searchItemText);
								$("#search_query_input_id").val(search_item_id);
							}else if(searchItemText==false){
								$("#search_query_input").val("");
								$("#search_query_input_id").val("");
							}
							if(formAction=="update" && search_item_id == $("#search_query_input_id").val() ){
								console.log("selected_item_id:selectedItemId "+search_item_id);
								console.log("search_Item_Id_Onedrive ......  "+search_Item_Id_Onedrive);
								urlValid = true;
								searchResponse = true;
								selectedItemId = search_item_id;
								search_Item_Id_Onedrive = search_item_id;
							}
							if(formAction=="update" && searchItemText==false){
								console.log("formaction update!!! searchItemText" + searchItemText);
								$(".search-item-info").show();
								$("#search_query_input").val("");
								$("#search_query_input_id").val("");
							}
						}
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						alert(" value is modified We've experienced some difficulty. Try again.");
					}
				}
			});
		}
		function searchFunction(file_folder_list) {
			var listOfFilesFolders = file_folder_list["postSpecificIntegrationSettings"]["searchResponse"];
			console.log("listOfFilesFolders!!!!!!!!" + listOfFilesFolders);
			validatefilelist={};
			var listLength = listOfFilesFolders.length;
			validatefilelist=listOfFilesFolders;
			if(listLength>0){
				console.log("results!!!!!!!!!");
				searchResponse = true;
				listFiles = '<ul class="listOfFolderTable">';
				for(var xi = 0; xi < listLength; xi++){
					listFiles+='<li class="listOfFilesFolderSelected" id="'+listOfFilesFolders[xi]["id"]+'">'+listOfFilesFolders[xi]["path"]+'</li>';
				}
				listFiles+='</ul>';
			}else{
				console.log("no results!!!!!!!!!");
				searchResponse = false;
				$("#search_query_input_id").val("");
				$(".create-chkbox").prop("disabled", false);
				listFiles = '<ul class="listOfFolderTable">';
				listFiles+='<li class="listOfFilesFolderSelected" id="">No results found</li>';
				listFiles+='</ul>';
			}
			$("#search_query_box").html(listFiles);
			$("#select_resource").show();
			$("#search_query_box").scrollTop(0);
			$(".subitems-loading1").hide();
		}
	
		$(document).keydown(function(e){
			var focused = $(':focus');
				if(focused.attr("id")=="search_query_input"){
					if(e.keyCode==40){
						if(scrollDownflag!=0){
							y++;
							scrollDownflag=1;
						}
						$(".listOfFilesFolderSelected").removeClass("addclass");
						var list = document.getElementsByClassName("listOfFilesFolderSelected");
						if(y>=list.length)
							y=list.length-1;
						list[y].classList.add("addclass");
						var offsetHeight = list[y].offsetHeight;
						
						if(y>2){
							 document.getElementById('search_query_box').scrollTop += offsetHeight;
						}
						y++;
					}else if(e.keyCode==38){
						scrollDownflag = 0;
						y--;
						$(".listOfFilesFolderSelected").removeClass("addclass");
						var list = document.getElementsByClassName("listOfFilesFolderSelected");
						if(y<0)
							y=0;
						list[y].classList.add("addclass");
						var offsetHeight = list[y].offsetHeight;
						if(y<(list.length-2)){
							 document.getElementById('search_query_box').scrollTop -= offsetHeight;
						}
					}else if(e.keyCode!=13){
						getvalueflag = 1;
					}
				}
		});
	
	function validateIntegrationAppToken() {
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					console.log("in validateIntegrationAppToken token exists.");
					validateIntegrationAppspecificToken();
				} else {
					setIntegrationAppAuthDetails(integration_id);
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateIntegrationAppspecificToken(){
		console.log("in validateIntegrationAppspecificToken");
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false ){
						isClientAppTokenValid = false;
						console.log("in validateIntegrationAppspecificToken app token not exist.");
						$('#integrations-block').show();
						if(listResultData.length==0){
							setIntegrationAppAuthDetails(integration_id);
						}else{
							$('.client-app-warning').html(clientAppRevokeMsg);
							$('.client-app-warning').show();
						}
					}else{
						console.log("in validateIntegrationAppspecificToken app token exist.");
						loadOneDriveForBusinessForm();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateIntegrationSpecificAppToken(app_code){
		console.log("in validateIntegrationSpecificAppToken");
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false ){
						isClientAppTokenValid = false;						
						if(app_code!="")
						getIntegrationAppTokenDetails(app_code);
						else setIntegrationAppAuthDetails(integration_id);						
					}else{
						isClientAppTokenValid = true;
						listIntegrations();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		
	}
	function getListInstances(){
		console.log("in getListInstances.");
		$.ajax({url: list_integration_instances_url+"?integrationId="+integration_id,
			async:true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
			 instanceList = result;
			 if(instanceList.length != 0 && instanceList.message == undefined){
				 console.log("instanceList in getListInstances()"+instanceList.length);
				 listIntegrations();
			 }else{
				 loadOneDriveForBusinessForm();
			 }
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }
			}
		});
	}
	function setIntegrationAppAuthDetails() {
		var OAUTHURL    =   '';
		var CLIENTID    =   '';
		var TYPE        =   'code';
		//var SCOPE = 'onedrive.readwrite offline_access wl.photos wl.skydrive onedrive.appfolder';
		var SCOPE = 'onedrive.read offline_access onedrive.appfolder';
		var REDIRECT_URI = "https://183.82.99.100:8443/CiscoWebcontent/spark1.html";
		$.ajax({url: application_auth_details_url,
			async:true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				CLIENTID=result.clientId;
				console.log("CLIENTID.." + CLIENTID);
				OAUTHURL= result.authorizationEndpoint;		
				console.log("authorizationEndpoint.." + OAUTHURL);				
				OAUTHURL=OAUTHURL+'?response_type='+TYPE+'&client_id='+CLIENTID+'&redirect_uri='+REDIRECT_URI+'&scope='+SCOPE;
				loginWithAuthDetails(OAUTHURL);	
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});		
	}
	function loginWithAuthDetails(oauthURL) {
		isRedirect=true;
		if(isRedirect) {
			if(formAction=="add") {
				window.top.location.href = oauthURL;
			} else {
				var authReqMsg ="";
				authReqMsg+='<hr class="instance-hr"><div class="large-12 medium-12 columns instance-background">';
				authReqMsg+='<div class="no-config-msg">You are not authorized to this integration. Click Add to continue.</div></div>';
				$('#integrations-block').show();
				$("#instance-list-block").html(authReqMsg);
			}			
			console.log('You are using a mobile device!' + oauthURL);
		} else {
			var win = window.open(oauthURL, "windowname1", 'width=600, height=600'); 
			if(win){ 
			}else{
				alert(popblockedMessage); 
				return false;
			}
			var pollTimer = window.setInterval(function() { 
				try {
					if (win.document.URL.indexOf("code") != -1) {
						window.clearInterval(pollTimer);
						var url =   win.document.URL;
						accessCode =   gup(url, 'code');
						win.close();
						getIntegrationAppTokenDetails(accessCode);
					}
				} catch(e) {
					console.log('error while getting authorization code..'+e);
				}
			}, 100);
		}
    }
	function getIntegrationAppTokenDetails(code) {
		console.log("in getIntegrationAppTokenDetails");
		var jsonObject={};
		jsonObject["integrationId"] = integration_id;
		jsonObject["authSettings"] = {};
		jsonObject["authSettings"]["code"] = code;
		jsonString=JSON.stringify(jsonObject)
		$.ajax({url: token_url,
			async:true,
			type: "POST",
			headers: { 'userId': user_id, 'x-csrf-jwt' : csrfJwt},
			data: jsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				var tokenDetails=result["integrationSpecificAuthDetails"];
				var jsonObject1={};
				jsonObject1["applicationId"] = application_id;
				jsonObject1["integrationId"] = integration_id;
				jsonObject1["accessToken"] = tokenDetails.accessToken
				jsonObject1["refreshToken"] = tokenDetails.refreshToken;
				jsonObject1["refreshExpires"] = tokenDetails.expires;
				jsonObject1["subDomain"] = tokenDetails.subDomain;
				var jsonString=JSON.stringify(jsonObject1);					
				saveIntegrationAppToken(jsonString);
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function saveIntegrationAppToken(jsonData){
		$.ajax({url: save_app_token_url,
			async:true,
			type: "POST",
			headers: { 'userId': user_id, 'x-csrf-jwt' : csrfJwt},
			data: jsonData,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}		
				connectIntegration();		
				console.log("in saveIntegrationAppToken isClientAppTokenValid "+isClientAppTokenValid);
				if(isClientAppTokenValid == false){
					isClientAppTokenValid=true;
					getListInstances();
				}else loadOneDriveForBusinessForm();
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
			   console.log("Error "+JSON.stringify(error));
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});	
	}
	function getNestedFolderList(jsonString){
		var itemFlag=false;	
		var checkFileFlag = false;
		var foldersCount=0;
		var filesCount=0;
		$(".edit-subfolderconfig-info").hide();
		/*if( $("#resources").val() != 0 && $("#resources").val() != 'all' && $("#resources").val() != 'rootfolders' && $("#resources").val() != 'rootfiles'){
			$('.subfolderSelection').show();
			$(".subitems-loading").show();
		}*/
		$.ajax({url: configuration_settings_url,
				async:true,
				type: "POST",
				headers: { 'userId': user_id, 'x-csrf-jwt' : csrfJwt},
				data: jsonString,
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					console.log("success..");
					if(result["postSpecificIntegrationSettings"]["subItems"]!= undefined){
						$(".subitems-loading").hide();
						subfolders = result["postSpecificIntegrationSettings"]["subItems"]["value"]; 
						$('#subfolders')[0].options.length = 1;	
						if(subfolders.length != 0){
							$.each(subfolders, function(id,obj){
								if(obj.folder){
									foldersCount++;
								    $("#onedrive_folders").append($('<option>').text(obj.name).attr('value',obj.id));
									$("#onedrive_folders").show();
							    }
								if(obj.file){
									filesCount++;
									$("#onedrive_files").append($('<option>').text(obj.name).attr('value',obj.id));
									$("#onedrive_files").show();
									if(selected_subfolder_id==obj.id&& checkFileFlag==false){
										checkFileFlag = true;
									}
								}
								//$("#subfolders").append($('<option>').text(obj.name).attr('value',obj.id));
								if(formAction=="update" && selected_subfolder_id==obj.id || selected_subfolder_id=="all" && itemFlag==false){
									console.log("each selected_subfolder_id..." + selected_subfolder_id);		
									if(selected_subfolder_id=="all"){
										selected_subfolder_id=0;
										$("#onedrivesearchfunction").hide();
									}else {	
											selected_subfolder_id=obj.id;
											if(checkFileFlag){
												$("#onedrivesearchfunction").hide();
												$('#event_note').hide();
												$('#create').prop('checked', false);
												$("#create").attr("disabled",true);
											}else{
												console.log("getNestedFolderList formaction update!!! else cond!!!!");
											    $("#onedrivesearchfunction").show();
												//$('#create').prop('checked', false);
												$("#create").attr("disabled",false);
												$('#event_note').show();
											}
									}
									itemFlag=true;
								}
							});
							if(filesCount == 0) $("#onedrive_files").hide();
							if(foldersCount == 0) $("#onedrive_folders").hide();
							if( $("#resources").val() != 0 && $("#resources").val() != 'all' && $("#resources").val() != 'rootfolders' && $("#resources").val() != 'rootfolders')
							if(foldersCount==0&&filesCount==0){$('.subfolderSelection').hide();alert("Selected folder doesn't have any subitems.");}else{$('.subfolderSelection').show();}
							if(search_item_id != 0){ 
								var obj = {};
								obj["searchItemId"] = search_item_id;
								obj["integrationId"] = integration_id;
								obj["userId"] = user_id;
								var searchItemString = JSON.stringify(obj);
								getSearchItemDetails(searchItemString);
							}
							resize();
						}else{
							selected_subfolder_id = "0";
							$('.subfolderSelection').hide();
							$(".subitems-loading").hide();
							$(".edit-subfolderconfig-info").hide();
							alert("Selected folder doesn't have any subitems.");
						} 
						if(formAction=="update" && itemFlag==false && selected_subfolder_id!=0){
							selected_subfolder_id = "0";
							$(".edit-subfolderconfig-info").show();
						}
						
						$("#subfolders").val(selected_subfolder_id);
						selected_subfolder_id="0";
					}else{
						$("#integration-form").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$(".subfolderSelection").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			
			
	}
	function generateIntegrationAppToken(app_code) {
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					validateIntegrationSpecificAppToken();
				} else {
					getIntegrationAppTokenDetails(app_code); 
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function getAuthUser(){
		if( ui_settings["integrationSpecificSettings"] != undefined){
			if( ui_settings["integrationSpecificSettings"]["settings"] != undefined)
			authenticated_user=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"]["owner"]["user"].displayName;
		}
	}
	function loadOneDriveForBusinessForm(){		
		$("#form").trigger("reset");
		$('#integrations-block').hide();
		$("#integration-form").show();
		$(".edit-roomconfig-info").hide();
		$(".edit-itemconfig-info").hide();
		$("#onedrivesearchfunction").hide();
		$(".rooms-loading").show();
		resize();	
		//if(ui_settings=="") {	
			$(".items-loading").show();
			$.ajax({
				url: configuration_settings_url,
				async: true,
				headers: { 'userId': user_id },
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					$(".items-loading").hide();
					ui_settings=result;	
					loadConfigurationSettings();
					loadRooms();
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$('#integration-form').html("We've experienced some difficulty. Try again.");
						$('#integration-form').hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			getAllSparkRooms();
		/*}else{
			loadConfigurationSettings();
		}*/
	}
	function loadConfigurationSettings() {
		if(ui_settings["sparkRoomSettings"]!= undefined && ui_settings["integrationSpecificSettings"]["settings"]!=undefined) {
			//$("#integration-form").show();
			$("#onedrivesearchfunction").hide();
			var itemFlag=false;
			var roomFlag=false;
			var folderMatchFlag=false;
			var rooms = "";
			var authorizedto=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"]["owner"]["user"].displayName;
			if(authorizedto!=""&& authorizedto!=undefined) {
				$('#authenticted-to').html(authorizedto);
				$(".authenticted-block").css("display","block");
			}
			var itemslist = ui_settings["integrationSpecificSettings"]["settings"]["flodersList"]["value"]; 
			$('#rooms')[0].options.length = 1;
			rooms = ui_settings["sparkRoomSettings"].items;
			if(allRooms.length !=0) {
				rooms = allRooms;
				//$(".rooms-loading").hide();
			}
			//if(!isMobile)$("#rooms").customselect("destroy");
			$('#resources')[0].options.length = 4;				
			$.each(rooms, function(id,obj){
				obj.title=$('<div />').html(obj.title).text();
				console.log("obj.title!!!!html!!!" + obj.title);
				$("#rooms").append($('<option>').text(obj.title).attr('value',obj.id));
				if(formAction=="update" && selected_room_id==obj.id&&roomFlag==false){
					selected_room_id=obj.id;
					roomFlag=true;
				}
			});	
			if(formAction=="update" && roomFlag==false){
				selected_room_id = "0";
				$(".edit-roomconfig-info").show();
			}
			var foldersCount = 0,filesCount = 0;
			$.each(itemslist, function(id,obj){	
				if(obj.hasOwnProperty("file")){
					filesCount++;
					$("#files").append($('<option>').text(obj.name).attr('value',obj.id));
				}else if(obj.hasOwnProperty("folder")){
					foldersCount++;
					$("#folders").append($('<option>').text(obj.name).attr('value',obj.id));
					if(formAction=="update" && selected_source_id==obj.id && folderMatchFlag==false){
						folderMatchFlag=true;
					}
				}
				if(formAction=="update" && selected_source_id==obj.id && itemFlag==false){
					selected_source_id=obj.id;
					itemFlag=true;
					
				}
				if(formAction=="update" && obj.hasOwnProperty("file") && selected_source_id==obj.id){
					console.log("ui settings!!!!!!");
					$('#create').prop('checked', false);
					$("#create").attr("disabled",true);
					$("#event_note").hide();
					
					
				}
			/*	if(formAction=="update" && obj.hasOwnProperty("folder") && selected_source_id==obj.id){
					console.log("ui settings!!!!!!");
					//$('#create').prop('checked', false);
					$("#create").attr("disabled",false);
					$("#event_note").show()
				} */
			});
			if(formAction=="update" && itemFlag==false){
				if(selected_source_id!="all"&&selected_source_id!="rootfolders"&&selected_source_id!="rootfiles"){
					selected_source_id = "0";
					$(".edit-itemconfig-info").show();
				
				}
			}
			if(foldersCount == 0){
				$("#folders").hide();
			}
			if(filesCount == 0){
				$("#files").hide();
			}				
			$("#rooms").val(selected_room_id);
			$("#resources").val(selected_source_id);
			// check if selected search item is there ar not by call api
			console.log("searchItemText :::: "+searchItemText);
			//$("#search_query_input").val(searchItemText);
			if(formAction=="update"&&folderMatchFlag){
				getNestedFolderList(jsonString);
			}
			$('#select2-rooms-container').html($("#rooms option:selected").text());
			$(".rooms-loading").hide();
			//selected_room_id="0";
			selected_source_id = "0";
			//if(!isMobile)$("#rooms").customselect();
		} else {
			alert("We've experienced some difficulty. Try again.");
		}	
	}
	function validateConfiguration(instance, notifications){
		var configData = JSON.parse(instance.configJson);
		var configEvents = configData.notifications;
		var notificationsLength = notifications.length;
		var matchCount = 0;
		configFlag = false;
		eventsMatchFlag = true;
		
		if($("#resources").val()=="all" || $("#resources").val()=="rootfolders" ||$("#resources").val()=="rootfiles" ){
			$(".subfolderSelection").hide();
			$("#onedrivesearchfunction").hide();
		}
		if($("#subfolders").val()==0&&folderFlag){
			 subfolder_id= "all";
		}else{
			subfolder_id= $("#subfolders").val();
			
			
		}console.log("Before if condition......");
		if(instance.channelId==room_id&&configData.item_id==selectedSourceId&&configData.sub_item_id==subfolder_id&&configData.search_item_id==search_Item_Id_Onedrive){
		console.log("with in if condition......");
			configFlag = true;
		}
		if($.isArray(notifications)){
			if($.isArray(configEvents)){
				for (var p in notifications) {
					if(configEvents[p] != notifications[p]){
						eventsMatchFlag = false;
					}else {
						matchCount = matchCount +1;
					}
					if(matchCount==configEvents.length&&notificationsLength==configEvents.length){
						eventsMatchFlag = true;
						return false;
					}else{
						eventsMatchFlag = false;
					}
				}
			}else{
				eventsMatchFlag = false;
			}
		}else{
			if($.isArray(configEvents)){
			    eventsMatchFlag = false;
			}else{
			  if(configEvents==notifications){
				eventsMatchFlag = true;
			  }else{
				eventsMatchFlag = false;
			  }
			}
		}
	}
	function saveOneDriveInstance(){
		var res = $('form').serializeObject();
		//$("#onedrivesearchfunction").hide();
		selectedRoomName=$("#rooms option:selected").text();
		selectedSourceId=$("#resources option:selected").val();
		selectedSubSourceId=$("#subfolders").val();
		room_id =$("#rooms option:selected").val();
		var source_name = $("#resources option:selected").val();
		console.log("formAction!!!!" + formAction);
		if(formAction=="update"){
			console.log("in form action update save!!!!!!");
			if($('#search_query_input_id').val() != ""){
				console.log("in search_query_input_id!!!!!!!!!!!!!!!!!!!!");
				var obj = {};
				obj["searchItemId"] = $('#search_query_input_id').val();
				obj["integrationId"] = integration_id;
				obj["userId"] = user_id;
				var searchItemString = JSON.stringify(obj);
				validateSearchFolderOrFile(searchItemString);
			}else{
				console.log("onedrivesearchfunction-----1225");
				$("#onedrivesearchfunction").hide();
			}
		}
		var jsonData = {};
		jsonData["channelId"] = room_id;								
		jsonData["integrationId"] = integration_id;
		jsonData["status"] = "ACTIVE";
		jsonData["userId"] = user_id;
		postAddMessageToRoom(room_id,appName);
		if(formAction=="update") {
			console.log("in form action update!!!!!!");
			jsonData["configJson"]={};
			jsonData["instance_id"] = instanceId;
			jsonData["instanceUuid"] = instanceUuid;
			if(room_id!=room_id_old) {
				room_modified=true;
				jsonData["messageToSpark"] = updateMessageToSpark;
			} else {
				room_modified=false;
			}
			if(search_Item_Id_Onedrive!=search_item_id) {
				search_path_id_modified=true;
			} else {
				search_path_id_modified=false;
			}
			if(source_name!=source_name_old) {
				source_modified=true;
			} else {
				source_modified=false;
			}	
			if(selectedSubSourceId!=sub_source_id_old) {
				sub_source_modified=true;
			} else {
				sub_source_modified=false;
			}
			
			jsonData["source_modified"] = source_modified;
			jsonData["room_modified"] = room_modified;	
			jsonData["configJson"]=JSON.parse(instanceData.configJson);
			action_url=update_configuration_settings_url+instanceId;
			actionType="PUT";
			$('.loading-first-block').html('Please wait while your Integration is being updated');
		} else {
			jsonData["configJson"]={};			
			jsonData["messageToSpark"] = postMessageToSpark;
			action_url=save_configuration_settings_url;
			actionType="POST";
			$('.loading-first-block').html('Please wait while your Integration is being set up');
		}
		jsonData["configJson"]["notifications"] = res.events;
		jsonData["configJson"]["item_id"] = selectedSourceId;
		var itemslist = ui_settings["integrationSpecificSettings"]["settings"]["flodersList"]["value"]; 
		$.each(itemslist, function(id,obj){
			$("#onedrivesearchfunction").hide();		
			if(obj.hasOwnProperty("file")){ 
			}else{
				if(selectedSourceId==obj.id && folderFlag==false){
					folderFlag=true;
				}
			}
		});
		if($("#subfolders").val()==0&&folderFlag){
			 jsonData["configJson"]["sub_item_id"]= "all";
			 $("#onedrivesearchfunction").hide();
		}else if($("#subfolders").val()!=0){
		console.log("config json------1289" + $("#subfolders").val());
		jsonData["configJson"]["sub_item_id"]= $("#subfolders").val();
			$("#onedrivesearchfunction").show();	
		}
		if($("#subfolders").val() !=0 && $("#search_query_input").val() == ""){
			search_Item_Id_Onedrive = 0;
			selectedItemId = $("#subfolders").val();
		}
		if($("#resources").val() !=0 && $("#search_query_input").val() == ""){
			search_Item_Id_Onedrive = 0;
			 $("#onedrivesearchfunction").hide();
		}
		jsonData["configJson"]["search_item_id"] = search_Item_Id_Onedrive;
		jsonData["configJson"]["selected_item_id"] = selectedItemId;
		
		jsonData["configJson"]["resources"] = $("#resources option:selected").val();
		jsonData["configJson"]["displayName"]= res.displayName;
		jsonData["messageFormat"]="OneDrive Bot :"+"Hello...User";		
		
		if($("#search_query_input").val()!=""&&searchResponse&&urlValid){
			jsonData["configJson"]["search_path"] = $("#search_query_input").val();
		}else{
			jsonData["configJson"]["search_id"] = "";
			jsonData["configJson"]["search_path"] = "/"+$('#resources option:selected').text()+"/"+$('#subfolders option:selected').text();
		}
		
		var validateserchbox = false;
		if(validatefilelist.length!=0 && validatefilelist.length!=undefined){
			for(var i=0;i<validatefilelist.length;i++){
				if(validatefilelist[i]["id"]==$("#search_query_input_id").val() && (validatefilelist[i]["path"]+'/'+validatefilelist[i]["name"])==$("#search_query_input").val()){
					validateserchbox = true;
				}
			}
		}else if(search_input_insatance_id==$("#search_query_input_id").val() && search_input_insatance_value==$("#search_query_input").val() && formAction=="update"){
			validateserchbox = true;
		}else if(formAction == 'add' && $("#search_query_input_id").val()==""){
			$("#search_query_input_id").val("");
			validateserchbox = true;
		}
		
		if($("#search_query_input").val()=="" && formAction=="update"){
			$("#search_query_input_id").val("");
			validateserchbox = true;
		}		
		saveJsonString = JSON.stringify(jsonData);
		var notificationslength = objLength(res.events);
		notifications = res.events;
		if(listResultData.length != 0 && notificationslength !=0){
			$.each(listResultData, function(i, instance) {
				if(formAction=="update"&&instance.instanceId!=instanceId){
				 validateConfiguration(instance, notifications);
				 if(eventsMatchFlag==true&&configFlag==true){
						return false;
					}
				}
				if(formAction!="update"){
				 validateConfiguration(instance, notifications);
				  if(eventsMatchFlag==true&&configFlag==true){
						return false;
					}
				}
			});
		}
		console.log("urlvalid!!!!" + urlValid + " searchResponse!!!!" + searchResponse);
		if($('#rooms').val()==0 || $('#rooms').val()==null){ 
		    alert("Please select a space");
		}else if($('#resources').val()==0){ 
		    alert("Please select Folders/Files");
		}else if(urlValid && !searchResponse && $('#search_query_input').val()!=""){
			alert("Please enter valid file/folder name");
		}else if(!urlValid && $('#search_query_input').val()!=""){
			console.log("save cond urlvalid!!!!!!!!" + urlValid);
			alert('Please click enter to search folders/files.');
		}else if(formAction=="update"&&!entered_url && $("#search_query_input").val()!="" && $("#search_query_input").val()!=0){ 
			console.log("save cond entered_url!!!!!!!!" + entered_url);
			alert('Please click enter to search folders/files.');
		}else if(notificationslength==0){ 
		    alert("Please select at least 1 notification");
		}else if(listResultData.length != 0 && eventsMatchFlag==true && configFlag==true){
			if(formAction=="update"){
				$.each(listResultData, function(i, instance) {
					if(formAction=="update"&&instance.instanceId==instanceId){
					 validateConfiguration(instance, notifications);
					}
				});
				console.log("room_modified-"+room_modified+"-source_modified-"+source_modified+"-sub_source_modified-"+sub_source_modified+"-eventsMatchFlag-"+eventsMatchFlag+"-search_path_id_modified-"+search_path_id_modified);
				if(room_modified || source_modified || sub_source_modified || search_path_id_modified || !eventsMatchFlag)
					$('#same-configuration').foundation('open');
				else
					saveOneDriveInstanceConfig();
			}else{
				$('#same-configuration').foundation('open');
			}
		}else {
			saveOneDriveInstanceConfig();
		}
	}
	function saveOneDriveInstanceConfig(){
		$('#same-configuration').foundation('close');
		$('.loading-second-block').html('Selected Space is '+ selectedRoomName);
		$('#loading-block').foundation('open');
		$.ajax({url: action_url,
			async:true,
			type: actionType,
			headers: { 'userId': user_id },
			data: saveJsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				$('#success-integration').foundation('open');
				$('#loading-block').foundation('close');					
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					$('#loading-block').foundation('close');
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		$('.loading-first-block').html('Please wait just a moment while your app is loading');
		$('.loading-second-block').html('');
	}
</script>
</head>
<body>	
	<div class="integration-app" id="onedriveforbusiness">
		<div class="rows large-12 medium-12 columns warning-msg" style="display:none;"></div>
		<div class="rows large-12 medium-12 columns client-app-warning" style="display:none;"></div>
		<div id="loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait just a moment while your app is loading</div>
				<div class="loading-second-block">name and space name</div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="success-integration" class="reveal success-integration" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="success-loading">
				<img class="spark-icon" src="" alt=".....">
			</div>
			<div class="well-done-text">Well done!</div>
			<div class="success-integration-first-block">Your configuration has been set up and is ready to use.</div>
			<!-- <div class="success-integration-note-block"><b>Note:</b> You may see a delay of up to 2 mins to receive notifications into your Cisco Spark spaces after its triggered.</div> -->
			<div class="large-5 medium-5 columns buttons-block">
				<div class="success-integration-second-block">
					<!--<button class="button" id="room-button">Go to
						Content Testing Space</button>-->
					<button class="secondary button" id="done-button">Done</button>
				</div>
			</div>
		</div>
		<div class="reveal" id="remove-integration-popup" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="large-12 columns desktop-block">
				<div class="row ">
					<div class="large-2 medium-2 columns"><img alt="icon" id="onedriveforbusiness-icon" src=""></div>
					<div class="large-6 medium-6 columns" style="float:left;">
						<span id="displayName-label">OneDrive for Business</span><br>
						<span id="addedon-label"></span>
					</div>
				</div><br>
				<div class="msg-labels">
					<label id="remove-msg"></label> 
					<label id="remove-auth"></label>
				</div>
				<button class="close-button" data-close aria-label="Close modal" type="button">
					<span aria-hidden="true">&times;</span>
				</button><br><br>
				<button class="button remove-integration-btn" id="remove-integration-btn" style="float:right">Remove</button>
			</div>
			<div class="large-12 columns mobile-block">	
				<div class="msg-labels">
					<label id="remove-msg-mobile"></label> 
					<label id="remove-auth-mobile"></label> 
				</div>				
				<div class="option-buttons remove-integration-buttons">
					<label id="cancel-remove-integration" class="remove-popup-cancel"> 
						<a href="#" >Cancel</a>
					</label>
					<label class="remove-popup-remove remove-integration-btn">
						<a href="#">Remove</a>
					</label>
				</div>
			</div>
		</div>
		<div id="same-configuration" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="same-config-text">An identical configuration to the same Cisco Spark space you have selected already exists. Are you sure you want to configure one more?</div>
			<div class="large-5 medium-5 columns buttons-block">
				<button class="secondary button same-config-yes">Yes</button>
				<button class="secondary button same-config-no">No</button>
			</div>
		</div>
		<div class="integrations" id="integrations-block">
			<div id="instance-loading-block" class="row instance-loading-block" style="display: none;">
				<div class="instances-loading">&nbsp;</div>
				<div class="instances-loading-text"></div>
			</div>
			<div id="home" class="home">			
				<div class="row add-config-block">
					<div class="large-12 medium-12 columns">							
						<div class="large-6 medium-6 columns config-name"><label>OneDrive for Business configurations</label></div>
						<div class="large-6 medium-6 columns">
							<button class="button" data-open="remove-integration-popup" id="remove-all-config">Remove All</button>
							<button class="secondary button" id="add-config">Add</button>
						</div>					
					</div>
				</div>
				<div id="instance-list-block" class="row instance-list-block">						
				</div>
			</div>
		</div>
		<div id="integration-form" class="large-12 columns" >
			<div class="large-12 medium-12 columns edit-itemconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured folder/file does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-subfolderconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured subfolder does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-roomconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured space does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns search-item-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured path does not exist.</span></p>
			</div>
			<div class="authenticted-block">Authenticated to OneDrive for Business as: <span id="authenticted-to"></span></div>
			<div class="no-configuration-block" style="display:none">There are no folders/files available in your OneDrive for Business Account. Please Add folders/files in your account and configure</div>
			<form name="form" id="form" method="post">
				<div class="row app-config-block">
					<div class="large-10 medium-11 columns first sub-config-block">
						<label class="heading-01">OneDrive for Business configuration</label>
						<div class="large-8 columns">
							<div class="large-3 medium-3 columns items-config">
								<label class="label-config">Folders/Files<span class="has-tip tip-right" id="tooltip" title="Select the folder or file for which you'd like to receive notifications." data-tooltip><img class="tool-tip"></span></label>
							</div>
							<div class="large-5 medium-5 columns dropdown-config text left ">
								<select id="resources" name="resource" class="dropdown">
									<option value='0' hidden>Select folder/file</option>
								    <option value="all">All Folders & Files </option>
									<option value="rootfolders">All Folders (including nested folders and files)</option>
									<option value="rootfiles" >All Files</option>
									<optgroup id="folders" label="Root Folders"></optgroup >
									<optgroup id="files" label="Root Files"></optgroup >																	 
								</select>
								
								<div class="items-loading" style="display: none;"></div>
							</div>								
						</div>
					</div>
					<div class="large-10 medium-11 columns sub-config-block subfolderSelection" style="display:none;">
						<div class="large-8 columns">
							<div class="large-3 medium-3 columns config-optional items-config">
								<label class="label-config">Subfolders/Files (Optional)<span class="has-tip tip-right" id="onedrive-tooltip" title="Select the subfolder or file for which you'd like to receive notifications. If you don't select a subfolder/file here, then you will receive notifications for all subfolders." data-tooltip><img class="tool-tip"></span></label>
							</div>
							<div class="large-5 medium-6 columns dropdown-config text left ">
								<select id="subfolders" name="subfolders" class="dropdown">
									<option value="0">Select subfolder/file</option>
									<optgroup id="onedrive_folders" label="Folders"></optgroup >
									<optgroup id="onedrive_files" label="Files"></optgroup >												
								</select>
								
								<div class="subitems-loading" style="display: none;"></div>
							</div>	
						</div>
					</div>
					<div class="large-10 medium-11 columns first sub-config-block " id="onedrivesearchfunction" style="display: none;">
						<div class="large-8 columns onedrive-search-block">
							<div class="large-3 medium-3 columns config-optional items-config label-config">
								<label class="label-config">Search Folders/Files (Optional)<span class="has-tip tip-right" id="onedrive-tooltip1" title="Recently created files/folders may not appear in search results given Microsoft API behavior. Please try again later if you do not see a file or folder that you recently created." data-tooltip ><img class="tool-tip"></span>							</label>
							</div>
							<div class="large-5 medium-6 columns dropdown-config onedriveforbusiness-searchbox text left">
								<table style='border-collapse:collapse;width:79%;border:1px solid #D7D7D7;margin:0px;border-radius:3px;'>
									<tbody style="border:0px;border:none !important;">
									<tr style='border:none'>
										<td style='width:90%;padding:0px;border:0px;'>
										<input type='text' name="search_query_input" placeholder="Search file or folder" id="search_query_input" class="integration-name" autocomplete='off' value=""/>
										<input type="hidden" id="search_query_input_id" />
										</td>
										<!-- <td class='searchtd' id="searchitemsicon"></td> -->
									</tr>
									</tbody>
								</table>
								<input type="button" class="secondary button search-btn" value="Search"/>
								<div id='select_resource'><div id='search_query_box'></div></div>
							</div>
							
							<!-- <button id="show_folders_btn" class="secondary button">Search</button> -->
							<span class="subitems-loading1" style="display: none;"></span>	
						</div>
					</div>
					<div class="large-12 columns events-config">
						<div class="large-12 medium-12 columns events">
							<label>Notifications</label>
							<div id="events" class="events-sub">
							<div id="event_note">
								<label>Note: If a folder is selected, notifications selected below will be applied to all files and subfolders within the selected folder.</label>
							</div>
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="create" class="create-chkbox" name="events" value="create"/><label for="create">Create</label></div>
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="delete" name="events" value="delete"/><label for="delete">Delete</label></div>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-8 medium-8 columns checkbox"><input type="checkbox" id="modify" name="events" value="modify"/><label for="modify">Update (rename, copy and/or file content update)</label></div>
								</div>
							</div>
						</div>
					</div>
				</div>
			<!--	<div class="row spark-config-block">
					<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
								<option value='0'>Please select a space</option></select>
								<span class="has-tip tip-right" id="tooltip" title="Space in which you`d like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
							</div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5  columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>
						</div>
					</div>
				</div> -->
				<div class="row spark-config-block">
				<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space
									<span class="has-tip tip-right" id="tooltip" title="Space in which you'd like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
									<option value='0'>Please select a space</option>
								</select>
							</div>
							<div class="spaces-refresh" title="Refresh the spaces"></div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>							
						</div>
					</div>
				</div>
				<div class="row integration-config-block">
					<div class="large-5 medium-5 columns"> &nbsp;</div>
					<div class="large-4 medium-4 columns left">
						<button id="cancel-button" class="button">Cancel</button>
						<button id="submit-button" class="button secondary text">Add Integration</button>
					</div>
				</div>
			</form>
		</div>		
	</div>
</body>
</html>