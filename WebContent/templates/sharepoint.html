<!DOCTYPE html>  
<html>
<head>
<meta charset="UTF-8"/>
<title>SharePoint Online Documents Integration to Cisco Spark</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.css" rel="stylesheet" type="text/css"> 
<link href="https://d24wgzqqegxpap.cloudfront.net/api/css/collab-ui-min.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/styles.css" rel="stylesheet" type="text/css"> 
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/select2.min.css" rel="stylesheet" /> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.js"></script> 
<script type="text/javascript" src="https://d24wgzqqegxpap.cloudfront.net/api/js/porthole.min.js"></script> 
<script type="text/javascript" src="https://183.82.99.100:8443/CiscoWebcontent/js/operations1.js"></script> 
<script src="https://183.82.99.100:8443/CiscoWebcontent/js/select2.min.js"></script> 
<style>
    #tooltipurl{margin:9px 0 0 0}
	.subfolder_files_tooltip{margin:-27px 0 0 49px;}
	.site_tooltip{margin:-7px 0 0 -2px !important;}
	.folder_file_tooltip{margin:-7px 0 0 -1% !important;}
	.search_tooltip{margin: -27px 0 0 69px !important;}
	.has-tip tip-right {margin:0 0 0 -2px !important;}
	
	.search-btn{
		width: 25% !important;
		margin:-4rem 0 0 16.5rem;
		margin-left : 83%;
		font-size : 14px;
    }
	#sharepoint #search_query_input{
		border:0px;
		width:100%;
		margin:0px;
		outline:none;
		border-radius:0px !important;
		border:0px;
	}
	#sharepoint .addclass{
		background-color:rgb(51, 153, 255);
		cursor:default;
		color:#FFFFFF;
	}
	#sharepoint .listOfFolderTable{
		border-collapse:collapse;
		padding:2px 5px 2px 5px;
		border:0px;
		list-style:none;
	}
	#sharepoint #search_query_box{
		width:inherit;
		max-height:300px;
		background-color:#FFFFFF;
		overflow-x: hidden;
		border-bottom:1px solid #0387B8;
		border-right:1px solid #0387B8;
		border-left:1px solid #0387B8;
		-webkit-box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
		-moz-box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
		box-shadow: 0px 10px 20px -3px rgba(156,156,156,1);
	}
	#sharepoint #select_resource{
		position:absolute;
		margin-top : -24px;
		z-index:99999;
		width:87.7%;
		border:0px;
		height:300px;
		overflow-y : auto;
	}
	#sharepoint .listOfFilesFolderSelected{
		word-wrap:break-word;
		border:1px solid #FFFFFF;
		width:100%;
		padding:5px 2px 5px 2px;
	}
	<!-- -->
	
	@media screen and (max-width: 650px) {
		.site_tooltip{margin:-10px 0 0 -1px !important;}
		.subfolder_files_tooltip{margin:-8px 0 0 9px;}
		.folder_file_tooltip{margin:-11px 0 0 12px !important;}
		.search_tooltip{margin:-8px 0 0 8px !important;}
	
	}
	
	@media screen and (min-width: 651px) and (max-width: 768px) {
		.folder_file_tooltip{margin:-10px 0 0 0% !important;}
		.subfolder_files_tooltip{margin:-24px 0 0 7px;}
		.search_tooltip{margin: -17px 0 0 9px !important;}
		.site_tooltip{margin:-8px 0 0 1px !important}
		.search-items-loading{margin-right: 10%;}
	}
	@media screen and (min-width: 769px) and (max-width: 840px) {
		.folder_file_tooltip{margin:-18px 0 0 22px !important;}
		.site_tooltip{margin:-34px 0 0 100px !important;}
	}
	
</style>
<script>
	integration_app_icon_url="https://d24wgzqqegxpap.cloudfront.net/api/images/sharepoint/sharepoint.png";
	clientAppRevokeMsg = '<p class="integrationAuthMsg"><span class="info-icon" title=""> &nbsp;</span><span>We are facing difficulty while accessing your SharePoint Online account. Please click on Add to authorize.</span></p>';
	var application_id="29";
	var selected_lib_id=0;
	var selected_lib_id_old="";
	var selected_source_id="0";
	var selected_subfolder_id ="0";
	var source_id_old="";	
	var source_modified =false;
	var instanceUuid="";
	var room_id = "";
	var selected_lib_id_undefine = "";
	var selected_lib_id_update = "";
	var selectedSourceId = "";
	var eventsMatchFlag = true;
	var configFlag = false;
	var folderFlag = false;
	var selectedSubSourceId = "";
	var sub_source_id_old = "0"
	var sub_source_modified = false;
	var saveJsonString = "";
	var selectedRoomName = "";
	var action_url = "";
	var actionType = "";
	var selected_site_url="0";
	var selectedSiteUrl = "";
	var newSiteUrl="";
	var itemslist = "";
	var libId_modified = "";
	var librarylist = "";
	var siteURL = "";
	var selectedWebUrl="";
	var dropDownValue = false;
	var urlValid = false;
	var webURL = "";
	var selected_web_url = "";
	var subfolders = "";
	var last_selected_id = "";
	var file_folder_search = {};
	var file_folder_search_flag = false;
	var file_folder_list = {};
	var search_input_instance_value="";
	var search_input_insatance_id="";
	var site_url_modified = "";
	var y=0;
	var scrollDownflag=0;
	var sitechangeflag = false;
	var saveflag = false;
	var sample = {};
	var saveeee = false;
	var folderFileResponse = "";
	var domainUrl = "";
	var isResourceFolder = true;
	var searchFileNameEdit = "";
	var resourceName = ""; ////
	appName = "SharePoint Online Documents";
	postMessageToSpark = appName+" "+postMessageToSpark;
	updateMessageToSpark= appName+" "+updateMessageToSpark;
	removeMessageToSpark= appName+" "+removeMessageToSpark;
	$(document).ready(function(){
		//console.log("WIndow width:"+$(window).width());
		application_auth_details_url="/api/applications/"+application_id;
		token_url="/api/integrations/"+integration_id+"/authDetails";
		save_spark_token_url="/api/clients/tokens";
		save_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		get_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		configuration_settings_url="/api/integrations/"+integration_id+"/uiSettings";
		save_configuration_settings_url="/api/integrations/instances";
		update_configuration_settings_url="/api/integrations/instances/";
		delete_instance_url="/api/integrations/instances/";
		list_integration_instances_url="/api/integrations/instances";		
		removeall_integration_instances_url="/api/integrations/instances";	
		delete_spark_token_url="/api/clients/tokens";
		delete_integration_token_url="/api/integrations/"+integration_id+"/appTokens";
		getSparkSpaceDetails = "/api/integrations/"+integration_id+"/getSparkSpaceDetailsBySpaceId";
		$('#integration-form').hide();
		action=action.toLowerCase();
		if(action=="connect") {
			formAction="connect";
			$("#integrations-block").hide();
			$("#integration-form").hide();
			validateIntegrationAppToken();			
		} else if(action=="disconnect") {
			formAction="disconnect";
			removeAllIntegrationInstances(formAction);
		} else {
			var app_code =   gup(document.referrer, 'code');
			if(app_code!="") {
				generateIntegrationAppToken(app_code); 
			} else {
				validateIntegrationAppTokenDB();
			}
		} 
		$("#rooms").select2();
		$('#sharepoint-icon').attr("src", integration_app_icon_url);
		$(".spark-icon").attr("src", spark_icon_url);	
		$("#sharepoint #submit-button").click(function (e){
			e.preventDefault();
			if($("#search_query_input_id").val() == "" && $('#search_query_input').val() !=""){
				alert("Selected file/folder does not exist");
			}else{
				saveSharepointOnlineInstance();
			}
		});
		$('.remove-config').click(function(){
			alert("remove clicked");
		});
		$("#cancel-button").click(function (e){
			e.preventDefault();			
			$('#integration-form').hide();
			$('#integrations-block').show();
			if(listResultData.length == 0) listIntegrations();
			resize();
		});
		
		$("#displayName").keypress(function(e){
			if(e.which == 13)
			e.preventDefault();			
		});
		
		$('#sharepoint #add-config').click(function(e){
			e.preventDefault();	
			$('#select2-rooms-container').html('Please select a space'); 
			$('.items-loading').hide();
			saveflag = false;
			formAction="add";
			$('#libraries').find("optgroup option").remove();
			$('#resources').find("optgroup option").remove();
			$('#subfolders').find("optgroup option").remove();
			$("#event-note").show();
			$("#create").prop("disabled",false);
			$('#WebUrl').prop('disabled', false);
			$('.foldersfilesSelection').hide();
			$('.librarySelection').hide();
			$('.subfolderSelection').hide();
			$(".edit-siteconfig-info").hide();
			$(".edit-subfolderconfig-info").hide();
			$('.edit-searched-source-info').hide();
			$(".edit-itemconfig-info").hide();
			$(".edit-roomconfig-info").hide();
			$(".edit-libconfig-info").hide();
			if(listResultData.length != 0){
				$("#submit-button").text("Add");
				if(isClientAppTokenValid){
					loadSharepointOnlineForm();
					loadRooms();
					$('.client-app-warning').html('');
					$("#WebUrl").val('');
				}else{
					setIntegrationAppAuthDetails(integration_id);
				}
			}else{
				$("#submit-button").text("Add Integration");				
				validateIntegrationAppToken();				
			}
		});
		$("#sharepoint #siteurls").on('change',function(){
			if($('#siteurls').val()!=0&&formAction=="update"){
				$(".edit-siteconfig-info").hide();
				console.log("siteurls======="+$('#siteurls').val());
				selected_source_id=$('#siteurls').val();
				}
			$(".foldersfilesSelection").hide();
			$(".librarySelection").hide();
			$('.subfolderSelection').hide();			
			$(".edit-subfolderconfig-info").hide();
			$('.edit-searched-source-info').hide();
			$(".edit-itemconfig-info").hide();
			$(".edit-libconfig-info").hide();
			$(".edit-roomconfig-info").hide();
			
			$(".searchfunction").hide();
			$("#select_resource").hide();
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			resize();
		
		});	
		$("#sharepoint #resources").on('change',function(){
			if($('#resources').val()!=0&&formAction=="update")
			$(".edit-itemconfig-info").hide();
			$(".searchfunction").hide();
			$(".subfolderSelection").hide();
			$("#select_resource").hide();
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			
		});	
		$("#sharepoint #subfolders").on('change',function(){
			
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			if($('#subfolders').val()!=0&&formAction=="update")
				$(".edit-columnconfig-info").hide();
				var label=$('#sharepoint #subfolders :selected').parent().attr('label');
				if(label == "Folders"){
					$(".searchfunction").show();
					$("#event-note").show();
				}else{
					$(".searchfunction").hide();
					$("#select_resource").hide();
					$("#event-note").hide();
				}
				if(label == "Files"){
					$("#event-note").hide();
					$("#create").prop("checked",false);
					$("#create").prop("disabled",true);
				}else{
					$("#event-note").show();
					$("#create").prop("disabled",false);
				}
		});	
		$(document).keydown(function(e){
			var focused = $(':focus');
				if(focused.attr("id")=="search_query_input"){
					if(e.keyCode==40){
						if(scrollDownflag!=0){
							y++;
							scrollDownflag=1;
						}
						$(".listOfFilesFolderSelected").removeClass("addclass");
						var list = document.getElementsByClassName("listOfFilesFolderSelected");
						if(y>=list.length)
							y=list.length;
						list[y].classList.add("addclass");
						var offsetHeight = list[y].offsetHeight;
						
						if(y>2){
							 document.getElementById('search_query_box').scrollTop += offsetHeight;
						}
						y++;
					}else if(e.keyCode==38){
						scrollDownflag = 0;
						y--;
						$(".listOfFilesFolderSelected").removeClass("addclass");
						var list = document.getElementsByClassName("listOfFilesFolderSelected");
						if(y<0)
							y=0;
						list[y].classList.add("addclass");
						var offsetHeight = list[y].offsetHeight;
						if(y<(list.length-2)){
							 document.getElementById('search_query_box').scrollTop -= offsetHeight;
						}
					}else if(e.keyCode!=13){
						getvalueflag = 1;
					}
				}
		});
		$(document).on("mouseover",".listOfFilesFolderSelected",function(){
			$(".listOfFilesFolderSelected").removeClass("addclass");
			$(this).addClass("addclass");
			y = $(this).index();
		});
		$("#search_query_input").keypress(function(e){
			if(e.which == 13) {
				e.preventDefault();
				var addclass = document.getElementsByClassName("addclass").length;
				if($("#search_query_input").val()!=null && $("#search_query_input").val() != '0' && $("#search_query_input").val()!=""){
					if(addclass!=0 && getvalueflag==0){
						$("#search_query_input").val($(".addclass").html());
						$("#search_query_input_id").val($(".addclass").attr("id"));
						$("#select_resource").hide();
						$("#search_query_box").html("");
						return;
					}else{
						y=0;
						getvalueflag=0
						searchFunctionality();
					}
					if(searchFileNameEdit!=undefined && formAction=="update"  && searchFileNameEdit == $("#search_query_input").val()){
						$("#search_query_input_id").val("");
					}
				}else{
					alert("Please enter text and press Enter or click on search magnifier.");
					return false;
				}
			}
		});
		$("#search_query_input").on("keydown",function(e){
			if(e.keyCode == 13){
				$("#create").prop("disabled", false);
				$('#event-note').show();
			}else if(e.keyCode==37 || e.keyCode==39 || e.keyCode==38 || e.keyCode==40 || e.keyCode == 17 || e.keyCode == 16 || e.keyCode == 18 || e.keyCode == 9){
			console.log("Hdffggg");
				if($('#create').is(':disabled')){
					$('#create').prop('checked', false);
					$("#create").prop("disabled", true);
					$('#event-note').hide();
				}else{
					$("#create").prop("disabled", false);
					$('#event-note').show();
				}
			}else{
				console.log("HHHHH");
				$("#create").prop("disabled", false);
				$('#event-note').show();
			}
		});	
		if (iOS) {
			$(document).on('touchstart', ".listOfFilesFolderSelected", function (e) {
			   selectSearchItems(this);
			});
		}
		$(document).on("click", ".listOfFilesFolderSelected", function(){
			 selectSearchItems(this);
		});
		/*$(document).on("click",".listOfFilesFolderSelected",function(){
			var fileFlag = false;
			var folderFlag = false;
			if($(this).html() != "No results found"){
				$("#search_query_input").val($(this).html());
				$("#search_query_input_id").val($(this).attr("id"));
			}else{
				$("#search_query_input").val("");
				$("#search_query_input_id").val("");
			}
			var responseData = folderFileResponse["postSpecificIntegrationSettings"];
			$.each(responseData, function(id,obj){
				if(obj.hasOwnProperty("folder") && !fileFlag){
					if($("#search_query_input_id").val()==obj.id && !folderFlag){
						console.log("folder selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
						folderFlag = true;
						$("#create").prop("disabled", false);
						$('#event-note').show();
					}
				}else if(!folderFlag){
					if($("#search_query_input_id").val()==obj.id && !fileFlag){
						console.log("file    selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
						fileFlag = true;
						$('#create').prop('checked', false);
						$("#create").prop("disabled", true);
						$('#event-note').hide();
					}
				}
			});
		});*/
		$(document).click(function(){
			$("#select_resource").hide();
			$("#search_query_box").html("");
			resize();
		});
	
		$(".search-btn").click(function(){
			console.log("$(#search_query_input).val() "+$("#search_query_input").val());
			if($("#search_query_input").val() == "")
			alert("Please enter text and press Enter or click on search magnifier.");
			searchFunctionality();
		});
		var searchFunctionality = function(){
			if($("#search_query_input").val()==""){
				$('#create').prop("disabled",false);
				$("#select_resource").hide();
				$("#search_query_box").html("");
				return;
			}
			$('.search-items-loading').show();
			var hostURL = "";
			if($("#WebUrl").val() != "" && $("#WebUrl").val() != '0' ){
				hostURL = $("#WebUrl").val();
			}else hostURL = $("#siteurls").val();
			file_folder_search = {};
			file_folder_list = {};
			file_folder_search['siteUrl'] = hostURL;
			file_folder_search['sub_item_id'] = $("#subfolders").val();
			file_folder_search['searchQuery'] = $("#search_query_input").val();
			file_folder_search['searchPath'] = "/"+$("#resources option:selected").text()+"/"+$("#subfolders option:selected").text();
			file_folder_search['userId'] = user_id;
			file_folder_search["libId"] = $("#libraries").val();
			
			file_folder_search['integrationId'] = integration_id;
			file_folder_search_flag = false;
			searchfiles();

			var polling = setInterval(function(){
				if(file_folder_search_flag){
					clearInterval(polling);
					var listOfFilesFolders = file_folder_list["postSpecificIntegrationSettings"];
					console.log("listOfFilesFolders listOfFilesFolders "+JSON.stringify(listOfFilesFolders));
					var listLength = listOfFilesFolders.length;
					console.log("listlength!!!!!!!!!!" + listLength);
					if(listLength>0){
						listFiles = '<ul class="listOfFolderTable">';
						for(var xi = 0; xi < listLength; xi++){
							listFiles+='<li class="listOfFilesFolderSelected" id="'+listOfFilesFolders[xi]["id"]+'">'+listOfFilesFolders[xi]["path"]+'/'+listOfFilesFolders[xi]["name"]+'</li>';
						}
						listFiles+='</ul>';
					}else{
						$(".create-chkbox").prop("disabled", false);
						$('event-note').show();
						listFiles = '<ul class="listOfFolderTable">';
						listFiles+='<li class="listOfFilesFolderSelected" id="no-results">No results found</li>';
						listFiles+='</ul>';
					}
					$("#search_query_box").html(listFiles);
					$("#select_resource").show();
					$("#select_resource").scrollTop(0);
				}
			}, 500);
		};
		var searchfiles = function(){
			folderFileResponse = "";
			var jsonString = JSON.stringify(file_folder_search);
			$.ajax({url: configuration_settings_url,
				async:true,
				headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
				type: "POST",
				data: jsonString,
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					file_folder_list = result;
					folderFileResponse = result;
					file_folder_search_flag = true;
					file_folder_search = {};
					console.log("-- > "+JSON.stringify(file_folder_list));
					$('.search-items-loading').hide();
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$('.search-items-loading').hide();
						alert("We've experienced some difficulty. Try again. get app token");
					}
				}
			});
		};
		$("#sharepoint #rooms").on('change',function(){
			if($('#rooms').val()!=0&&formAction=="update")
				$(".edit-roomconfig-info").hide();
		});

		$("#siteurls").change(function () {
			selected_lib_id_undefine = "";
			selected_lib_id_update = "";
			selected_lib_id= 0;
			resize();
			$(".searchfunction").hide();
			$("#select_resource").hide();
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			$("#create").prop('disabled',false);
			$('#event-note').show();
			$('#resources').find("optgroup option").remove();
			$('#subfolders').find("optgroup option").remove();
			$('#libraries').find("optgroup option").remove();
			sitechangeflag = true;
			console.log("in site url selection!!!");
			if($("#siteurls").val()==null || $("#siteurls").val() == '0') {
				$("#WebUrl").prop('disabled', false);
				$(".foldersfilesSelection").hide();
				$(".librarySelection").hide();
				$('.subfolderSelection').hide();
				console.log("siteurl is zero : if block");
			}else if($("#siteurls").val()!=null && $("#siteurls").val() != '0'){
				console.log("siteurl is not null : elseIf block");
				$("#WebUrl").prop('disabled', true);
				$("#WebUrl").val('');
				$(".librarySelection").show();
				$(".edit-siteconfig-info").hide();
				$(".edit-subfolderconfig-info").hide();
				$('.edit-searched-source-info').hide();
				$(".edit-itemconfig-info").hide();
				$(".edit-libconfig-info").hide();
				$(".edit-roomconfig-info").hide();
				siteURL = $("#siteurls").val();
				console.log("siteURL ::::"+siteURL);
				var jsonObject={};
				jsonObject["integrationId"] = integration_id;
				jsonObject["userId"] = user_id;
				jsonObject["siteUrl"] = $("#siteurls").val();
				jsonObject["dropDownValue"] = true;
				jsonString=JSON.stringify(jsonObject);
				getLibrariesList(jsonString);
				resize();
			}
			
				
		});
		$('#WebUrl').keyup(function(e){
			if(e.keyCode == 8 || e.keyCode == 46){
				if(formAction=="update")webURL=selected_web_url;
				if(webURL==$(this).val()){urlValid=true;}else{urlValid = false;}
			}
		});
		$('#libraries').change(function () {
			resize();
			urlValid =true;
			console.log("libraries on change");
			$(".searchfunction").hide();
			selected_source_id = 0;
			$("#select_resource").hide();
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			$('#resources').find("optgroup option").remove();
			$('#subfolders').find("optgroup option").remove();
			resize();
			if($("#libraries").val()==null || $("#libraries").val() == '0') {
				resize();
				console.log("value empty!!!!!!!!!!");
				$("#WebUrl").prop('disabled', false);
				$(".foldersfilesSelection").hide();
				
				$('.subfolderSelection').hide();
			}
			else if($("#libraries").val()!=null && $("#libraries").val() != '0'){
				$(".foldersfilesSelection").show();
				$(".edit-siteconfig-info").hide();
				$(".edit-libconfig-info").hide();
				
				$(".edit-subfolderconfig-info").hide();
				$('.edit-searched-source-info').hide();
				$(".edit-itemconfig-info").hide();
				$(".edit-roomconfig-info").hide();
				var jsonObject={};
				jsonObject["integrationId"] = integration_id;
				jsonObject["userId"] = user_id;
				var urls=$("#siteurls").val();
				console.log("624624____________"+urls);
				if(urls == undefined || urls == "" || urls == 0){
					console.log("626______ if block");
					jsonObject["siteUrl"] = $("#WebUrl").val();
				}else{
					console.log("629______ else block");
					jsonObject["siteUrl"] = $("#siteurls").val();
				}
				jsonObject["libId"] = $("#libraries").val();
				jsonString=JSON.stringify(jsonObject);
				resize();
				getFolderList(jsonString);
			}
			resize();
		});
		
		$('#show-folders-btn').on('click',function(e){
			selected_lib_id_undefine = "";
			selected_lib_id_update = "";
			console.log("Show libraries function is clicked");
			selected_lib_id= 0;
			selected_source_id= $("#WebUrl").val();
			e.preventDefault();
			$('.foldersfilesSelection').hide();
			$('.edit-libconfig-info').hide();
			console.log("selected_lib_id_undefine"+selected_lib_id_undefine);
			console.log("selected_lib_id_update"+selected_lib_id_update);
			if($('#siteurls').val() == 0){
				$('.foldersfilesSelection').hide();
				$('.searchfunction').hide();
				if($("#WebUrl").val()!=null && $("#WebUrl").val() != '0'){
					webURL = $("#WebUrl").val();
					urlValid = true;
					if(webURL.includes("https://") && webURL.includes("sharepoint.com/")){
						var jsonObject={};
						jsonObject["integrationId"] = integration_id;
						jsonObject["userId"] = user_id;
						jsonObject["siteUrl"] = $("#WebUrl").val();
						jsonObject["dropDownValue"]=true;
						jsonString=JSON.stringify(jsonObject);
						validateSubdomain();
						if(webURL.includes(domainUrl) && domainUrl!="")
							getLibrariesList(jsonString);
						else alert("Please enter valid URL.");
					}else{
						urlValid = false;
						alert("Please Enter Valid URL.");
					}
					resize();
				}
			}
		});
		$('#WebUrl').keypress(function(e) {
			if(e.which == 13) {
				console.log("in site url selection!!!");
				$(".foldersfilesSelection").hide();
				$(".librarySelection").hide();
				$('searchfunction').hide();
				
				console.log("weburl keypress ------- "+$("#WebUrl").val());
				if($("#WebUrl").val()!=null && $("#WebUrl").val() != '0'){
				    webURL = $("#WebUrl").val();
					urlValid = true;
					if(webURL.includes("https://") && webURL.includes("sharepoint.com/")){
						var jsonObject={};
						jsonObject["integrationId"] = integration_id;
						jsonObject["userId"] = user_id;
						jsonObject["siteUrl"] = $("#WebUrl").val();
						jsonString=JSON.stringify(jsonObject);
						validateSubdomain();
						if(webURL.includes(domainUrl) && domainUrl!="")
							getLibrariesList(jsonString);
						else alert("Please enter valid URL.");
					}else{
						urlValid = false;
						alert("Please Enter Valid URL.");
					}
				}
				resize();
			}
		});
		$("#resources").change(function () {
			var label=$('#resources :selected').parent().attr('label');
			if(label=="Root Files"){
				$("#event-note").hide();
				$("#create").prop("disabled",true);
			}else if ($("#resources").val() == "rootfiles"){
				$("#event-note").hide();
				$("#create").prop("disabled",false);
			}else{
				$("#event-note").show();
				$("#create").prop("disabled",false);
			}
			console.log("718 Resource On change::::"+$("#resources").val());
			if($("#resources").val()==null || $("#resources").val() == '0'  || $("#resources").val()== "all" || $("#resources").val()== "rootfiles" || $("#resources").val()== "rootfolders") {
				$("#subfolderSelection").hide();
			}else{
				$(".subfolderSelection").show();
				$(".edit-siteconfig-info").hide();
				$(".edit-libconfig-info").hide();
				
				$(".edit-subfolderconfig-info").hide();
				$('.edit-searched-source-info').hide();
				$(".edit-itemconfig-info").hide();
				$(".edit-roomconfig-info").hide();
			}
			console.log("selected label : "+label);
			$('#subfolders').find("optgroup option").remove();
			$(".searchfunction").hide();
			$("#select_resource").hide();
			$("#search_query_box").html("");
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
			resize();
			var itemData = itemslist; 
			$.each(itemData, function(id,obj){	
				if(obj.hasOwnProperty("file")){
					isResourceFolder = false;
					$('.subfolderSelection').hide();
					$('#subfolders')[0].options.length = 1;
				}else{
					if($("#resources").val()==obj.id && $("#resources").val() != '0'){
						isResourceFolder = true;
						resize();
						console.log("resources!!!!" + $("#resources").val());
						$(".edit-subfolderconfig-info").hide();
						$('.edit-searched-source-info').hide();
						$(".edit-itemconfig-info").hide();
						var jsonObject={};
						jsonObject["integrationId"] = integration_id;
						jsonObject["userId"] = user_id;
						jsonObject["itemId"] = $("#resources").val();
						jsonObject["libId"] = $("#libraries").val();
						if(formAction=="update"&&dropDownValue && $('#siteurls').val()!=0){
						console.log("$(#siteurls).val()----<"+$("#siteurls").val());
							jsonObject["siteUrl"] = $("#siteurls").val();
						}else if(formAction=="update"&&!dropDownValue && $("#WebUrl").val()!=""){
							jsonObject["siteUrl"] = $("#WebUrl").val();
						}else if($("#siteurls").val()!=null && $("#siteurls").val() != '0'){
							jsonObject["siteUrl"] = $("#siteurls").val();
							console.log("$(#siteurls).val()!=null----<"+$("#siteurls").val());
						}else if($("#WebUrl").val()!=null && $("#WebUrl").val() != '0'){
							jsonObject["siteUrl"] = $("#WebUrl").val();
							console.log("weburl !=null----<"+$("#siteurls").val());
						}
						jsonString=JSON.stringify(jsonObject);
						if($('#resources').val() != 0 && $('#resources').val() !="all" && $('#resources').val() !="rootfolders" && $('#resources').val() !="rootfiles"){
							console.log("calling nested folders call :payload: "+jsonString)
							getNestedFolderList(jsonString);
						}
						return false;
					}
				}
			});
			resize();
		});
		$("#subfolders").change(function () {
			$('.edit-subfolderconfig-info').hide();
			$('.edit-searched-source-info').hide();
			resize();
		});
		$(document).on("click", ".same-config-yes" , function(e) {
			console.log("yes clicked!!!!!!!!!!!!!");
			saveSharepointInstanceConfig();
		});
		$(document).on("click", ".same-config-no" , function(e) {
			console.log("no clicked!!!!!!!!!!!!!");
			$('#same-configuration').foundation('close');
		});
		$(document).on("click", "#sharepoint #instance-list-block .edit-config" , function() {
			formAction="update";
			saveflag = false;
			$('#select2-rooms-container').html('Please select a space');
			source_modified=false;
			sub_source_modified=false;
			room_modified=false;
			urlValid = false;
			$('#resources').find("optgroup option").remove();
			$('#siteurls').find("optgroup option").remove();
			$('#libraries').find("optgroup option").remove();
			$('#subfolders').find("optgroup option").remove();
			$("#submit-button").text("Save");
			$('.librarySelection').hide();
			$('.foldersfilesSelection').hide();
			
			$('.subfolderSelection').hide();
			$('.edit-searched-source-info').hide();
			$("#event-note").show();
			$('#create').prop("disabled",false);
			instanceId=this.id;
			$.each(listResultData,function(index,value){
				if(value["instanceId"]==instanceId) {
					instanceData=value;
				}
			});
			console.log("listResultData"+JSON.stringify(listResultData));
			selected_room_id=instanceData.channelId;
			room_id_old = instanceData.channelId;
			var config=JSON.parse(instanceData.configJson);
			console.log("lib id selected"+config.libId);
			//selected_lib_id=config.libId;
			selected_lib_id_old=config.libId;
			if(config.libId!=undefined&&config.libId!=null){
				console.log("selected_lib_id.............=======:"+selected_lib_id);
				selected_lib_id=config.libId;
				selected_lib_id_old=config.libId;
				selected_lib_id_update = "sharepoint";
			}else if(config.libId==undefined&&config.libId==null){
				
				console.log("selected_lib_id.............=======:"+selected_lib_id);
				selected_lib_id_undefine="sharepoint";
				$(".edit-libconfig-info").hide();
			}else{
				selected_lib_id = 0;
			}
			if(config.dropDownValue){
				dropDownValue = true;
				selected_site_url =	config.siteUrl;
				console.log("dropDownValue = true;....."+config.siteUrl);
			}else{
				dropDownValue = false;
				console.log("dropDownValue = false;....."+config.siteUrl);
				selectedWebUrl = config.siteUrl;
				selected_web_url = config.siteUrl;
			} 
			
			site_url_modified = config.siteUrl;
			libId_modified = config.libId;
			console.log("libId_modified :"+libId_modified);
			selected_source_id=config.item_id;
			console.log("selected_source_id   "+selected_source_id);
			search_input_instance_value = config.search_path;
			searchFileNameEdit = config.search_path;
			search_input_insatance_id = config.search_id;
			selected_subfolder_id=config.sub_item_id;
			sub_source_id_old = config.sub_item_id;
			console.log("Edit selected_subfolder_id..." + selected_subfolder_id);
			var jsonObject2={};
			jsonObject2["integrationId"] = integration_id;
			jsonObject2["userId"] = user_id;
			jsonObject2["itemId"] = config.item_id;
			jsonString=JSON.stringify(jsonObject2);
			loadSharepointOnlineForm();
			$('#displayName').val(config.displayName);
			source_id_old = config.item_id;
			instanceUuid = instanceData.instanceUuid;
			var events = config.notifications;			
			if($.isArray(events)) {
				$.each(events,function(index,value){
					$("input[type=checkbox][value="+value+"]").prop("checked",true);
				});
			} else {
				$("input[type=checkbox][value="+events+"]").prop("checked",true);
			}
			resize();
		});	
	});
	function validateSubdomain(){
		$.ajax({url: get_app_token_url,
			async:false,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.subDomain) {
					domainUrl = result.tokenResult.subDomain;
				} else {
					domainUrl = "";
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again. get app token");
				}
			}
		});
	}
	function selectSearchItems(currentData){
		console.log("Selected ::: "+$(currentData).html())
		var fileFlag = false;
		var folderFlag = false;
		if($(currentData).html() != "No results found"){
			$("#search_query_input").val($(currentData).html());
			$("#search_query_input_id").val($(currentData).attr("id"));
		}else{
			$("#search_query_input").val("");
			$("#search_query_input_id").val("");
		}
		$(".edit-itemconfig-info").hide();
		$("#select_resource").hide();
		var responseData = folderFileResponse["postSpecificIntegrationSettings"];
		$.each(responseData, function(id,obj){
			if(obj.hasOwnProperty("folder") && !fileFlag){
				if($("#search_query_input_id").val()==obj.id && !folderFlag){
					console.log("folder selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
					folderFlag = true;
					$("#create").prop("disabled", false);
					$('#event-note').show();
				}
			}else if(!folderFlag){
				if($("#search_query_input_id").val()==obj.id && !fileFlag){
					console.log("file    selectec id!!!" + $("#search_query_input_id").val() + " " + "responseData id " + obj.id) ;
					fileFlag = true;
					$('#create').prop('checked', false);
					$("#create").prop("disabled", true);
					$('#event-note').hide();
				}
			}
		});
	}
	function validateIntegrationAppToken() {
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					console.log("in validateIntegrationAppToken token exists.");
					validateIntegrationAppspecificToken();
				} else {
					console.log("in validateIntegrationAppToken token not exists.");
					setIntegrationAppAuthDetails(integration_id);
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again. get app token");
				}
			}
		});
	}
	function validateIntegrationAppspecificToken(){
		console.log("in validateIntegrationAppspecificToken");
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false ){
						isClientAppTokenValid = false;
						console.log("in validateIntegrationAppspecificToken app token not exist.");
						$('#integrations-block').show();
						if(listResultData.length==0){
							setIntegrationAppAuthDetails(integration_id);
						}else{
							$('.client-app-warning').html(clientAppRevokeMsg);
							$('.client-app-warning').show();
						}
					}else{
						console.log("in validateIntegrationAppspecificToken app token exist.");
						loadSharepointOnlineForm();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateIntegrationSpecificAppToken(app_code){
		console.log("in validateIntegrationSpecificAppToken");
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					if(result["integrationSpecificSettings"]["isValidToken"]==false && result["integrationSpecificSettings"]["isValidToken"] != undefined){
						isClientAppTokenValid = false;						
						if(app_code!="")
						getIntegrationAppTokenDetails(app_code);
						else setIntegrationAppAuthDetails(integration_id);						
					}else{
						isClientAppTokenValid = true;
						listIntegrations();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		
	}
	function getListInstances(){
		console.log("in getListInstances.");
		$.ajax({url: list_integration_instances_url+"?integrationId="+integration_id,
			async:true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
			 instanceList = result;
			 if(instanceList.length != 0 && instanceList.message == undefined){
				 console.log("instanceList in getListInstances()"+instanceList.length);
				 listIntegrations();
			 }else{
				 loadSharepointOnlineForm();
			 }
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }
			}
		});
	}
	function setIntegrationAppAuthDetails() {
		var OAUTHURL    =   '';
		var CLIENTID    =   '';
		var TYPE        =   'code';
		var REDIRECT_URI = "https://183.82.99.100:8443/CiscoWebcontent/spark1.html";
		$.ajax({url: application_auth_details_url,
			async:true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				CLIENTID=result.clientId;
				console.log("CLIENTID.." + CLIENTID);
				OAUTHURL= result.authorizationEndpoint;		
				console.log("authorizationEndpoint.." + OAUTHURL);				
				OAUTHURL=OAUTHURL+'?client_id='+CLIENTID+'&response_type='+TYPE+'&redirect_uri='+REDIRECT_URI;
				loginWithAuthDetails(OAUTHURL);	
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});		
	}
	function loginWithAuthDetails(oauthURL) {
		isRedirect=true;
		if(isRedirect) {
			if(formAction=="add") {
				window.top.location.href = oauthURL;
			} else {
				var authReqMsg ="";
				authReqMsg+='<hr class="instance-hr"><div class="large-12 medium-12 columns instance-background">';
				authReqMsg+='<div class="no-config-msg">You are not authorized to this integration. Click Add to continue.</div></div>';
				$('#integrations-block').show();
				$("#instance-list-block").html(authReqMsg);
			}			
		} else {
			var win = window.open(oauthURL, "windowname1", 'width=600, height=600'); 
				if(win){ 
			}else{
				alert(popblockedMessage); 
				return false;
			}
			var pollTimer = window.setInterval(function() { 
				try {
					if (win.document.URL.indexOf("code") != -1) {
						window.clearInterval(pollTimer);
						var url =   win.document.URL;
						accessCode =   gup(url, 'code');
						tokenType = gup(url, 'token_type');
						expiresIn = gup(url, 'expires_in');
						win.close();
						getIntegrationAppTokenDetails(accessCode);
					}
				} catch(e) {
					console.log('error while getting authorization code..'+e);
				}
			}, 100);
		}
    }
	function getIntegrationAppTokenDetails(code) {
		console.log("in getIntegrationAppTokenDetails");
		var jsonObject={};
		jsonObject["integrationId"] = integration_id;
		jsonObject["authSettings"] = {};
		jsonObject["authSettings"]["code"] = code;
		jsonString=JSON.stringify(jsonObject)
		$.ajax({url: token_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: "POST",
			data: jsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				var tokenDetails=result["integrationSpecificAuthDetails"];
				var jsonObject1={};
				jsonObject1["applicationId"] = application_id;
				jsonObject1["integrationId"] = integration_id;
				jsonObject1["accessToken"] = tokenDetails.accessToken
				jsonObject1["refreshToken"] = tokenDetails.refreshToken;
				jsonObject1["refreshExpires"] = tokenDetails.expires;
				jsonObject1["subDomain"] = tokenDetails.subDomain;
				var jsonString=JSON.stringify(jsonObject1);				
				saveIntegrationAppToken(jsonString);
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function saveIntegrationAppToken(jsonData){
		$.ajax({url: save_app_token_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: "POST",
			data: jsonData,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}	
				connectIntegration();		
				console.log("in saveIntegrationAppToken isClientAppTokenValid "+isClientAppTokenValid);
				if(isClientAppTokenValid == false) {
					isClientAppTokenValid=true;
					getListInstances();
				}else loadSharepointOnlineForm();
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});	
	}
	function getLibrariesList(jsonString){
		resize();
		console.log("in getLibrariesList!!! .... Get libraries list");
		//$('#siteurls')[0].options.length = 1;
		$('#libraries')[0].options.length = 1;
		var librariesMatchFlag = false;
		var librariesCount = 0;
		$(".settings-loading").show();
		$(".edit-libconfig-info").hide();
		$('.subfolderSelection').hide();
		$(".librarySelection").show();
		
		$.ajax({url: configuration_settings_url,
				async:true,
				headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
				type: "POST",
				data: jsonString,
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
						console.log("boolean value of url :::::"+result["postSpecificIntegrationSettings"]["url"]);
						if(result["postSpecificIntegrationSettings"]["url"] == false){
							$('.librarySelection').hide();
							alert("Please Enter Valid URL");
						}else{
							librarylist = result["postSpecificIntegrationSettings"];  
							libraries_initial_val = result["postSpecificIntegrationSettings"][0]["id"];  
							console.log("libraries_initial_val  ::"+libraries_initial_val);
							console.log(JSON.stringify(result));
							console.log("load all libraries to itemsLists"+librarylist);
							$(".settings-loading").hide();
					//	var foldersCount = 0,filesCount = 0;
						
							if(librarylist.length != 0){
							
									console.log("itemslist.length!!!!<0" + librarylist.length);
									$.each(librarylist, function(id,obj){	
										$("#libraries").append($('<option>').text(obj.libraryName).attr('value',obj.id));
										//$("#libraries").append($('<option>').text(obj.libraryName));
										console.log("selected_lib_id :"+selected_lib_id);
										if(formAction=="update" && selected_lib_id==obj.id &&  librariesMatchFlag==false){
										console.log("formaction update!!!" + "selected_lib_id" + selected_lib_id);
										selected_lib_id=obj.id;
										librariesMatchFlag=true;
										}
									});
									resize();
								}
							
							if(formAction=="update" && librariesMatchFlag==false  ){
									console.log("selected_lib_id "+selected_lib_id+"librariesMatchFlag "+librariesMatchFlag);
									console.log("selected_source_id"+selected_source_id);
									if(selected_source_id !=0){
										$(".edit-libconfig-info").hide();
										console.log("libraries_initial_val........."+libraries_initial_val);
									}else{
										console.log("soma 1");
								
										$(".edit-libconfig-info").show();
									}
									selected_lib_id = "0";
									console.log("selected_lib_id here 0   ::"+selected_lib_id);
									resize();
							}
							if( formAction == "update" && selected_lib_id_undefine == "sharepoint"  && librariesMatchFlag==false){
								
								$('#libraries').val(libraries_initial_val);
								$(".edit-libconfig-info").hide();
								librariesMatchFlag=true;
							}else{
								$('#libraries').val(selected_lib_id);
								resize();
							}
							if(formAction=="update" && selected_lib_id_undefine == "sharepoint" || selected_lib_id_update == "sharepoint"){
								console.log("gggggggggggggggggggg")
								var jsonObject1={};
								jsonObject1["integrationId"] = integration_id;
								jsonObject1["userId"] = user_id;
								if(formAction=="update"&&librariesMatchFlag){
									jsonObject1["siteUrl"] = site_url_modified;
								}
								jsonObject1["libId"] = $("#libraries").val();
								if(dropDownValue && $('#siteurls').val()!=0){
								console.log("site url !!!" + $("#siteurls").val() + "edit siteurl " + selected_site_url);
								jsonObject1["siteUrl"] = $("#siteurls").val();
								}else if(dropDownValue==false && $('#siteurls').val()!=0) {
								jsonObject1["siteUrl"] = $("#siteurls").val();
								}else if(dropDownValue && $("#WebUrl").val() !=0 && $("#WebUrl").val()!=""){
								jsonObject1["siteUrl"] = $("#WebUrl").val();
								}else{
								console.log("WebUrl url !!!" + $("#WebUrl").val() + "edit WebUrl " + selectedWebUrl);
								jsonObject1["siteUrl"] = $("#WebUrl").val();
								}
								jsonString=JSON.stringify(jsonObject1);
								getFolderList(jsonString);
								resize();
							}
					}	
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$(".librarySelection").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
		resize();
	}
	function getFolderList(jsonString){
		console.log("in getFolderList!!! .... Get Folders list");
		var itemFlag=false;	
		var folderMatchFlag = false;
		var fileMatchFlag = false;
		var foldersCount = 0,filesCount = 0;
		$(".items-loading").show();
		$(".edit-itemconfig-info").hide();
		$('.subfolderSelection').hide();
		resize();
		$.ajax({url: configuration_settings_url,
				async:true,
				headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
				type: "POST",
				data: jsonString,
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					console.log("success..getFolderList!!!");
					console.log("postSpecificResult after changes:"+result["postSpecificIntegrationSettings"]["value"]);
					if(result["postSpecificIntegrationSettings"]["value"]!= undefined){
						console.log("if block jjjjjjjjjjjjj");
						 itemslist = result["postSpecificIntegrationSettings"]["value"]; 
						 console.log("load all folderlists to itemsLists" +itemslist);
						 $(".items-loading").hide();
						 $('#resources')[0].options.length = 4;
					//	var foldersCount = 0,filesCount = 0;
						if(itemslist.length != 0){
							console.log("itemslist.length!!!!<0" + itemslist.length);
							$.each(itemslist, function(id,obj){	
								if(obj.hasOwnProperty("file")){
									filesCount++;
									$("#files").append($('<option>').text(obj.name).attr('value',obj.id));
									console.log("file appended!!!!!!!!!!");
								}else{
									foldersCount++;
									$("#folders").append($('<option>').text(obj.name).attr('value',obj.id));
								}
								if(formAction=="update" && selected_source_id==obj.id &&  folderMatchFlag==false){
									console.log("formaction update!!!" + "selected_source_id" + selected_source_id);
									selected_source_id=obj.id;
									folderMatchFlag=true;
									if(obj.hasOwnProperty("file")){
										fileMatchFlag = true;
									}else fileMatchFlag = false;
								}
								
							});
							if(formAction=="update" && !folderMatchFlag && !urlValid){
							console.log("folderMatchFlag!!!!!!!!!" + folderMatchFlag + "!!!!selected_source_id   urlValidurlValidurlValid!!!!"+urlValid +" "  + selected_source_id);
								if(selected_source_id!="all"&&selected_source_id!="rootfolders"&&selected_source_id!="rootfiles" && !sitechangeflag){
									console.log("folderMatchFlag::::::::::::::::::::::::::::: "+urlValid);
									selected_source_id = "0";
									$(".edit-itemconfig-info").show();
								}
							}
							
							
							sitechangeflag = false;
							console.log("files count!!!!!!!!!!!!!!!!!!!!!!!!!!!!!" + filesCount);
							if(foldersCount == 0){$("#folders").hide();}
							else{$("#folders").show();}
							if(filesCount == 0){$("#files").hide();	}else{$("#files").show();}	
							if($("#siteurls").val()!=0 || $('#WebUrl').val()!="")						
							$('.foldersfilesSelection').show();
							console.log("after shown!!!!!!!!!!!!!!");
							resize();	
						}else{
							if(formAction=="update" && selected_source_id!="0"){
								if(selected_source_id!="all"&&selected_source_id!="rootfolders"&&selected_source_id!="rootfiles"){
									$(".edit-itemconfig-info").show();
									$('#edit-subfolderconfig-info').hide();
									$('#edit-searched-source-info').hide();
								}else if(selected_source_id=="all" || selected_source_id=="rootfolders" || selected_source_id=="rootfiles"){
									$(".edit-itemconfig-info").hide();
								}
								selected_source_id = "0"
								console.log("ghjkkkkkkkkkkkkkkkkkk");
								$('.foldersfilesSelection').show();
								resize();
							}else{
								$('.foldersfilesSelection').show();
								$(".edit-itemconfig-info").hide();
								alert("Selected libraries doesn't have subitems.");
							}
							if(foldersCount == 0){$("#folders").hide();}
							else{$("#folders").show();}
							if(filesCount == 0){$("#files").hide();	}else{$("#files").show();}	
							
						} 
						$("#resources").val(selected_source_id);
						console.log("selected_source_id!!!"+ selected_source_id);
						var jsonObject1={};
						jsonObject1["integrationId"] = integration_id;
						jsonObject1["userId"] = user_id;
						jsonObject1["itemId"] = selected_source_id;
						if(formAction=="update"&&folderMatchFlag){
						jsonObject1["siteUrl"] = site_url_modified;
						}
						jsonObject1["libId"] = $("#libraries").val();
						
						if(dropDownValue && $('#siteurls').val()!=0){
							console.log("site url !!!" + $("#siteurls").val() + "edit siteurl " + selected_site_url);
							jsonObject1["siteUrl"] = $("#siteurls").val();
						}else if(dropDownValue==false && $('#siteurls').val()!=0) {
							jsonObject1["siteUrl"] = $("#siteurls").val();
						}else if(dropDownValue && $("#WebUrl").val() !=0 && $("#WebUrl").val()!=""){
							jsonObject1["siteUrl"] = $("#WebUrl").val();
						}else{
							console.log("WebUrl url !!!" + $("#WebUrl").val() + "edit WebUrl " + selectedWebUrl);
							jsonObject1["siteUrl"] = $("#WebUrl").val();
						}
						jsonString2=JSON.stringify(jsonObject1);
						console.log("jsonString2 "+jsonString2);
						console.log("getFolderList folderMatchFlag!!!!!!" + folderMatchFlag);
						if(formAction=="update"&&folderMatchFlag){
							console.log("jsonString2!!!!" + jsonString2);
							if(!fileMatchFlag)
							getNestedFolderList(jsonString2);
							else{
								$('#event-note').hide();
								$("#create").attr("disabled","true");
							}
						}
						selected_source_id="0";
						resize();
					}else if(result["postSpecificIntegrationSettings"].url!=undefined&&result["postSpecificIntegrationSettings"].url==false){
						urlValid= false;
						itemslist = "";
						$('.foldersfilesSelection').hide();
						alert("Please Enter Valid URL.");
						return false;
					}else{
						console.log("else block");
						$("#integration-form").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						console.log("error function");
						$(".foldersfilesSelection").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			resize();
	}
	function getNestedFolderList(jsonStringData){
		var itemFlag=false;	
		var foldersCount = 0;
		var filesCount = 0;
		var isFolder = false;
		resize();
		$(".subitems-loading").show();
		$(".edit-subfolderconfig-info").hide();
		$('.edit-searched-source-info').hide();
		$.ajax({url: configuration_settings_url,
				async:true,
				headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
				type: "POST",
				data: jsonStringData,
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					console.log("success..");
					if(result["postSpecificIntegrationSettings"]["subItems"]!= undefined && result["postSpecificIntegrationSettings"]["subItems"]["value"]!= undefined){
						subfolders = result["postSpecificIntegrationSettings"]["subItems"]["value"]; 
						$(".subitems-loading").hide();
						$('#subfolders')[0].options.length = 1;	
						if(subfolders.length != 0){
							$.each(subfolders, function(id,obj){
								if(obj.folder){
									foldersCount++;
								    $("#SharePoint-places-folders").append($('<option>').text(obj.name).attr('value',obj.id));
									$("#SharePoint-places-folders").show();
							    }
								if(obj.file){
									filesCount++;
									$("#SharePoint-places-files").append($('<option>').text(obj.name).attr('value',obj.id));
									$("#SharePoint-places-files").show();
								}	
								if(formAction=="update" && selected_subfolder_id==obj.id && itemFlag==false){
									console.log("each selected_subfolder_id..." + selected_subfolder_id);		
									selected_subfolder_id=obj.id;
									itemFlag=true;
									if(obj.hasOwnProperty("folder")) {
										isFolder = true;
										$('#event-note').show();
										$('#create').prop("disabled",false);
										
									}else{
										console.log("not a folder");
										isFolder = false;
										$('#event-note').hide();
										$('#create').prop("checked",false);
										$('#create').prop("disabled",true);
									} 
									
								}
								/*if(obj.file && $('#subfolders').val()==obj.id){
									$('#event-note').hide();
								}*/
							});
							if(filesCount ==0) $("#SharePoint-places-files").hide();
							if(foldersCount ==0) $("#SharePoint-places-folders").hide();
							if(isResourceFolder )
							$('.subfolderSelection').show();
							resize();
						}else{
							selected_subfolder_id = "0";
							$('.subfolderSelection').hide();
							$(".edit-subfolderconfig-info").hide();
							$('.edit-searched-source-info').hide();
							if(formAction == "update" && result["postSpecificIntegrationSettings"]["subItems"]["value"] !=""){
								console.log("Form action is updated");
							}else{
								alert("Selected folder doesn't have subitems.");
							}
						}
						if(formAction=="update" && selected_subfolder_id!=0 && itemFlag==false){
							selected_subfolder_id = "0";
							$(".edit-subfolderconfig-info").show();
							$('#edit-searched-source-info').hide();
						}
						console.log("Before setting value :: "+selected_subfolder_id);
						$("#subfolders").val(selected_subfolder_id);
						
						if(!isFolder){
							$(".searchfunction").hide();
						}else{
							$(".searchfunction").show();
							resize();
						}
						if(formAction=="update" && search_input_insatance_id!=undefined && search_input_insatance_id!="" ){
							searchResourceValidate(); 
						}
						$("#search_query_input_id").val(search_input_insatance_id);
						search_input_instance_value = "";
						search_input_insatance_id = "";
						selected_subfolder_id="0";
						console.log("After setting value :: "+selected_subfolder_id);
					}else{
						//$("#integration-form").hide();
						alert("We've experienced some difficulty. Try again.");
					}
					resize();
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$(".subfolderSelection").hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			resize();
	}
	function generateIntegrationAppToken(app_code) {
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					validateIntegrationSpecificAppToken(app_code);
				} else {
					getIntegrationAppTokenDetails(app_code); 
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function getAuthUser(){
		if(ui_settings["integrationSpecificSettings"]!= undefined){
			if(ui_settings["integrationSpecificSettings"]["settings"] != undefined)
			authenticated_user=ui_settings["integrationSpecificSettings"]["settings"].userName;
		}
	}
	function loadSharepointOnlineForm(){
		$(".searchfunction").hide();	
		$("#form").trigger("reset");
		$('#integrations-block').hide();
		$("#integration-form").show();
		$(".edit-roomconfig-info").hide();
		$(".edit-itemconfig-info").hide();
		$(".edit-libconfig-info").hide();
		$(".rooms-loading").show();
		$("#WebUrl").val('');
		$("#WebUrl").prop('disabled', false);
		resize();
		console.log("loadSharepointOnlineForm!!!!!!!!!");
		$(".sitenames-loading").show();
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id },
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				$(".sitenames-loading").hide();
				ui_settings=result;	
				loadConfigurationSettings();
				loadRooms();
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					$('#integration-form').html("We've experienced some difficulty. Try again.");
					$('#integration-form').hide();
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		getAllSparkRooms();
		resize();
	}
	function loadConfigurationSettings() {
		console.log("in loadConfigurationSettings!!!");
		var selectedSiteUrlFlag=false;
		if(ui_settings["sparkRoomSettings"] && ui_settings["integrationSpecificSettings"]["settings"]!= undefined) {
			var itemFlag=false;
			var roomFlag=false;
			var rooms = "";
			
			resize();
			$('#siteurls')[0].options.length = 1;
			var authorizedto=ui_settings["integrationSpecificSettings"]["settings"].userName;
			var sitename = ui_settings["integrationSpecificSettings"]["settings"]["userDetails"].value;
			
			if(authorizedto!=""&& authorizedto!=undefined) {
				$('#authenticted-to').html(authorizedto);
				$(".authenticted-block").css("display","block");
			}
			if(sitename!=""&& sitename!=undefined) {
				$('#sharepoint-sitename').html(sitename);
				$(".sitename-block").css("display","block");
				$("#siteurls").append($('<option>').text(sitename).attr('value','/'));
			}
			var sitelist = ui_settings["integrationSpecificSettings"]["settings"]["siteList"]["value"]; 

			$('#rooms')[0].options.length = 1;
			rooms = ui_settings["sparkRoomSettings"].items;
			if(allRooms.length !=0) {
				rooms = allRooms;
				//$(".rooms-loading").hide();
			}
			$.each(rooms, function(id,obj){
				obj.title=$('<div />').html(obj.title).text();
				$("#rooms").append($('<option>').text(obj.title).attr('value',obj.id));
				if(formAction=="update" && selected_room_id==obj.id&&roomFlag==false){
					selected_room_id=obj.id;
					roomFlag=true;
				}
			});	
			if(formAction=="update" && roomFlag==false){
				selected_room_id = "0";
				$(".edit-roomconfig-info").show();
			}
			if(formAction=="update" && dropDownValue && selected_site_url=='/'){
				selected_site_url =	'/'; 
				selectedSiteUrlFlag = true;
			}
			$.each(sitelist, function(id,obj){	
				console.log("in for each!!!!!!!!!!!");
				name = "";
				name = obj.name;
				$("#siteurls").append($('<option>').text(name).attr('value',obj.webUrl).prepend("&nbsp;&nbsp;&nbsp;"));
				if(formAction=="update" && selected_site_url==obj.webUrl && dropDownValue && selectedSiteUrlFlag==false){
					selected_site_url==obj.webUrl;
					selectedSiteUrlFlag=true;
				}
			});	
			if(formAction=="update" && selectedSiteUrlFlag==false && dropDownValue){
					selected_site_url = "0";
					$(".edit-siteconfig-info").show();
			}
			$("#rooms").val(selected_room_id);
			if(formAction=="update"){
				if(!dropDownValue){
					$("#WebUrl").val(selectedWebUrl);
				}else{
					console.log("dropdown false cond!!!!");
					$("#WebUrl").prop('disabled', true);
				}	
			}
			$("#siteurls").val(selected_site_url);
			$('#select2-rooms-container').html($("#rooms option:selected").text());
			var jsonObject={};
			jsonObject["integrationId"] = integration_id;
			jsonObject["userId"] = user_id;
			jsonObject["dropDownValue"] = true;
			if(dropDownValue)	jsonObject["siteUrl"] = selected_site_url;
			else jsonObject["siteUrl"] = selectedWebUrl;
				jsonString=JSON.stringify(jsonObject);
			if(formAction=="update"&&selectedSiteUrlFlag&&dropDownValue){
				getLibrariesList(jsonString);
			}else if(formAction=="update"&&!dropDownValue){
				getLibrariesList(jsonString);
			}
			$(".rooms-loading").hide();
		//	selected_room_id="0";
			selected_site_url = "0";
			resize();
		} else {
			alert("We've experienced some difficulty. Try again.");
			$('#integration-form').html("We've experienced some difficulty. Try again.");
			$('#integration-form').hide();
		}
		resize();
	}
	function validateConfiguration(instance, notifications){
	    console.log("validating Configuration.... "+JSON.stringify(instance));
		var configData = JSON.parse(instance.configJson);
		var configEvents = configData.notifications;
		var notificationsLength = notifications.length;
		var matchCount = 0;
		configFlag = false;
		eventsMatchFlag = true;
		resize();
		if($("#subfolders").val()==0 && folderFlag){
			 subfolder_id= "all";
		}else{
			subfolder_id= $("#subfolders").val();
		}
		console.log("configData.sub_item_id.." + configData.sub_item_id + " subfolder_id.."+ subfolder_id);
		var selectedUrl ="";
		if($("#siteurls").val()!=null && $("#siteurls").val() != '0'){
			console.log("siteurls is not empty ")
			selectedUrl = $("#siteurls").val();
		}else if($("#WebUrl").val()!='0' && $("#WebUrl").val() != null){
			console.log("WebUrl is not empty "+$("#WebUrl").val())
			selectedUrl = $("#WebUrl").val();
		}
		if(instance.channelId==room_id&&configData.item_id==selectedSourceId&&configData.sub_item_id==subfolder_id && configData.siteUrl==selectedUrl && configData.search_id==$("#search_query_input_id").val()){
			console.log("matched...space and folder/file and subfolder");
			configFlag = true;
		}
		if($.isArray(notifications)){
			console.log("configEvents..." + configEvents +"length...." + configEvents.length);
			if($.isArray(configEvents)){
				for (var p in notifications) {
					if(configEvents[p] != notifications[p]){
						eventsMatchFlag = false;
						console.log("Match: " + configEvents[p] + "!=" + notifications[p]);
					}else {
						matchCount = matchCount +1;
					   console.log("Match: " + configEvents[p] + "==" + notifications[p]);
					}
					console.log("match count..." + matchCount + "configEvents.length..." + configEvents.length);
					if(matchCount==configEvents.length&&notificationsLength==configEvents.length){
						eventsMatchFlag = true;
						return false;
					}else{
						eventsMatchFlag = false;
					}
				}
			}else{
			    console.log("not matched...configEvents");
				eventsMatchFlag = false;
			}
		}else{
			if($.isArray(configEvents)){
			    eventsMatchFlag = false;
				console.log("not matched...array" + eventsMatchFlag);
			}else{
			  if(configEvents==notifications){
				eventsMatchFlag = true;
				 console.log("matched single.." + eventsMatchFlag);
			  }else{
				eventsMatchFlag = false;
			  }
			}
		}
	}
	function saveSharepointOnlineInstance(){
		var res = $('form').serializeObject();
		selectedRoomName=$("#rooms option:selected").text();
		selectedSourceId=$("#resources option:selected").val();
		selectedSiteUrl=$("#siteurls option:selected").val();		
		selectedWebUrl=$("#WebUrl").val();
		selectedSubSourceId=$("#subfolders").val();
		room_id =$("#rooms option:selected").val();
		var source_name = $("#resources option:selected").text();
		var jsonData = {};
		jsonData["channelId"] = room_id;								
		jsonData["integrationId"] = integration_id;
		jsonData["status"] = "ACTIVE";
		jsonData["userId"] = user_id;
		
		
		postAddMessageToRoom(room_id,appName);
		if(formAction=="update") {
			jsonData["configJson"]={};
			jsonData["instance_id"] = instanceId;
			resize();
			if(room_id!=room_id_old) {
				room_modified=true;
				jsonData["messageToSpark"] = updateMessageToSpark;
			} else {
				room_modified=false;
			}
			if(source_id_old!=selectedSourceId) {
				source_modified=true;
			} else {
				source_modified=false;
			}	
			if(sub_source_id_old!=selectedSubSourceId) {
				sub_source_modified=true;
			} else {
				sub_source_modified=false;
			}	
			jsonData["source_modified"] = source_modified;
			jsonData["room_modified"] = room_modified;	
			jsonData["instanceUuid"] = instanceUuid;			
			jsonData["configJson"]=JSON.parse(instanceData.configJson);
			action_url=update_configuration_settings_url+instanceId;
			actionType="PUT";
			$('.loading-first-block').html('Please wait while your Integration is being updated');
		} else {
			jsonData["configJson"]={};			
			jsonData["messageToSpark"] = postMessageToSpark;
			action_url=save_configuration_settings_url;
			actionType="POST";
			$('.loading-first-block').html('Please wait while your Integration is being set up');
		}
		var emptyflag = false;
		saveflag = false;
		if($("#search_query_input").val() ==""){
			$("#search_query_input_id").val("");
			$("#search_query_input").val("");
			saveflag = true;
		}else{
		  console.log("emptyflag = false; "+emptyflag);
			emptyflag = true;
			searchvalidate();
		}
		var serachQuery_val = $("#search_query_input").val();
		var polling = setInterval(function(){ 
			if(saveflag){
				if(emptyflag){
					if(sample["postSpecificIntegrationSettings"]["subItems"]!= undefined && sample["postSpecificIntegrationSettings"]["subItems"]!=""){
						if(sample["postSpecificIntegrationSettings"]["subItems"] == serachQuery_val.substring(1,serachQuery_val.length)){
							saveeee = true;
							console.log("resource found "+saveeee);
						}else saveeee = false;
					}
				}else saveeee = true;
				clearInterval(polling);
				if($("#subfolders").val()!=0){
					last_selected_id = $("#subfolders").val();
					jsonData["configJson"]["resources"] = $("#subfolders option:selected").text();
				}else{
					last_selected_id = $("#resources").val();
					jsonData["configJson"]["resources"] = $("#resources option:selected").text();
				}
				
				if($("#search_query_input").val()!=""){
					jsonData["configJson"]["search_id"] = $("#search_query_input_id").val();
					jsonData["configJson"]["search_path"] = $("#search_query_input").val();
					last_selected_id = $("#search_query_input_id").val();
					var selectedText = $('#search_query_input').val();
					selectedText = selectedText.substring(selectedText.lastIndexOf("/")+1,selectedText.length);
					jsonData["configJson"]["resources"] = selectedText;
				}else{
					jsonData["configJson"]["search_id"] = "";
					jsonData["configJson"]["search_path"] = "";
				}
				libraries_id =$("#libraries").val();
				jsonData["configJson"]["selected_id"] = last_selected_id;
				jsonData["configJson"]["notifications"] = res.events;
				jsonData["configJson"]["item_id"] = selectedSourceId;
				jsonData["configJson"]["libId"] = libraries_id ;
				jsonData["configJson"]["old_libId"] = selected_lib_id_old;
				if(selectedSiteUrl!=0 && selectedSiteUrl!=null){
					jsonData["configJson"]["siteUrl"] = selectedSiteUrl;
					jsonData["configJson"]["dropDownValue"] = true;
				}else{
					jsonData["configJson"]["siteUrl"] = selectedWebUrl;
					jsonData["configJson"]["dropDownValue"] = false;
				}
				if(site_url_modified!=selectedSiteUrl && formAction=="update"){
					jsonData["configJson"]["site_modified"] = "true";
				}else{
					jsonData["configJson"]["site_modified"] = "false";
				}
				jsonData["configJson"]["old_site_url"]=site_url_modified;
				jsonData["configJson"]["sub_item_id"]= $("#subfolders").val();
				//jsonData["configJson"]["resources"] = $("#resources option:selected").text();
				jsonData["configJson"]["displayName"]= res.displayName;
				jsonData["messageFormat"]="SharePoint Online Bot :"+"Hello...User";
				saveJsonString = JSON.stringify(jsonData);
				var notificationslength = objLength(res.events);
				var notifications = res.events;
				if(listResultData.length != 0 && notificationslength !=0){
					$.each(listResultData, function(i, instance) {
						if(formAction=="update"&&instance.instanceId!=instanceId){
						 validateConfiguration(instance, notifications);
						 if(eventsMatchFlag==true&&configFlag==true){
							 console.log("eventsMatchFlag in update.." + eventsMatchFlag + " config Flag..in update " + configFlag);
								return false;
							}
						}
						if(formAction!="update"){
						 validateConfiguration(instance, notifications);
						  if(eventsMatchFlag==true&&configFlag==true){
							 console.log("eventsMatchFlag in cond.." + eventsMatchFlag + " config Flag.." + configFlag);
								return false;
							}
						}
					});
				} 
				console.log("selected_web_url!!!!!!!!!!!!!!!!!" + selected_web_url);
				console.log(" configFlag after validate and update " + configFlag);
				if(formAction=="update"){if($('#WebUrl').val()==selected_web_url)webURL=selected_web_url;urlValid=true;}
				console.log("urlvalid!!!" + urlValid + " !!!webURL!!!" +webURL  + "!!!current value!!!" + $('#WebUrl').val());
				if($("#WebUrl").val()=="" && $("#siteurls").val()=='0'){
					alert("Please select Team Site/subsites (OR) provide your site URL.");
				}else if($('#rooms').val()==0 || $('#rooms').val()==null){ 
					alert("Please select a space");
				}else if($('#WebUrl').val()!=0&&!urlValid || $('#WebUrl').val()!=0&&webURL!=$('#WebUrl').val()){
					alert("Please Enter Valid URL.");
				}else if($('#libraries').val()==0){ 
					alert("Please select libraries");
				}else if($('#resources').val()==0){ 
					alert("Please select Folders/Files");
				}else if(notificationslength==0){ 
					alert("Please select at least 1 notification");
				}else if(!saveeee){
					alert("Selected file/folder does not exist");
				}else if(listResultData.length != 0 && eventsMatchFlag==true && configFlag==true){
					if(formAction=="update"){
						$.each(listResultData, function(i, instance) {
							if(formAction=="update"&&instance.instanceId==instanceId){
							 validateConfiguration(instance, notifications);
							}
						});
						if(room_modified || source_modified || sub_source_modified || !eventsMatchFlag)
							$('#same-configuration').foundation('open');
						else
							saveSharepointInstanceConfig();
					}else{
						$('#same-configuration').foundation('open');
					}
				}else {
					saveSharepointInstanceConfig();
				}
			}
		}, 500);
	}
	function saveSharepointInstanceConfig(){
		$('#same-configuration').foundation('close');
		$('.loading-second-block').html('Selected Space is '+ selectedRoomName);
		$('#loading-block').foundation('open');		
		$.ajax({url: action_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: actionType,
			data: saveJsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}	
				console.log("Success...........");
				$('#success-integration').foundation('open');
				$('#loading-block').foundation('close');					
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					$('#loading-block').foundation('close');
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		$('.loading-first-block').html('Please wait just a moment while your app is loading');
		$('.loading-second-block').html('');
	}
	
	
	var searchvalidate = function(){
			$('.search-items-loading').show();
			var hostURL = "";
			if($("#WebUrl").val() != "" && $("#WebUrl").val() != '0' ){
				hostURL = $("#WebUrl").val();
			}else hostURL = $("#siteurls").val();
			var jsonobj = {};
			jsonobj["integrationId"] = integration_id;
			jsonobj["userId"] = user_id;
			jsonobj["subItemId"] = $("#search_query_input_id").val();
			jsonobj['searchPath'] = "/"+$("#resources option:selected").text()+"/"+$("#subfolders option:selected").text();
			jsonobj["siteUrl"] = hostURL;
			jsonobj["libId"] = $("#libraries").val();
			$.ajax({url: configuration_settings_url,
				async:true,
				headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
				type: "POST",
				data: JSON.stringify(jsonobj),
				contentType: "application/json",
				dataType: "json",
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					$('.search-items-loading').hide();
					sample = result;
					saveflag = true;
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						alert("We've experienced some difficulty. Try again. get app token");
					}
				}
			});
	};
	var searchResourceValidate = function(){
		console.log("search_input_insatance_id val ::: "+search_input_insatance_id);
		var searchObj = {};
		searchObj["integrationId"] = integration_id;
		searchObj["userId"] = user_id;
		searchObj["subItemId"] = search_input_insatance_id;
		searchObj["libId"] = $("#libraries").val();
		if(formAction=="update"&&dropDownValue && $('#siteurls').val()!=0){
			searchObj["siteUrl"] = $("#siteurls").val();
		}else if(formAction=="update"&&!dropDownValue && $("#WebUrl").val()!=""){
			searchObj["siteUrl"] = $("#WebUrl").val();
		}else if($("#siteurls").val()!=null && $("#siteurls").val() != '0'){
			searchObj["siteUrl"] = $("#siteurls").val();
		}else if($("#WebUrl").val()!=null && $("#WebUrl").val() != '0'){
			searchObj["siteUrl"] = $("#WebUrl").val();
		}
		$('.search-items-loading').show();
		$.ajax({url: configuration_settings_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: "POST",
			data: JSON.stringify(searchObj),
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result["postSpecificIntegrationSettings"]["subItems"]!=undefined){
					$('.search-items-loading').hide();
					if(result["postSpecificIntegrationSettings"]["subItems"] == ""){
						$("#search_query_input_id").val("");
						$('#search_query_input').val("");
						$('.edit-searched-source-info').show();
					}else{
						if(result["postSpecificIntegrationSettings"]["subItems"])
						$("#search_query_input").val("/"+result["postSpecificIntegrationSettings"]["subItems"]);
						$('.edit-searched-source-info').hide();
						if(result["postSpecificIntegrationSettings"]["folder"]==true) {
							$('#create').prop("disabled",false);
							$('#event-note').show();
						}else{
						console.log("****************");
							$('#create').prop("checked",false);							
							$('#create').prop("disabled",true);
							$('#event-note').hide();
						} 
					}
				}else{
					alert("We've experienced some difficulty. Try again...");
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again...");
				}
			}
		});
	};
</script>
</head>
<body>	
	<div class="integration-app" id="sharepoint">
		<div class="rows large-12 medium-12 columns warning-msg" style="display:none;"></div>
		<div class="rows large-12 medium-12 columns client-app-warning" style="display:none;"></div>
		<div id="loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait just a moment while your app is loading</div>
				<div class="loading-second-block">name and space name</div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="list-loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait...</div>
				<div class="loading-second-block"></div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="success-integration" class="reveal success-integration" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="success-loading">
				<img class="spark-icon" src="" alt=".....">
			</div>
			<div class="well-done-text">Well done!</div>
			<div class="success-integration-first-block">Your configuration has been set up and is ready to use.</div>
			<div class="success-integration-note-block"></div>
			<div class="large-5 medium-5 columns buttons-block">
				<div class="success-integration-second-block">
					<!--<button class="button" id="room-button">Go to
						Content Testing Space</button>-->
					<button class="secondary button" id="done-button">Done</button>
				</div>
			</div>
		</div>
		<div class="reveal" id="remove-integration-popup" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="large-12 columns desktop-block">
				<div class="row ">
					<div class="large-2 medium-2 columns"><img alt="icon" id="sharepoint-icon" src=""></div>
					<div class="large-6 medium-6 columns" style="float:left;">
						<span id="displayName-label">SharePoint Online</span><br>
						<span id="addedon-label"></span>
					</div>
				</div><br>
				<div class="msg-labels">
					<label id="remove-msg"></label> 
					<label id="remove-auth"></label>
				</div>
				<button class="close-button" data-close aria-label="Close modal" type="button">
					<span aria-hidden="true">&times;</span>
				</button><br><br>
				<button class="button remove-integration-btn" id="remove-integration-btn" style="float:right">Remove</button>
			</div>
			<div class="large-12 columns mobile-block">	
				<div class="msg-labels">
					<label id="remove-msg-mobile"></label> 
					<label id="remove-auth-mobile"></label> 
				</div>				
				<div class="option-buttons remove-integration-buttons">
					<label  id="cancel-remove-integration" class="remove-popup-cancel"><!--  " -->
						<a href="#">Cancel</a>
					</label>
					<label id="remove-integration-btn" class="remove-integration-btn remove-popup-remove">
						<a href="#">Remove</a>
					</label>
				</div>
			</div>
		</div>
		<div id="same-configuration" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="same-config-text">An identical configuration to the same Cisco Spark space you have selected already exists. Are you sure you want to configure one more?</div>
			<div class="large-5 medium-5 columns buttons-block">
				<button class="secondary button same-config-yes">Yes</button>
				<button class="secondary button same-config-no">No</button>
			</div>
		</div>
		<div class="integrations" id="integrations-block">
			<div id="instance-loading-block" class="row instance-loading-block" style="display: none;">
				<div class="instances-loading">&nbsp;</div>
				<div class="instances-loading-text"></div>
			</div>
			<div id="home" class="home">			
				<div class="row add-config-block">
					<div class="large-12 medium-12 columns">							
						<div class="large-6 medium-6 columns config-name"><label>SharePoint Online Documents configurations</label></div>
						<div class="large-6 medium-6 columns">
							<button class="button" data-open="remove-integration-popup" id="remove-all-config">Remove All</button>
							<button class="secondary button" id="add-config">Add</button>
						</div>					
					</div>
				</div>
				<div id="instance-list-block" class="row instance-list-block">						
				</div>
			</div>
		</div>
		<div id="integration-form" class="large-12 columns" >
			<div class="large-12 medium-12 columns edit-siteconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured site name does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-libconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured libraries does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-itemconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured folder/file does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-subfolderconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured subfolder does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-searched-source-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured folder/file from the selected subfolder is does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-roomconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured space does not exist.</span></p>
			</div>
			<div class="authenticted-block">Authenticated to SharePoint Online Documents as: <span id="authenticted-to"></span></div>
			<div class="no-configuration-block" style="display:none">There are no Folders/Files available in your SharePoint Online Documents Account. Please Add folders/files in your account and configure</div>
			<form name="form" id="form" method="post">
				<div class="row app-config-block">
					<div class="large-12 medium-12 columns  first sub-config-block">
						<label class="heading-01">SharePoint Online Documents configuration</label>
						<div class="large-8 columns items-config">
							<div class="large-3 medium-3 columns ">
								<label class="label-config">Team Site/Subsites
									<span class="has-tip tip-right" id="tooltip-sharep" title="Select the team site/subsite for which you would like to receive notifications" data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-5 columns dropdown-config  text left ">
								<select id="siteurls" name="resource" class="dropdown">
									<option value="0">Select team Site/Subsite</option>			 
								</select>
								<div class="sitenames-loading" style="display: none;"></div>
							</div>			
						</div>
						<div class="large-8 columns items-config">
							<div class="large-3 medium-3 columns " style="text-align:center;margin-top:-14px">
								<label class="label-config">OR</label>
							</div>
						</div>
						<div class="large-8 columns items-config" >
							<div class="large-2 medium-3 columns  config-optional"> 
								<label style="padding:0 24px 0 0;">Created your own site? Enter your site URL
									<span class="has-tip tip-right site_tooltip" id="tooltip" title="Input your site's SharePoint homepage URL (e.g. https://ouroffice365. sharepoint.com/... /Home.aspx) and then hit &quot;Show Documents&quot;" data-tooltip><img class="tool-tip"></span>
									<!--<span class="has-tip tip-right sharepoint-url-tooltip" id="tooltip" title="Input your site's SharePoint homepage URL (e.g. https://ouroffice365. sharepoint.com/... /Home.aspx) and then hit &quot;Show Documents&quot;" data-tooltip><img class="tool-tip"></span>-->
								</label>
							</div>
							<div class="large-5 medium-5  columns text left  sharepoint-weburl"> 
								<input name="WebUrl" id="WebUrl" class="integration-name" placeholder="https://<domain>.sharepoint.com/site/<SiteName>/SitePages/Home.aspx" type="text"> 
							</div>
							<button id="show-folders-btn" class="secondary button" style="font-size: 11px;">Show Libraries</button>
						</div>
					</div>
					<div class="large-12 medium-12 columns sub-config-block librarySelection" style="display:none;"> 
						<div class="large-8 columns items-config">
							<div class="large-4 medium-3 columns">
								<label style="margin-top:6px;">Libraries
									 <span class="has-tip tip-right1 "  style="margin-top:-6px;" id="tooltip1" title="Select the library for which you'd like to receive notifications." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-6 columns dropdown-config text left">
								<select id="libraries" name="libraries" class="dropdown">
									<option value='0' hidden>libraries</option>				 
								</select>
								<div class="settings-loading" style="display: none;"></div>
							</div>			
						</div>
					</div>
					<div class="large-12 medium-12 columns sub-config-block foldersfilesSelection" style="display:none;"> 
						<div class="large-8 columns items-config">
							<div class="large-4 medium-3 columns config-optional">
								<label class="label-config" style="padding:0px 37px  0 0;">Folders / Files
									 <span class="has-tip tip-right folder_file_tooltip" id="tooltip" title="Select the folder or file for which you'd like to receive notifications." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-6 columns dropdown-config text left">
								<select id="resources" name="resource" class="dropdown">
									<option value='0' hidden>Select Folders / Files</option>
								    <option value="all">All Folders & Files </option>
									<option value="rootfolders">All Folders (including nested folders and files)</option>
									<option value="rootfiles" >All Files</option>
									<optgroup id="folders" label="Root Folders"></optgroup >
									<optgroup id="files" label="Root Files"></optgroup >				 
								</select>
								 <!-- <span class="has-tip tip-right" id="tooltip" title="Select the folder or file for which you'd like to receive notifications." data-tooltip><img class="tool-tip"></span>-->
								<div class="items-loading" style="display: none;"></div>
							</div>			
						</div>
					</div>
					<div class="large-12 medium-12 columns sub-config-block subfolderSelection" style="display:none;">
						<div class="large-8 columns items-config">
							<div class="large-4 medium-3 columns config-optional" style="">
								<label class="label-config" style="padding:0px 37px  0 0;">SubFolders / Files (Optional)
									<span id="tooltip-sharepointsub" class="has-tip tip-right subfolder_files_tooltip"  title="Select the subfolder or file for which you'd like to receive notifications. If you don't select a subfolder/file here, then you will receive notifications for all subfolders." data-tooltip><img class="tool-tip"></span><!--style="margin:-20px 0 0 4rem;"-->
								</label>
							</div>
							<div class="large-5 mediukm-6 columns dropdown-config text left ">
								<select id="subfolders" name="subfolders" class="dropdown">
									<option value="0">SubFolders / Files</option>
									<optgroup id="SharePoint-places-folders" label="Folders" style="display:none"></optgroup >
									<optgroup id="SharePoint-places-files" label="Files"></optgroup >										
								</select>
								<div class="subitems-loading" style="display: none;"></div>
							</div>				
						</div>
					</div>
					<div class="large-12 medium-12 columns sub-config-block searchfunction" style='display:none'>
						<div class="large-8 columns items-config ">
						
							<div class="large-4 medium-3 columns config-optional">
								<label class="label-config" style="padding:0 19px 0px 0">Search Folders / Files (Optional)
									<span class="has-tip tip-right search_tooltip" title="Recently created files/folders may not appear in search results given Microsoft API behavior. Please try again later if you do not see a file or folder that you recently created." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-6 columns dropdown-config text left">
								<table style='border-collapse:collapse;width:80%;border:1px solid #D7D7D7;margin:0px;border-radius:3px;'>
									<tbody style="border:0px;border:none !important;">
									<tr style='border:none'>
										<td style='width:90%;padding:0px;border:0px;'>
											<input type='text' name="search_query_input" placeholder="Search Folder or File" id="search_query_input" class="integration-name" autocomplete='off' value=""/>
											<input type='hidden' id='search_query_input_id'/>
										</td>
										<!-- <td class='searchtd' id="googledrivesearchitems"></td> -->
									</tr>
									</tbody>
								</table>
								<input type="button" class="secondary button search-btn" value="Search"/>
								<div id='select_resource'><div id='search_query_box'></div></div>
							</div>
							<span class="search-items-loading" style="display:none"></span>
						</div>
					</div>
					
					
					<div class="large-12 columns events-config">
						<div class="large-12 medium-12 columns events">
							<label>Notifications</label>
							<div id="events" class="events-sub">
								<div id="event-note" >
								<label>Note: If a folder is selected, notifications selected below will be applied to all files and subfolders within the selected folder.</label>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="create" class="create-chkbox" name="events" value="create"/><label for="create">Create</label></div>
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="delete" name="events" value="delete"/><label for="delete">Delete</label></div>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-8 medium-8 columns checkbox"><input type="checkbox" id="modify" name="events" value="update"/><label for="modify">Update (rename, copy and/or file content update)</label></div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row spark-config-block">
				<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space
									<span class="has-tip tip-right" id="tooltip2" title="Space in which you'd like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
									<option value='0'>Please select a space</option>
								</select>
							</div>
							<div class="spaces-refresh" title="Refresh the spaces"></div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>							
						</div>
					</div>
				</div>
				<div class="row integration-config-block">
					<div class="large-5 medium-5 columns"> &nbsp;</div>
					<div class="large-4 medium-4 columns left">
						<button id="cancel-button" class="button">Cancel</button>
						<button id="submit-button" class="button secondary text">Add Integration</button>
					</div>
				</div>
			</form>
		</div>		
	</div>
</body>
</html>