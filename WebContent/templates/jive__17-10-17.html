<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Jive Configuration</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.css" rel="stylesheet" type="text/css"> 
<link href="https://d24wgzqqegxpap.cloudfront.net/api/css/collab-ui-min.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/styles.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/select2.min.css" rel="stylesheet" />  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.js"></script> 
<script type="text/javascript" src="https://d24wgzqqegxpap.cloudfront.net/api/js/porthole.min.js"></script>
<script type="text/javascript" src="https://183.82.99.100:8443/CiscoWebcontent/js/operations1.js"></script>
<script src="https://183.82.99.100:8443/CiscoWebcontent/js/select2.min.js"></script>
<style>
ul, li{list-style:gray;}

</style>
<script> 
	integration_app_icon_url="https://d24wgzqqegxpap.cloudfront.net/api/images/jive/jive.png";
	var protocol = "https://";
	var domain = ".jiveon.com";
	var selected_place_id="0";
	var selected_content_id="0";
	var place_id_old="";
	var integration_token="";
	var webhookUuid ="";
	var instanceUuid = "";
	var jsonString1 = "";
	appName = "Jive";
	var contentValue="";
	var selectedPlaceId = "";
	var configFlag = false;
	var jiveValidatePayload={};
	//
	var jiveSubdomain1 = $('#jivesubdomain1').val();
	var jiveclientid= $('#jiveclientid').val();
	var jiveclientsecrete= $('#jiveclientsecrete').val();
	//
	postMessageToSpark = appName+" "+postMessageToSpark;
	updateMessageToSpark= appName+" "+updateMessageToSpark;
	removeMessageToSpark= appName+" "+removeMessageToSpark;
	var application_id="26";
	$( document ).ready(function() {
		application_auth_details_url="/api/applications/"+application_id;
		token_url="/api/integrations/"+integration_id+"/authDetails";
		save_spark_token_url="/api/clients/tokens";
		save_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		get_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		configuration_settings_url="/api/integrations/"+integration_id+"/uiSettings";
		save_configuration_settings_url="/api/integrations/instances";
		update_configuration_settings_url="/api/integrations/instances/";
		delete_instance_url="/api/integrations/instances/";
		//validate_client_url="/api/integrations/"+integration_id+"/uiSettings";
		list_integration_instances_url="/api/integrations/instances";		
		removeall_integration_instances_url="/api/integrations/instances";		
		delete_spark_token_url="/api/clients/tokens";
		delete_integration_token_url="/api/integrations/"+integration_id+"/appTokens";
		getSparkSpaceDetails = "/api/integrations/"+integration_id+"/getSparkSpaceDetailsBySpaceId";
		action=action.toLowerCase();
		
		if(action=="connect") {
			console.log("connect block executing");
			formAction=="connect";
			$("#integrations-block").hide();
			$("#integration-form").hide();
			validateIntegrationAppToken();
		} else if(action=="disconnect") {
			formAction="disconnect";
			removeAllIntegrationInstances(formAction);
		} else {
			/*var app_code =   gup(document.referrer, 'code');
			if(app_code!="") {
				generateIntegrationAppToken(app_code); 
			} else {
				validateIntegrationAppTokenDB();
			}*//*re direction code*/
			validateIntegrationAppTokenDB();
		} 
  
		$("#expand-close").addClass("expandarrow");
		$('#expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				$('#showSetup').hide();
				 $(this).removeClass("closearrow");
				 $(this).addClass("expandarrow");
				 $('.expandarrow').attr('title','expand');
			}else{
				$(this).addClass("closearrow");
				$(this).removeClass("expandarrow");
				$('.closearrow').attr('title','close');
				$('#showSetup').show();
			}
			resize();
		});
		$("#rooms").select2();
		$('#places').select2();
		$('#place-content-list').select2();
		$("#jive-icon").attr("src", integration_app_icon_url);
		$(".spark-icon").attr("src", spark_icon_url);
		$("#submit-button").click(function (e){
			e.preventDefault();	
			saveJiveInstance();
		});
		$("#places").change(function () {
			$(".places-content-list").hide();
			$("#jive-places-files").show();
			$("#jive-places-documents").show();
			$('#place-content-list').select2();
			//$('#place-content-list option[value!="0"]').remove(); 
			if($("#places").val() != '0'){
				console.log("in on change place value!!!!!" + $("#places").val());
				selected_content_id = "0";
				var jsonObject={};
				jsonObject["integrationId"] = integration_id;
				jsonObject["userId"] = user_id;
				jsonObject["placeID"] = $("#places").val();
				jsonString1=JSON.stringify(jsonObject);
				getContentList(jsonString1);
			}
			resize();
		});
		$("#place-content-list").change(function () {
			 contentValue = $("#place-content-list").val();
			if(contentValue!="0"&&contentValue!=null&&contentValue!="")
				 $("#created").attr("disabled", true);
			else
				 $("#created").removeAttr("disabled");
			console.log("contentValue..." + contentValue);
		});
		$("#cancel-button").click(function (e){
			e.preventDefault();			
			$('#integration-form').hide();
			$('#integrations-block').show();
			if(listResultData.length == 0) listIntegrations();
			resize();
		});
		
		$("#displayName").keypress(function(e){
			if(e.which == 13)
			e.preventDefault();			
		});
		
		$('#get-authentication').click(function(e){
		   e.preventDefault();
		   console.log("this auth button"+$('#jivesubdomain').val());
		   var xx=$('#jivesubdomain').val();
		   if(xx!="") {
	 
			   jiveSubdomain = $('#jivesubdomain').val();
												   
			   setIntegrationAppAuthDetails(jiveSubdomain); 
			   $('#jivedomain').val(jiveSubdomain+domain);
		   } else {
				alert("Please enter your Jive Domain00000000000000000000");
		   }
		});
		$('#clientvalidate-button').click(function(e){
		   e.preventDefault();
		   //console.log("accessCosde:: "+accessCode);
		   if($('#jivesubdomain1').val()!="" && $('#jiveclientid').val()!="" && $('#jiveclientsecrete').val()!=""){
	 
			   jiveSubdomain = $('#jivesubdomain1').val();
			   jiveValidatePayload={};
			   jiveValidatePayload["domain"] = jiveSubdomain;
			   jiveValidatePayload["clientId"] = $('#jiveclientid').val();
			   jiveValidatePayload["clientSecret"] = $('#jiveclientsecrete').val();
			   
			   
			   validateJiveDomain(jiveValidatePayload);							   
			   //setIntegrationAppAuthDetails(jiveSubdomain); 
			   $('#jivedomain').val(jiveSubdomain+domain);
		   } else {
				alert("Please enter your Jive Domain, ClientID and ClientSecrete");
		   }
		}); 
		$('#jive #add-config').click(function(e){
			e.preventDefault();	
			formAction="add";
			$('#select2-rooms-container').html('Please select a space');
			console.log("bbbbbbbbbbbbbbbbbb...................");
			$('#integrations-block').hide();
			$('#integrations-block').hide();
			$(".places-content-list").hide();
			if(listResultData.length != 0){
				$("#submit-button").text("Add");
				if(isClientAppTokenValid){
					loadJiveForm();	
					loadRooms();
				}else{
					setIntegrationAppAuthDetails(integration_id);
					$('#integrations-block').hide();
					$("#protocol").html(protocol);
					$("#domainName").html(domain);
					$("#authenticate-block").show();
				}
			}else{
				$("#submit-button").text("Add Integration");
				validateIntegrationAppToken();
			}
		});
		$("#jive #places").on('change',function(){
			if($('#places').val()!=0&&formAction=="update")
				$(".edit-itemconfig-info").hide();
		});	

		$("#jive #rooms").on('change',function(){
			if($('#rooms').val()!=0&&formAction=="update")
				$(".edit-roomconfig-info").hide();
		});	
		$("#jive #contents").on('change',function(){
			if($('#contents').val()!=0&&formAction=="update"){
				console.log("in on change!!!");
				$(".edit-contentconfig-info").hide();
			}
		});	
		/*$(document).on('click', '.select2.select2-container', function(e) {
			console.log("content click!!!!!");
			$(".select2-search__field").attr("placeholder", "contents");
		});*/
		$(document).on("click", "#jive #instance-list-block .edit-config" , function() {
			console.log("edit instance");			
			formAction="update";
			room_modified=false;
			place_modified=false;
			$('#select2-rooms-container').html('Please select a space');
			$("#submit-button").text("Save");
			resize();
			instanceId=this.id;
			$.each(listResultData,function(index,value){
				if(value["instanceId"]==instanceId) {
					instanceData=value;
				}
			});
			$("#expand-close").removeClass("closearrow");
			$("#expand-close").addClass("expandarrow");
			$('.expandarrow').attr('title','expand');
			$("#showSetup").hide();
			
			selected_room_id=instanceData.channelId;
			instanceUuid = instanceData.instanceUuid;
			var config=JSON.parse(instanceData.configJson);
			selected_place_id=config.placeID;
			place_id_old = config.placeID;			
			selected_content_id=config.contentID;
			console.log("selected_place_id.." + selected_place_id + " selected_content_id!!!" + selected_content_id);
			var jsonObject={};
				jsonObject["integrationId"] = integration_id;
				jsonObject["userId"] = user_id;
				jsonObject["placeID"] = config.placeID;
				jsonString1=JSON.stringify(jsonObject);
			loadJiveForm();
			webhookUuid = config.webhookUuid;
			room_id_old = instanceData.channelId;
			$('#displayName').val(config.displayName);
			var events = config.events;			
			if($.isArray(events)) {
				$.each(events,function(index,value){
					$("input[type=checkbox][value="+value+"]").prop("checked",true);
				});
			} else {
				$("input[type=checkbox][value="+events+"]").prop("checked",true);
			}
		});
	});
	function validateIntegrationAppToken() {
		$.ajax({url: get_app_token_url+"?userId="+user_id,
			async:true,
			headers: { 'userId': user_id },
			type: "get",
			success: function(result){
				if(result.tokenResult.tokenId) {
					//loadJiveForm();	
					validateIntegrationAppspecificToken();
				} else {
					console.log("in validateIntegrationAppToken!!");
					//setIntegrationAppAuthDetails(integration_id);
					$("#protocol").html(protocol);
					$("#domainName").html(domain);
					$("#authenticate-block").show();
				}
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	//
	function validateIntegrationAppspecificToken(){
		$.ajax({
			url: configuration_settings_url+"?userId="+user_id,
			async: true,
			headers: { 'userId': user_id },
			success: function(result){
					if(result["integrationSpecificSettings"]["isValidToken"]==false && result["integrationSpecificSettings"]["isValidToken"] != undefined){
						isClientAppTokenValid = false;
						console.log("***** validateIntegrationsApp token  with validateClientToken *********");
						if(listResultData.length==0){
							setIntegrationAppAuthDetails(integration_id);
						}
					}else{
						loadJiveForm();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
 
 function saveJiveClentAppDetails(jiveClientDetails) {
		console.log("....kjhdfioj;f;gf");
		$.ajax({url: configuration_settings_url,
			async:true,
			headers: { 'userId': user_id ,'Accept': 'application/json','Content-Type': 'application/json'},
			method: "POST",
			data : jiveClientDetails,
			success: function(result){
				console.log("Resp :: "+JSON.stringify(result));
				//console.log("subdomain: "+jiveSubdomain1+" clientis"+jiveclientid+" clientsecrete  "+jiveclientsecrete);
			},
			error: function(xmlHttpRequest,error) {
				console.log("error....");
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateSpecificAppToken(app_code){
		console.log("In validateSpecificAppToken()");
		$.ajax({
			url: configuration_settings_url+"?userId="+user_id,
			async: true,
			method: "POST",
			headers: { 'userId': user_id },
			success: function(result){
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false){
						isClientAppTokenValid = false;
						if(app_code!="") getIntegrationAppTokenDetails(app_code);
						else setIntegrationAppAuthDetails(integration_id);					
					}else{
						isClientAppTokenValid = true;
						listIntegrations();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	//
	function setIntegrationAppAuthDetails() {
		console.log("........next auth connect");
		var OAUTHURL    =   '';
		var CLIENTID    =   '';
		$.ajax({url: application_auth_details_url,
			async:true,
			headers: { 'userId': user_id },
			success: function(result){
				CLIENTID=result.clientId;
				var authorizationEndpoint= result.authorizationEndpoint;
				console.log("authorizatoin Endpoint "+authorizationEndpoint);
				authorizationEndpoint=authorizationEndpoint.replace("eidiko", jiveSubdomain);
				OAUTHURL=authorizationEndpoint+'?client_id='+CLIENTID+'&response_type=code';
				//OAUTHURL=authorizationEndpoint+'?client_id='+CLIENTID+'&response_type='+TYPE+'&redirect_url='+REDIRECT_URI;
				console.log("OAUTHURL..."+OAUTHURL);
				loginWithAuthDetails(OAUTHURL);	
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});		
	}
	function validateJiveDomain(jivaPayload){
		console.log("payload ::: "+JSON.stringify(jivaPayload));
		console.log("jiveSubdomain "+jivaPayload["domain"]+" clientId "+jivaPayload["clientId"] );
		var oauthURL = "https://"+jivaPayload["domain"]+".jiveon.com/oauth2/authorize?client_id="+jivaPayload["clientId"]+"&response_type=code";
		var win1 = window.open(oauthURL, "windowname1", 'width=700, height=600'); 
		if(win1){
		}else{
			alert(popblockedMessage); 
			return false;
		}
		
		var pollTimer = window.setInterval(function() { 
			console.log("URL ::: "+win1.document.URL);
			try {
			//alert("-----------valida1----------");
				if (win1.document.URL.indexOf("code") != -1) {
				//alert("-----------valida2----------");
					window.clearInterval(pollTimer);
					var url = win1.document.URL;
					accessCode =  gup(url, 'code');
					console.log("accessCosde:: "+accessCode);
					win1.close();
					jiveValidatePayload["authSettings"]={};
					jiveValidatePayload["authSettings"]["code"]=accessCode;
					jiveValidatePayload["method"]="GET";
					console.log("My ::: "+JSON.stringify(jiveValidatePayload));
					
					saveJiveClentAppDetails(JSON.stringify(jiveValidatePayload));
				}
			} catch(e) {
				console.log('error while getting authorization code..'+e);
			}
		}, 100);
	}
	function loginWithAuthDetails(oauthURL) {
        var win = window.open(oauthURL, "windowname1", 'width=700, height=600'); 
		if(win){
		}else{
			alert(popblockedMessage); 
			return false;
		}
        var pollTimer = window.setInterval(function() { 
            try {
                if (win.document.URL.indexOf("code") != -1) {
                    window.clearInterval(pollTimer);
                    var url = win.document.URL;
                    accessCode =  gup(url, 'code');
					console.log("accessCosde:: "+accessCode);
                    win.close();
					
					getIntegrationAppTokenDetails(accessCode);
					
                }
            } catch(e) {
				//console.log('error while getting authorization code..'+e);
            }
        }, 100);
    }
	function getIntegrationAppTokenDetails(code) {
		console.log("-------jdfuivbuibufvb----------");
		 jiveSubdomain = $('#jivesubdomain').val();
		var jsonObject={};
		//jsonString["clientId"] = $('#jiveclientid').val();
		//jsonString["clientsecrete"] = $('#jiveclientsecrete').val();
		jsonObject["integrationId"] = integration_id;
		jsonObject["authSettings"] = {};
		jsonObject["authSettings"]["subDomain"] = jiveSubdomain;
		//jsonObject["authSettings"]["subDomain"] = eidiko-cisco;
		jsonObject["authSettings"]["code"] = code;
		jsonString=JSON.stringify(jsonObject);
		$.ajax({url: token_url,
			async:true,
			headers: { 'userId': user_id },
			type: "POST",
			data: jsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result){
			console.log("token call.........");
				var tokenDetails=result["integrationSpecificAuthDetails"];
				var jsonObject1={};
				jsonObject1["applicationId"] = application_id;
				jsonObject1["integrationId"] = integration_id;
				//jsonObject1["integrationId"] = Y2lzY29zcGFyazovL3VzL0FQUExJQ0FUSU9OL0MzYzRlMmVlZGNhYjZhNDY3ZTk4MjM1ZjllMjdiMDZlZjIwZDRkMzJjMjI2ZjYyYTBlYmZmMzUxMTY4MzczMjVj;
				jsonObject1["accessToken"] = tokenDetails.accessToken;
				var tokenExpireTime="";
				jsonObject1["expires"] = tokenDetails.expires;
				jsonObject1["refreshToken"] = tokenDetails.refreshToken;
				jsonObject1["subDomain"] = jiveSubdomain;
				var jsonString=JSON.stringify(jsonObject1);
				saveIntegrationAppToken(jsonString);
				$('#authenticate-block').hide();
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}

	function saveIntegrationAppToken(jsonData){
		$.ajax({url: save_app_token_url+"?userId="+user_id,
			async:true,
			headers: { 'userId': user_id },
			type: "POST",
			data: jsonData,
			contentType: "application/json",
			dataType: "json",
			success: function(result){
				saveIntegrationTokenResponse="success";
				console.log("saveIntegrationAppToken success");
				connectIntegration();
				loadJiveForm();
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					saveIntegrationTokenResponse="failure";
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});	
	}	
	function getContentList(jsonString1){
		console.log("in getContentList!!!!!!!!!!!!!");
		var isContentList = false;
		var itemFlag=false;
		var filesCount = 0;
		var documentsCount = 0;
		$("#created").removeAttr("disabled");
		$(".places-content-list").show();
		$(".items-loading").show();
		$("#jive-places-files").html("");
		$("#jive-places-documents").html("");
		resize();
		$.ajax({url: configuration_settings_url+"?userId="+user_id,
				type: "POST",
				headers: { 'userId': user_id },
				async:true,
				data: jsonString1,
				contentType: "application/json",
				dataType: "json",
				success: function(result){
					$(".items-loading").hide();
					var contents = result["postSpecificIntegrationSettings"]["places"]["list"]; 
					if(contents.length != 0){
						$.each(contents, function(id,obj){ 
							if(obj.type=="file"){
								filesCount++;
								isContentList = true;
								$("#jive-places-files").append($('<option>').text(obj.subject).attr('value',obj.contentID));
							}
							if(obj.type=="document"){
								documentsCount++;
								isContentList = true;
								$("#jive-places-documents").append($('<option>').text(obj.subject).attr('value',obj.contentID));
						
							}
							if(formAction=="update" && selected_content_id==obj.contentID || selected_content_id=="0" && itemFlag==false){
								console.log("each selected_content_id..." + selected_content_id);		
								if(selected_content_id=="0"){
									selected_content_id=0;
								}else{selected_content_id=obj.contentID;}
								itemFlag=true;
							}
						});	
						if(!isContentList){$(".places-content-list").hide();alert("No content available for the selected place.");}
						if(filesCount==0)$("#jive-places-files").hide();
						if(documentsCount==0)$("#jive-places-documents").hide();
					}else{
						$(".places-content-list").hide();
						alert("No content available in the selected space, group or project.");
					}
					if(formAction=="update" && itemFlag==false && selected_content_id!=0){
							selected_content_id = "0";
							$(".edit-contentconfig-info").show();
					}
					$("#place-content-list").val(selected_content_id);
					$('#select2-place-content-list-container').html($("#place-content-list option:selected").text());
					console.log("in get content list selected content "+selected_content_id);
					if(selected_content_id !=0) $('#created').attr('disabled',true);
					else $('#created').attr('disabled',false);
					selected_content_id="0";
					resize();
				},
				error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$(".places-content-list").hide();
						alert("We've experienced some difficulty. Try again.");
						resize();
					}
				}
			});
	}
	
	function getAuthUser(){
		if(ui_settings["integrationSpecificSettings"] != undefined && ui_settings["integrationSpecificSettings"] !=""){
			if(ui_settings["integrationSpecificSettings"]["settings"] != undefined && ui_settings["integrationSpecificSettings"]["settings"] != null)
				authenticated_user=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"].subDomain;
		}
	}
	function loadJiveForm(){
		console.log("selected_room_id!!!!in loadJiveForm!!!!" + selected_room_id);
		$("#form").trigger("reset");
		$('#integrations-block').hide();
		$("#integration-form").show();	
		$(".edit-roomconfig-info").hide();
		$(".edit-itemconfig-info").hide();
		$(".edit-contentconfig-info").hide();
		$(".rooms-loading").show();
		$('#places').select2();
		resize();
		//if(ui_settings=="") {
			$(".settings-loading").show();
			$.ajax({
				url: configuration_settings_url+"?userId="+user_id,
				async: true,
				headers: { 'userId': user_id },
				success: function(result){
					$(".settings-loading").hide();
					ui_settings=result;	
					loadConfigurationSettings();
					loadRooms();
				},
				 error: function(xmlHttpRequest, error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$('#integration-form').html("We've experienced some difficulty. Try again.");
						$('#integration-form').hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			getAllSparkRooms();
			
		/*	}else{
			loadConfigurationSettings();
		} */
		resize();
	}
	function loadConfigurationSettings(){
			console.log("in loadConfigurationSettings!!!!!!!!!!");
			if(ui_settings["sparkRoomSettings"]!=null && ui_settings["integrationSpecificSettings"]["settings"]!=undefined && ui_settings["integrationSpecificSettings"]["settings"] != null ) {
			var roomFlag=false;
			var itemFlag=false;
			$("#jive-spaces").hide();
			$("#jive-groups").hide();
			$("#jive-projects").hide();
			
			var blogsCount, spaceCount, groupsCount, projectsCount = 0;
			var isPlaceExists=false;
			resize();
			$('#authenticate-block').hide();
			$('#jivedomain').val(protocol+ui_settings["integrationSpecificSettings"]["settings"]["userDetails"]["subDomain"]+domain);
			$('.jivedomain-text').html(protocol+ui_settings["integrationSpecificSettings"]["settings"]["userDetails"]["subDomain"]+domain);
			
			var places = ui_settings["integrationSpecificSettings"]["places"]["list"];
			var rooms = "";
			var authorizedto=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"].subDomain;
			if(authorizedto!=""&&authorizedto!=undefined) {
				$('#authenticted-to').html(authorizedto);
				$(".authenticted-block").css("display","block");
			} 
			$('#places')[0].options.length =1;
			
			$.each(places, function(id,obj){
				isPlaceExists=true;
				if(obj.iconCss=='jive-icon-space'){
					spaceCount++;
					$("#jive-spaces").append($('<option>').text(obj.name).attr('value',obj.placeID));
				}
				if(obj.iconCss=='jive-icon-group'){
					groupsCount++;
					$("#jive-groups").append($('<option>').text(obj.name).attr('value',obj.placeID));
				}
				if(obj.iconCss=='jive-icon-project'){
					projectsCount++;
					$("#jive-projects").append($('<option>').text(obj.name).attr('value',obj.placeID));
				}
				if(formAction=="update" && selected_place_id==obj.placeID && itemFlag==false){
					console.log("matched..." + selected_place_id);
					selected_place_id=obj.placeID;
					itemFlag=true;
				}
			});
			if(formAction=="update" && itemFlag==false){
				selected_place_id = "0";
				$(".edit-itemconfig-info").show();
			}
			if(formAction=="update"){
				getContentList(jsonString1);
			}
			$('#rooms')[0].options.length = 1;
			rooms = ui_settings["sparkRoomSettings"].items;
			if(allRooms.length !=0) {
				rooms = allRooms;
				//$(".rooms-loading").hide();
			}
			$.each(rooms, function(id,obj){
				obj.title=$('<div />').text(obj.title).html();
				console.log("obj.title!!!!html!!!" + obj.title);
				$("#rooms").append($('<option>').text(obj.title).attr('value',obj.id));
				if(formAction=="update" && selected_room_id==obj.id&&roomFlag==false){
					selected_room_id=obj.id;
					roomFlag=true;
				}
			});
			if(formAction=="update" && roomFlag==false){
				selected_room_id = "0";
				$(".edit-roomconfig-info").show();
			}
			if(spaceCount == 0){
				$("#jive-spaces").hide();
			}
			if(groupsCount == 0){
				$("#jive-groups").hide();
			}
			if(projectsCount == 0){
				$("#jive-projects").hide();
			}	
			console.log("selected_room_id!!!!in before setting!!!!" + selected_room_id);
			console.log("before setting selected_place_id.." + selected_place_id);
			$("#places").val(selected_place_id);
			$("#rooms").val(selected_room_id);
			$('#select2-rooms-container').html($("#rooms option:selected").text());
			$('#select2-places-container').html($("#places option:selected").text());
			//selected_room_id="0";
			$(".rooms-loading").hide();
			selected_place_id="0";
			if(isPlaceExists) {
			} else {
				$('.no-configuration-block').show();
				$('#form').hide();
			}
			resize();
		}else {
			$("#integration-form").hide();
			alert("We've experienced some difficulty. Try again.");
			console.log("in loadConfigurationSettings else part--------!!!!!!!!!!");
		}	
	}
	function validateConfiguration(instance){
		configFlag = false;
		var configData = JSON.parse(instance.configJson);
		if(configData.placeID==selectedPlaceId){
			console.log("matched...room");
			configFlag = true;
		}
	}
	function saveJiveInstance() {
		console.log("saveJiveInstance");
		var res = $('form').serializeObject();
		var selectedRoomName=$("#rooms option:selected").text();
		var room_id = $("#rooms option:selected").val();
		selectedPlaceId=$("#places option:selected").val();
		var jsonData = {};			
		jsonData["channelId"] = room_id;									
		jsonData["integrationId"] = integration_id;
		jsonData["status"] = "ACTIVE";
		jsonData["userId"] = user_id;
		jsonData["configJson"]={};
		var action_url;
		var actionType;
		postAddMessageToRoom(room_id,appName);
		if(formAction=="update") {
			jsonData["instance_id"] = instanceId;
			jsonData["room_id_old"] = room_id_old;
			jsonData["instanceUuid"] = instanceUuid;
			resize();
			if(room_id!=room_id_old) {
				room_modified=true;
				jsonData["messageToSpark"] = updateMessageToSpark;
			} else {
				room_modified=false;
			}
			if(selectedPlaceId!=place_id_old) {
				console.log("place modified...");
				place_modified=true;
			} else {
				place_modified=false;
			}
			jsonData["room_modified"] = room_modified;
			jsonData["configJson"]["webhookUuid"] = webhookUuid;
			action_url=update_configuration_settings_url+instanceId;
			actionType="PUT";
			console.log("in update.....");
			/*$.each(listResultData,function(index,value){
				console.log("config json.." + value["configJson"]);
				var config=JSON.parse(instanceData.configJson);
				if(config.placeID==selectedPlaceId&&place_modified==true) {
					console.log("selected place id.." + selectedPlaceId);
					console.log("matched place id.." + config.placeID);
					placeExists = true;
				}
			});*/
			console.log("update integration");
			$('.loading-first-block').html('Please wait while your configuration is being updated');
		} else {
			jsonData["messageToSpark"] = postMessageToSpark;
			action_url=save_configuration_settings_url;
			actionType="POST";
			console.log("save integration");
			$('.loading-first-block').html('Please wait while your configuration is being set up');
		}
		jsonData["configJson"]["notifications"] = res.events;
		jsonData["configJson"]["displayName"]= res.displayName;
		jsonData["configJson"]["placeID"] = selectedPlaceId;
		if($("#place-content-list").val()!=""&&$("#place-content-list").val()!=null)
			jsonData["configJson"]["contentID"] = $("#place-content-list").val();
		else
			jsonData["configJson"]["contentID"] = "0";
		var jsonString = JSON.stringify(jsonData);
		var notificationslength = objLength(res.events);
		if(listResultData.length != 0 && notificationslength !=0){
			$.each(listResultData, function(i, instance) {
				if(formAction=="update"&&instance.instanceId!=instanceId){
				console.log("instanceId!!!!!!!" + instanceId);
				 validateConfiguration(instance);
				 if(configFlag==true){
					 console.log("in update config Flag.." + configFlag);
						return false;
					}
				}
				if(formAction!="update"){
				 validateConfiguration(instance);
				  if(configFlag==true){
					 console.log("not in update config Flag.." + configFlag);
						return false;
					}
				}
			});
		}
		if($('#places').val()==0){
			alert("Plese select a space,group or project.");
		}else if(configFlag){
			console.log("config flag: " + configFlag);
			alert("Sorry, Jive only allows 1 Webhook per Place. Looks like you already have a configuration for this Place. Please either edit that configuration or delete it and create a new one.");
			//alert("A webhook with the same definition already exists. Please select different Place.");
		}else if(notificationslength==0){ 
		    alert("Please select at least 1 notification");
		}else if($('#rooms').val()==0 || $('#rooms').val()==null){ 
		    alert("Please select a space");
		} else {
			$('.loading-second-block').html('Selected Space is '+ selectedRoomName);
			$('#loading-block').foundation('open');
			$.ajax({url: action_url+'?userId='+user_id,
				async:true,
				headers: { 'userId': user_id },
				type: actionType,
				data: jsonString,
				contentType: "application/json",
				dataType: "json",
				success: function(result){
					if(actionType=="POST"){
						var obj = result["startResponse"]["webhookResult"];
						$('#loading-block').foundation('close');
						if(obj.hasOwnProperty("error")){
							if(obj["error"].status==409){
							console.log("409 error!!!!");
							var	message = result["startResponse"]["webhookResult"]["error"].message;
								alert(message +". Please select different Place.");
							}
						}else{
							console.log("in save!!!!!!");
							$('#success-integration').foundation('open');
							$('#loading-block').foundation('close');
						}
					}else{
						console.log("in update!!!!!!");
						$('#success-integration').foundation('open');
						$('#loading-block').foundation('close');
					}
				},
				error: function(xmlHttpRequest, error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   } else{
						$('#loading-block').foundation('close');
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			$('.loading-second-block').html('');
		}
		console.log(jsonString);
	}

</script>
</head>
<body>
	<div class="integration-app" id="jive">
		<div class="rows large-12 medium-12 columns warning-msg" style="display:none;"></div>
		<div id="loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait just a moment while your app is loading</div>
				<div class="loading-second-block">name and space name</div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="list-loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait...</div>
				<div class="loading-second-block"></div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="success-integration" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="success-loading">
				<img class="spark-icon" src="" alt=".....">
			</div>
			<div class="well-done-text">Well done!</div>
			<div class="success-integration-first-block">Your configuration has been set up and is ready to use.</div>
			<div class="large-5 medium-5 columns buttons-block">
				<div class="success-integration-second-block">
					<!--<button class="button" id="room-button">Go to
						Content Testing Space</button>-->
					<button class="secondary button" id="done-button">Done</button>
				</div>
			</div>
		</div>
		<div class="reveal" id="remove-integration-popup" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="large-12 columns desktop-block">			    
				<div class="row">
					<div class="large-2 medium-2 columns"><img alt="" id="jive-icon" src=""/></div>
					<div class="large-6 medium-6 columns" style="float:left;">
						<label id="displayName-label"></label>
						<label id="addedon-label"></label>
					</div>
				</div><br>
				<div class="msg-labels"><label id="remove-msg"></label> <label id="remove-auth"></label></div>				
				<button class="close-button" data-close aria-label="Close modal" type="button">
					<span aria-hidden="true">&times;</span>
				</button><br><br>
				<button id="remove-integration-btn" class="button remove-integration-btn" style="float:right">Remove</button>
			</div>
			<div class="large-12 columns mobile-block">	
				<div class="msg-labels"><label id="remove-msg-mobile"></label> <label id="remove-auth-mobile"></label></div>				
				<div class="option-buttons remove-integration-buttons">
					<label id="cancel-remove-integration" class="remove-popup-cancel"> 
						<a href="#" >Cancel</a>
					</label>
					<label class="remove-popup-remove remove-integration-btn">
						<a href="#">Remove</a>
					</label>
				</div>
			</div>
		</div>
		<div class="integrations" id="integrations-block">
			<div id="instance-loading-block" class="row instance-loading-block" style="display: none;">
				<div class="instances-loading">&nbsp;</div>
				<div class="instances-loading-text"></div>
			</div>
			<div id="home" class="home">
				<div class="row add-config-block">
					<div class="large-12 medium-12 columns">							
						<div class="large-6 medium-6 columns config-name"><label>Jive configurations</label></div>
						<div class="large-6 medium-6 columns">
							<button class="button" data-open="remove-integration-popup" id="remove-all-config">Remove All</button>
							<button class="secondary button" id="add-config">Add</button>
						</div>					
					</div>
				</div>
				<div id="instance-list-block" class="row instance-list-block">						
				</div>
			</div>
		</div>
		<div id="authenticate-block" style="display: none;">
			<form name="form1" id="form1">
			
				<div class="row">
					<div class="large-12 medium-12 columns jira-steps">
						<label><b>Step 1</b> (Jive Admin user)</label>
					</div>
				</div>
					<div class="large-12 medium-12 columns">
						<p>Before you (a Jive user) can set up the Jive integration, have your Jive Admin follow the steps below.</p><br>
						<p><span class="expandarrow" id="expand-close" title=""> &nbsp;</span><span id="config-label">Admin Instructions to Set Up Jive Add-On for Cisco Spark</span></p>
					</div><br>
					<div id="showSetup" style="display:none;">
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<h3><label>Step A</label></h3>
							</div>
							<div class="large-11 medium-11 columns step-text">
								<!-- <p><a href="https://jiveon.com/" target="_blank">Login</a> to your Jive account and click on your <b>Profile Picture</b> and then on <b>Add-Ons</b>.</p> -->
								<p>Login to your Jive account and click on your <b>Profile Picture</b> and then on <b>Add-Ons</b>.</p>
								<br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/jive/jivepic01.png"><br><br>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<h3><label>Step B</label></h3>
							</div>
							<div class="large-11 medium-11 columns step-text">
								<p>Download the Jive Add-On for Cisco Spark <a href="https://cisco-spark-jive-integration-dev.cloudhub.io/api/cisco-spark.zip">here</a> and verify the checksum for the file using a MD5 checksum utility.</p><br>
									
										<ol style="margin: 0 0 0 44px;"> <!----> 
											<li style=" list-style: square outside !important;"> Utility Filename: <strong>cisco-spark.zip</strong></li>
											<li style=" list-style: square outside !important;"> MD5 Checksum: <strong>ebb14a6464adb7fee96f9590de90caed</strong></li>
										</ol>
									
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<h3><label>Step C</label></h3>
							</div>
							<div class="large-11 medium-11 columns step-text">
								<p>Install the Add-On to your Jive instance by clicking on <b>Upload Package</b>.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/jive/jivepic02.png"><br><br>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<h3><label>Step D</label></h3>
							</div>
							<div class="large-11 medium-11 columns step-text">
								<!-- <p><a href="https://jiveon.com/" target="_blank">Login</a> to your Jive account and click on your <b>Profile Picture</b> and then on <b>Add-Ons</b>.</p> -->
								<p>Click on <b>Settings</b>. Copy and paste the Client ID and Client Secret values.</p>
								<br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/jive/jivepic03.png"><br><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/jive/jivepic04.png"><br><br>
								<div class="large-2 medium-2 columns"><h4><label>Jive Domain</label></h4></div>
								<div class="large-10 medium-10 columns">
									<div class="large-1 columns medium-3">
										<span id="protocol">https://</span>
									</div>
														
									<div class="large-2 medium-5 columns">
										<input name="jivesubdomain" id="jivesubdomain1" type="text">
									</div>
									<span id="domainName">.jiveon.com</span><br><br>
									
									<div class="large-1 columns medium-3">
										<span id="domainName">Client ID</span>
									</div>
									<div class="large-2 medium-5 columns">
										<input name="jiveclientid" id="jiveclientid" type="text">
									</div><br><br>
									<div class="large-1 columns medium-3">
										<span id="domainName">Client Secret</span>
									</div>
									<div class="large-2 medium-5 columns">
										<input name="jiveclientsecrete" id="jiveclientsecrete" type="text">
									</div>
									<div class="large-2 medium-2 columns">
									<button id="clientvalidate-button" class="button" style="font-size: 16px !important;">
												<b>validate</b>
									</button>
									</div>
								</div>
							</div>
						</div>
					</div><br><br><br>
					<div class="row">
					<div class="large-12 medium-12 columns jira-steps">
					
						<label><b>Step 2</b></label>
					</div>
					</div>
					<div class="large-12 columns">
					<p>Before you can authenticate your Jive account to continue setting up the integration, your Jive admin must follow the step above.</p><br>
					</div> 
					<div class="large-2 medium-2 columns"><h4><label>Jive Domain</label></h4></div>
					<div class="large-6 medium-10 columns">
						<div class="large-1 columns medium-1">
							<span id="protocol">http://</span>
						</div>
						<div class="large-4 medium-4 columns ">
							<input name="jivesubdomain" id="jivesubdomain" type="text">
						</div><span id="domainName">.jiveon.com</span>
						<div class="large-5 medium-5 columns">
							<button id="get-authentication" class="button" style="font-size: 16px !important;">
								<b>Authorize</b>
							</button>
						</div>
					</div>
					<br>
				</div>
			
			</form>
		</div>
		<div class="large-12 columns" id="integration-form">
			<div class="large-12 medium-12 columns edit-itemconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured place does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-roomconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured space does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-contentconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured content does not exist.</span></p>
			</div>
			<div class="authenticted-block">Authenticated to Jive Domain: <span id="authenticted-to"></span></div>
			<div class="no-configuration-block" style="display:none">There are no places available in your Jive Account. Please create places in your account and configure.<br></div>
			<form name="form" id="form" method="post">
				<div class="row app-config-block">
					<div class="large-12 columns first sub-config-block">					
						<label class="heading-01">Jive configuration</label>
						<div class="large-8 columns items-config" style="float:left;">
							<div class="large-3 medium-2 columns"><label class="label-config">Places <span class="has-tip tip-right" id="tooltip" title="Shows any Space, Groups or Projects that you have permissions set by your admin to view and follow." data-tooltip><img class="tool-tip"></span></label></div>			
							<div class="large-5 medium-5 columns place-dropdown-config text left place-select">
								<select name="places"  id="places" class="custom-select"> <!-- dropdown -->
									<option value="0">Find a space, group or project</option>
								<!--<optgroup id="jive-blogs" label="Blogs"></optgroup >-->
									<optgroup id="jive-spaces" label="Spaces"></optgroup >
									<optgroup id="jive-groups" label="Groups"></optgroup >
									<optgroup id="jive-projects" label="Projects"></optgroup >
								</select>
								
								<div class="settings-loading" style="display: none; margin-right: -73px;"></div>	
							</div>
						</div><br><br>
						<div class="large-12 columns items-config places-content-list" style="display:none;">
							<div class="large-3 medium-2 columns config-optional">
								<label class="label-config">Content (optional)</label>
							</div>
							<div class="large-5 medium-5 place-dropdown-config columns text left place-select">
								<select id="place-content-list" name="place-content-list" class="custom-select">
									<option value='0' hidden>All Files & Documents</option>
									<optgroup id="jive-places-files" label="Files"></optgroup >
									<optgroup id="jive-places-documents" label="Documents"></optgroup >									
								</select>
								<span class="has-tip tip-right" id="tooltip" title="Select specific files and/or documents for which you'd like to receive updates. Defaults to all." data-tooltip><img class="tool-tip"></span>
								<div class="items-loading" style="display: none; margin-right: -72px;"></div>
							</div>								
						</div>						
					</div>
					<div class="large-12 columns events-config">
						<div class="large-12 medium-12 columns events">
							<label>Content Notifications for Files and Documents</label>
							<div id="events" class="events-sub">
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="created" name="events" value="created"/><label for="created">Created</label></div>
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="modified" name="events" value="modified"/><label for="modified">Modified</label></div>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="Commented" name="events" value="commented"/><label for="Commented">Commented/Replied</label></div>
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="outcome_set" name="events" value="outcome_set"/><label for="outcome_set">Marked as helpful</label></div>
									<!--<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="liked" name="events" value="liked"/><label for="liked">Liked</label></div>-->
								</div>	
								<!-- <div class="large-12 medium-12 columns"> -->
									<!---<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="outcome_set" name="events" value="outcome_set"/><label for="outcome_set">Marked helpful</label></div>->
									<!--<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="outcome_set" name="events" value="outcome_set"/><label for="outcome_set">Marked helpful</label></div>-->
								<!-- </div> -->
							</div>
						</div>
					</div>
				</div>
				<!--	<div class="row spark-config-block">
					<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
									<option value='0'>Please select a space</option>
								</select>
								<span class="has-tip tip-right" id="tooltip" title="Space in which you'd like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
							</div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>							
						</div>	
					</div>
				</div> -->
				<div class="row spark-config-block">
					<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space
									<span class="has-tip tip-right" id="tooltip" title="Space in which you'd like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
									<option value='0'>Please select a space</option>
								</select>
							</div>
							<div class="spaces-refresh" title="Refresh the spaces"></div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>							
						</div>
					</div>
				</div>
				<div class="row integration-config-block">
					<div class="large-5 medium-5 columns"> &nbsp;</div>
					<div class="large-4 medium-4 columns left">
						<button id="cancel-button" class="button">Cancel</button>
						<button id="submit-button" class="button secondary text">Add Integration</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</body>
</html>