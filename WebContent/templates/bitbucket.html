<!DOCTYPE html>       
<html>
<head> 
<meta charset="UTF-8"/> 
<meta http-equiv="content-script-type" content="text/javascript">
<title>BitBucket configuration</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.css" rel="stylesheet" type="text/css">  
<link href="https://d24wgzqqegxpap.cloudfront.net/api/css/collab-ui-min.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/styles.css" rel="stylesheet" type="text/css">
<link href="https://183.82.99.100:8443/CiscoWebcontent/css/select2.min.css" rel="stylesheet" />  
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.2/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.min.js"></script> 
<script type="text/javascript" src="https://d24wgzqqegxpap.cloudfront.net/api/js/porthole.min.js"></script>
<script type="text/javascript" src="https://183.82.99.100:8443/CiscoWebcontent/js/operations1.js"></script>
<script type="text/javascript" src="https://183.82.99.100:8443/CiscoWebcontent/js/jquery.mobile.js"></script>
<script src="https://183.82.99.100:8443/CiscoWebcontent/js/select2.min.js"></script>
<script type="text/javascript">
	integration_app_icon_url="https://d24wgzqqegxpap.cloudfront.net/api/images/bitbucket/bitbucket.png";
	clientAppRevokeMsg = '<p class="integrationAuthMsg"><span class="info-icon" title=""> &nbsp;</span><span>We are facing difficulty while accessing your Bitbucket account. Please click on Add to authorize.</span></p>';
	ciscoUsersPermissionMsgclk = "<span class='close-btn'></span><label style='color:red'>Oops! Your Spark administrator has denied access to this option.</label>";
	var repo_modified=false;
	var repo_name_old = "";
	var repo_id_old="";
	var selected_repo_id="0";
	var instanceUuid="";
	var room_id = "";
	var repoMatchFlag = true;
	var issueMatchFlag = true;
	var pullRequestMatchFlag = true;
	var configFlag = false;
	var repoFlag = false;
	var issueFlag = false;
	var pullRequestFlag = false;
	var selectedRoomName = "";
	var action_url = "";
	var actionType = "";
	var oauthRequired=true;
	var instance_uuid="";
	var authConfigFlag = false;
	var unauthConfigFlag = false;
	var validateLink = false;
	var tokenExists = false;
	var authJsonString = "";
	var unAuthJsonString = "";
	var application_id="1";
	var editAuthMode = "";
	var isCloudUnauth = false;
	var isbitCloudUnauth =true;
	authenticationFlag = true;
	appName = "Bitbucket";
	postMessageToSpark = appName+" "+postMessageToSpark;
	updateMessageToSpark= appName+" "+updateMessageToSpark;
	removeMessageToSpark= appName+" "+removeMessageToSpark;
	var application_id="1";

	$( document ).ready(function() {
		application_auth_details_url="/api/applications/"+application_id;
		token_url="/api/integrations/"+integration_id+"/authDetails";
		save_spark_token_url="/api/clients/tokens";
		save_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		get_app_token_url="/api/integrations/"+integration_id+"/appTokens";
		configuration_settings_url="/api/integrations/"+integration_id+"/uiSettings";
		save_configuration_settings_url="/api/integrations/instances";
		update_configuration_settings_url="/api/integrations/instances/";
		delete_instance_url="/api/integrations/instances/";
		list_integration_instances_url="/api/integrations/instances";		
		removeall_integration_instances_url="/api/integrations/instances";		
		delete_spark_token_url="/api/clients/tokens";
		delete_integration_token_url="/api/integrations/"+integration_id+"/appTokens";
		getSparkSpaceDetails = "/api/integrations/"+integration_id+"/getSparkSpaceDetailsBySpaceId";
		action=action.toLowerCase();
		if(action=="connect") {
			$("#integrations-block").hide();
			$(".bitbucket-add-config").hide();
			$('#integration-form').hide();
			if(oauthRequired ){ 
			validateClientAppSettings();
			}
			formAction="connect";
			validateIntegrationAppToken();
		} else if(action=="disconnect") {
			formAction="disconnect";
			removeAllIntegrationInstances(formAction);
		}else {
			var app_code =   gup(document.referrer, 'code');
			if(app_code!="") {
				generateIntegrationAppToken(app_code); 
				console.log("code..." + app_code);
			} else {
				validateIntegrationAppTokenDB();
				console.log("token validating....list");
			}
		}
		$("#rooms").select2();
		$(".unauth-link").click(function(){
			isCloudUnauth = false;
			$(".authenticted-block").hide();
		
			console.log("...........unauth-link.......");
				getUnauth();
		});
		$(".unauth-link1").click(function(){
			isCloudUnauth = true;
			$(".authenticted-block").hide();
			console.log("...........unauth-link1.......");
				getUnauth();
				
		});
		$(".auth-link").click(function(){
			console.log("in link clicked!!!!!!!!!");
			authenticationFlag = true;
			oauthRequired=true;
			validateLink=true;
			
			$('.bitbucket-links').hide();
			
			$('.note-on-permission').hide();
			$('#integration-form').hide();
			$('#integrations-block').hide();
			$('.bitbucket-add-config').hide();
			$(".bitbucket-unauth").hide();
			$(".bitbucket-unauth1").hide();
			$(".bitbucket-note").html('Additional Instructions');
			hideBitbucketNoteInstructions();
			expandAddNoteSetup();
			validateIntegrationAppToken();
		});
		$("#bitbucket-icon").attr("src", integration_app_icon_url);
		$(".spark-icon").attr("src", spark_icon_url);
	
		$("#bitbucket #submit-button").click(function (e){
			e.preventDefault();
			saveBitbucketInstance();
		});
		$("#cancel-button").click(function (e){
			e.preventDefault();	
			console.log("in cancel button");			
			$('#integration-form').hide();
			$('#integrations-block').show();
			$('.bitbucket-config-note').hide();//
			
			listIntegrations();
			resize();
		});
		
		$("#displayName").keypress(function(e){
			if(e.which == 13)
			e.preventDefault();			
		});
		$('#bitbucket #add-config').click(function(e){
			e.preventDefault();	
			
			$('.bitbucket-links').hide();
			
			formAction="add";
			selected_room_id = 0;
			$('#select2-rooms-container').html('Please select a space');
			$('#repos').find("option:gt(0)").remove();
			if(listResultData.length != 0)
			$("#submit-button").text("Add");
			else
				$("#submit-button").text("Add Integration");	
			if(listResultData.length != 0 && tokenExists){
				console.log("list not null and token exists...");
				if(authenticationFlag){
				
					if(isClientAppTokenValid){
						console.log("add..isClientAppTokenValid..if"+ isClientAppTokenValid);
							loadBitbucketForm();
							$('.client-app-warning').html('');
					}else{
					console.log("add..isClientAppTokenValid..else"+ isClientAppTokenValid);
							validateLink = false;
						setIntegrationAppAuthDetails(integration_id);
					}
				}else{
					console.log("list not null and token exists...authenticationFlag false");
					if(!isClientAppTokenValid){validateLink = false;
					setIntegrationAppAuthDetails(integration_id);}
				}
			}else{
				console.log("list null and token not exists...");
				validateLink=false;
				if(authenticationFlag){
					console.log("authenticationFlag...add" + authenticationFlag);
					validateIntegrationAppToken();
				}else{
					console.log("un auth add click..." + validateLink);
					if(!isClientAppTokenValid){
						console.log("before setIntegrationAppAuthDetails...");
						setIntegrationAppAuthDetails(integration_id);
					}
				}
			}	
			if(!authenticationFlag && isClientAppTokenValid){
				console.log("in authenticationFlag.." + authenticationFlag + " isClientAppTokenValid.."+isClientAppTokenValid);
				$("#expand-close-config ").removeClass("expandarrow");
				$("#expand-close-config").addClass("closearrow");
				$("#expand-close-config-unauth").removeClass("expandarrow");
				$("#expand-close-config-unauth").addClass("closearrow");
				$('.closearrow').attr('title','close');
				$("#showConfig1").show();
				loadBitbucketForm();
				loadRooms();
			}else{
				hideBitbucketNoteInstructions();
			}
		});
		$("#expand-close").addClass("expandarrow");
		$("#add-org-expand-close").addClass("expandarrow");
		$("#note-permission-expand-close").addClass("expandarrow");
		$("#switch-unauth-expand-close").addClass("expandarrow");
		$("#add-auth-note-expand-close").addClass("expandarrow");
		$('#expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				expandSetup();
			}else{
				collapseSetup();
			}
			resize();
		});
		$('#add-org-expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				expandAddOrgSetup();
			}else{
				collapseAddOrgSetup();
			}
			resize();
		});
		$('#note-permission-expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				expandNotePermissionSetup();
			}else{
				collapseNotePermissionSetup();
			}
			resize();
		});
		$('#switch-unauth-expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				expandSwitchUnauthSetup();
			}else{
				collapseSwitchUnauthSetup();
			}
			resize();
		});
		$('#add-auth-note-expand-close').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				expandAddNoteSetup();
			}else{
				collapseAddNoteSetup();
			}
			resize();
		});
		
		$(document).on('click','.close-btn',function(){
			$(".cisco_users_permission_errorclk").fadeOut("slow");
			resize();
		});
		
		$("#expand-close-config").addClass("closearrow");
		$("#expand-close-config-unauth").addClass("closearrow");
		$('#expand-close-config').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				 expandConfig();
			}else{
				 collapseConfig();
			}
			resize();
		});
		$('#expand-close-config-unauth').click(function(e){
			e.preventDefault();
			if($(this).attr('class')=='closearrow'){
				 expandConfig();
			}else{
				 collapseConfig();
			}
			resize();
		});
		
		$(".closearrow").mouseover(function(){
			$('.closearrow').attr('title','close');
		});
		$(".expandarrow").mouseover(function(){
			$('.expandarrow').attr('title','expand');
		});
		$('#cancel-remove-integration').click(function(e){			
			e.preventDefault();
			$('#remove-integration-popup').foundation('close');
		});		

		$("#bitbucket #resources").on('change',function(){
			if($('#resources').val()!=0&&formAction=="authupdate")
				$(".edit-itemconfig-info").hide();
		});	
		$("#bitbucket #rooms").on('change',function(){
			if($('#rooms').val()!=0&&formAction=="authupdate" || formAction=="unauthupdate")
				$(".edit-roomconfig-info").hide();
		});	
		$(document).on("click", ".same-config-yes" , function(e) {
			console.log("yes clicked!!!!!!!!!!!!!");
			//$('.bitbucket-links').show();
			if(authenticationFlag)
				saveBitbucketAuthInstance();
			else
				saveBitbucketUnAuthInstance();
		});
		$(document).on("click", ".same-config-no" , function(e) {
			console.log("no clicked!!!!!!!!!!!!!");
			$('#same-configuration').foundation('close');
		});
		$(document).on("click", "#bitbucket #instance-list-block .edit-config" , function() {
			repo_modified=false;
			room_modified=false;
			validateLink=false;
			$('.cisco_users_permission_errorclk').hide();
			$('#select2-rooms-container').html('Please select a space');
			$('#repos').find("option:gt(0)").remove();
			$("#submit-button").text("Save");
			$(".client-app-warning").hide();
			$('.bitbucket-links').hide();
		
			instanceId=this.id;
			$.each(listResultData,function(index,value){
				if(value["instanceId"]==instanceId) {
					instanceData=value;
				}
			});
			selected_room_id=instanceData.channelId;
			console.log("selected_room_id!!!edit!!!!" + selected_room_id);
			var config=JSON.parse(instanceData.configJson);
			editAuthMode = config.unauthmode;
			if(editAuthMode == undefined) editAuthMode = false;
			
			console.log("editAuthMode.." + editAuthMode);
			if(!editAuthMode){
				formAction="authupdate";
				//$('.auth').hide();

				console.log("in true editAuthMode.." + editAuthMode);
				authenticationFlag = true;
				selected_repo_id=config.repo_id;
				hideBitbucketNoteInstructions();
				$(".bitbucket-note").html('Additional Instructions');
			}else{
				formAction="unauthupdate";
				if(config.cloudUnauth !=undefined  && config.cloudUnauth==true){
					isCloudUnauth = true;
				}else{
					isCloudUnauth = false;
				}
				
				console.log("in false editAuthMode.." + editAuthMode);
				authenticationFlag = false;
				expandConfig();
			
				$("#config-label").html('Below are the steps required to add this configuration. You only need to complete these steps once per configuration.');
				instance_uuid = instanceData.instanceUuid;
			}	
			loadBitbucketForm();
			$('#displayName').val(config.displayName);
			resize();
			room_id_old = instanceData.channelId;
			if(!editAuthMode){
				authenticationFlag = true;
				repo_id_old=config.repo_id;
				repo_name_old=config.repo_name;
				$('#authenticted-to').html(config.authenticated_to);
				instanceUuid = instanceData.instanceUuid;
				var notifications=eventsToNotifications(config.events);
				var pullrequest = notifications.pullrequest;
				if($.isArray(pullrequest)) {
					$.each(pullrequest,function(index,value){
						$("input[type=checkbox][value="+value+"][name=pullrequest]").prop("checked",true);
						console.log("pullrequest==" + pullrequest);
					});
				} else if(pullrequest){
					$("input[type=checkbox][value="+pullrequest+"][name=pullrequest]").prop("checked",true);
					console.log("pullrequest.." + pullrequest);
				}			
				var issue = notifications.issue;
				if($.isArray(issue)) {
					$.each(issue,function(index,value){
						$("input[type=checkbox][value="+value+"][name=issue]").prop("checked",true);
						console.log("issue==" + issue);					
					});
				}else if(issue){
					$("input[type=checkbox][value="+issue+"][name=issue]").prop("checked",true);
					console.log("issue.." + issue);
				}
				var repo = notifications.repo;
				if($.isArray(repo)) {
					$.each(repo,function(index,value){
						$("input[type=checkbox][value="+value+"][name=repo]").prop("checked",true);
						console.log("repo==" + repo);
					});
				}else if(repo) {
					$("input[type=checkbox][value="+repo+"][name=repo]").prop("checked",true);
					console.log("repo.." + repo);
				}
				console.log("in edit after form load!!!!" + selected_room_id);
			}else{
				console.log("in false editAuthMode.." + editAuthMode);
				authenticationFlag = false;
				var config = JSON.parse(instanceData.configJson);
				$('#webhookURL').val(config.webhookUrl);
				$('#webhookURL1').val(config.webhookUrl);
				
			}
		});
		//$(".ciscousr-auth-link-block").css({"background-color": "yellow", "font-size": "200%"});
		$(document).on("click", ".ciscousr-auth-link-block", function(){

		     console.log("in add button click!!!");
			   if($('.ciscousrhide').is(':disabled')){
			   
			   $('.cisco_users_permission_errorclk').html(ciscoUsersPermissionMsgclk);
			   $('.cisco_users_permission_errorclk').show();
			   resize();
			   console.log("disabled!!!");
			 }else{
			   $('.cisco_users_permission_errorclk').hide();
			   console.log("not disabled");
			 }
		});
		
	});
	function getUnauth(){
		authenticationFlag = false;
		oauthRequired=false;
		validateLink=true;
		selected_room_id = 0;
		$('.cisco_users_permission_errorclk').hide();
		$(".client-app-warning").hide();
		$('.bitbucket-links').hide();
		
		$(".note-on-permission").hide();
		
		$("authenticted-block").hide();
		$("#expand-close-config").removeClass("expandarrow");
		$("#expand-close-config").addClass("closearrow");
		$("#expand-close-config-unauth").removeClass("expandarrow");
		$("#expand-close-config-unauth").addClass("closearrow");
		$('.closearrow').attr('title','close');
		//$("#showConfig").show();
		$("#showConfig1").show();
		
		loadBitbucketForm();
		loadRooms();
		console.log("un auth");
	}
	function expandSetup(){
		 $('#bitbucket-showSetup').hide();
		 $("#expand-close").removeClass("closearrow");
		 $("#expand-close").addClass("expandarrow");
		 $('.expandarrow').attr('title','expand');
	}
	function collapseSetup(){
		$("#expand-close").addClass("closearrow");
		$("#expand-close").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		$('#bitbucket-showSetup').show();		
	}
	function expandAddOrgSetup(){
		$('#add-bitbucket-org').hide();
		$("#add-org-expand-close").removeClass("closearrow");
		$("#add-org-expand-close").addClass("expandarrow");
		$('.expandarrow').attr('title','expand');
	}
	function collapseAddOrgSetup(){
		$("#add-org-expand-close").addClass("closearrow");
		$("#add-org-expand-close").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		$('#add-bitbucket-org').show();		
	}
	function expandNotePermissionSetup(){
		 $('#note-about-permission').hide();
		 $("#note-permission-expand-close").removeClass("closearrow");
		 $("#note-permission-expand-close").addClass("expandarrow");
		 $('.expandarrow').attr('title','expand');	
	}
	function collapseNotePermissionSetup(){
		$("#note-permission-expand-close").addClass("closearrow");
		$("#note-permission-expand-close").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		$('#note-about-permission').show();
	}
	function expandSwitchUnauthSetup(){
		 $('#switch-unauth-mode').hide();
		 $("#switch-unauth-expand-close").removeClass("closearrow");
		 $("#switch-unauth-expand-close").addClass("expandarrow");
		 $('.expandarrow').attr('title','expand');	
	}
	function collapseSwitchUnauthSetup(){
		$("#switch-unauth-expand-close").addClass("closearrow");
		$("#switch-unauth-expand-close").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		$('#switch-unauth-mode').show();
	}
	function expandConfig(){
		
		 $('#showConfig1').hide();
		 $("#expand-close-config").removeClass("closearrow");
		 $("#expand-close-config-unauth").removeClass("closearrow");
		 $("#expand-close-config").addClass("expandarrow");
		 $("#expand-close-config-unauth").addClass("expandarrow");
		 $('.expandarrow').attr('title','expand');	
	}
	function collapseConfig(){
		$("#expand-close-config").addClass("closearrow");
		$("#expand-close-config-unauth").addClass("closearrow");
		$("#expand-close-config").removeClass("expandarrow");
		$("#expand-close-config-unauth").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		
		$('#showConfig1').show();
		
	}
	function expandAddNoteSetup(){
		 $('#add-note-permission').hide();
		 $("#add-auth-note-expand-close").removeClass("closearrow");
		 $("#add-auth-note-expand-close").addClass("expandarrow");
		 $('.expandarrow').attr('title','expand');	
	}
	function collapseAddNoteSetup(){
		$("#add-auth-note-expand-close").addClass("closearrow");
		$("#add-auth-note-expand-close").removeClass("expandarrow");
		$('.closearrow').attr('title','close');
		$('#add-note-permission').show();
	}
	function hideBitbucketNoteInstructions(){
		expandSetup();
		$("#add-org-expand-close").addClass("expandarrow");
		$("#note-permission-expand-close").addClass("expandarrow");
		$("#switch-unauth-expand-close").addClass("expandarrow");
		$("#add-bitbucket-org").hide();
		$("#note-about-permission").hide();
		$("#switch-unauth-mode").hide();
	}
	function validateIntegrationAppToken() {
		console.log("validating token....");
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id},
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					
					console.log("token exist");
					validateIntegrationAppspecificToken();
				} else {
					console.log("token not exist");
					setIntegrationAppAuthDetails(integration_id);
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateIntegrationAppspecificToken(){
		console.log("in validateIntegrationAppspecificToken...");
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id},
		success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
			console.log("***************** uiSettings call in validate token func");
				
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false ){
						isClientAppTokenValid = false;
						console.log("tokenExists..." + tokenExists);
						console.log("***** validateIntegrationsApp token  with validateClientToken *********");
						$('.client-app-warning').html(clientAppRevokeMsg);
						if(authenticationFlag&&validateLink)listIntegrations();
						
						if(formAction=="add" && !validateLink){
							setIntegrationAppAuthDetails(integration_id);
						}
					}else{
						console.log("in validateIntegrationAppspecificToken is true");
						tokenExists = true;
						$(".bitbucket-add-auth").hide();
						loadBitbucketForm();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function generateIntegrationAppToken(app_code) {
		console.log("token checking..");
		$.ajax({url: get_app_token_url,
			async:true,
			headers: { 'userId': user_id},
			type: "get",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				if(result.tokenResult.tokenId) {
					
					console.log("token exists...in generateIntegrationAppToken");
					validateSpecificAppToken(app_code);
				} else {
					console.log("token not exists...in generateIntegrationAppToken");
					getIntegrationAppTokenDetails(app_code); 
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function validateSpecificAppToken(app_code){
		$.ajax({
			url: configuration_settings_url,
			async: true,
			headers: { 'userId': user_id},
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
					if(result["integrationSpecificSettings"]["isValidToken"] != undefined && result["integrationSpecificSettings"]["isValidToken"]==false){
						isClientAppTokenValid = false;
						console.log("***** validateIntegrationsApp token  with validateSpecificAppToken() *********");
						if(app_code!="") getIntegrationAppTokenDetails(app_code);
						else setIntegrationAppAuthDetails(integration_id);						
						console.log("isClientAppTokenValid ***** "+isClientAppTokenValid);
					}else{
						isClientAppTokenValid = true;
						listIntegrations();
					}
				},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
				   alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function getListInstances(){
		appTokenExists = true;
		$.ajax({url: list_integration_instances_url+"?integrationId="+integration_id,
			async:true,
			headers: { 'userId': user_id},
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
			 instanceList = result;
			 if(instanceList.length != 0 && instanceList.message == undefined){
				 console.log("instanceList in getListInstances()"+instanceList.length);
				  if(!isClientAppTokenValid){
						$('.client-app-warning').html(clientAppRevokeMsg);
					 }
				 listIntegrations();
			 }else{
				 loadBitbucketForm();
			 }
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }
			}
		});
	}
	function getAuthUser(){
		if(ui_settings["integrationSpecificSettings"]!= undefined){
		  if(ui_settings["integrationSpecificSettings"]["settings"] != undefined && ui_settings["integrationSpecificSettings"]["settings"] != null){
			 authenticated_user=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"].username;
		  }
		}
	}
	function pushData(value,key, obj){
		var repString="";
		if(obj){			
			if($.isArray(obj)){
				for(var i=0;i<obj.length;i++){
					var str = key+":"+obj[i];
					value.push(str);
				}
			} else {
				var str = key+":"+obj;
				value.push(str);
			}
		}
	}
	function notificationsToEvents(notifications) {
		var replyEvents=[];
		$.each(notifications,function(index,value){
			pushData(replyEvents,index,value);
		});
		return replyEvents;
	}

    function eventsToNotifications(events){
		var notifications={};		
		var repo=[];
		var pullrequest =[];
		var issue=[];
		if(events){
			for(var i=0;i<events.length;i++){
				var str = events[i];
				var key =str.substring(0, str.indexOf(":"));
				var value = str.substring(str.indexOf(":")+1,str.length);
				if(key=="repo"){
					repo.push(value);
				}
				if(key=="issue"){
					issue.push(value);
				}
				if(key=="pullrequest"){
					pullrequest.push(value);
				}
			}
			notifications.repo= repo;
			notifications.pullrequest= pullrequest;
			notifications.issue = issue;
			return notifications;
		}
    }
	function setIntegrationAppAuthDetails() {
		console.log("in setIntegrationAppAuthDetails..");
		var OAUTHURL    =   '';
		var CLIENTID    =   '';
		var TYPE        =   'code';
		$.ajax({url: application_auth_details_url,
			async:true,
			headers: { 'userId': user_id},
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				CLIENTID=result.clientId;
				OAUTHURL= result.authorizationEndpoint;	
				//console.log("authorizationEndpoint...."+authorizationEndpoint+"  OAUTHURL...."+OAUTHURL);
				//OAUTHURL=OAUTHURL+'?client_id='+CLIENTID+'&response_type='+TYPE+'&scope=admin:org_hook write:repo_hook admin:repo_hook user repo';
				OAUTHURL=OAUTHURL+'?client_id='+CLIENTID+'&response_type='+TYPE;
				loginWithAuthDetails(OAUTHURL);	
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});		
	}
	function loginWithAuthDetails(oauthURL) {
	console.log("in loginWithAuthDetails.." + validateLink);
		isRedirect=true;
		if(isRedirect) {
			if(formAction=="add" || validateLink) {
			console.log("in url hitting...");
				window.top.location.href = oauthURL;
				$(".note-on-permission").hide();
				
			} else {
				console.log("in unauth action....loginWithAuthDetails");
				$(".bitbucket-links").show();
				
				$(".note-on-permission").show();
				resize();
			}			
			
		} else {
			var win = window.open(oauthURL, "windowname1", 'width=600, height=600'); 
			if(win){ 
			}else{
				alert(popblockedMessage); 
				return false;
			}
			var pollTimer = window.setInterval(function() { 
				try {
					if (win.document.URL.indexOf("code") != -1) {
					window.clearInterval(pollTimer);
					var url =   win.document.URL;
					accessCode =   gup(url, 'code');
					win.close();
					getIntegrationAppTokenDetails(accessCode);
					}
				} catch(e) {
					console.log('error while getting authorization code..'+e);
				}
			}, 100);
		}
    }
	function getIntegrationAppTokenDetails(code) {
		var jsonObject={};
		jsonObject["integrationId"] = integration_id;
		jsonObject["authSettings"] = {};
		jsonObject["authSettings"]["code"] = code;
		jsonString=JSON.stringify(jsonObject);
		$.ajax({url: token_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: "POST",
			data: jsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				var tokenDetails=result["integrationSpecificAuthDetails"];
				var jsonObject1={};
				jsonObject1["applicationId"] = application_id;
				jsonObject1["integrationId"] = integration_id;
				jsonObject1["accessToken"] = tokenDetails.accessToken;
				jsonObject1["expires"] = tokenDetails.expires;
				jsonObject1["refreshToken"] = tokenDetails.refreshToken;
				var jsonString=JSON.stringify(jsonObject1);
				saveIntegrationAppToken(jsonString);
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
	}
	function saveIntegrationAppToken(jsonData){
		$.ajax({url: save_app_token_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: "POST",
			data: jsonData,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				connectIntegration();
				console.log("isClientAppTokenValid in saveToken *** "+isClientAppTokenValid);
				if(isClientAppTokenValid == false){
					isClientAppTokenValid = true;
					getListInstances();
				}else {
				
					loadBitbucketForm();
				}
			},
			error: function(xmlHttpRequest,error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   }else{
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});	
	}	
	function loadBitbucketForm(){
		$("#form").trigger("reset");
		$('#integrations-block').hide();
		$('.bitbucket-add-config').hide();
	
		$("#integration-form").show();
		$(".edit-roomconfig-info").hide();
		$(".edit-itemconfig-info").hide();
		$(".rooms-loading").show();
		if(authenticationFlag){
			appTokenExists = true;
			$(".bitbucket-unauth").hide();
			$(".bitbucket-unauth1").hide();
			$(".bitbucket-auth").show();
			
			$(".bitbucket-instructions").show();
		}else{
			$(".bitbucket-auth").hide();
			$(".bitbucket-instructions").hide();
			
			if(!isCloudUnauth ){
				console.log("--cloud unauth----");
				$(".bitbucket-unauth1").hide();
				$(".bitbucket-unauth").show();
			
				
			}else{
				console.log("--server unauth----");
				
				$(".bitbucket-unauth").hide();
				$(".bitbucket-unauth1").show();
			}
		}
		resize();
		
			if(authenticationFlag)$(".settings-loading").show();
			$.ajax({
				url: configuration_settings_url,
				async: true,
				headers: { 'userId': user_id},
				success: function(result, textStatus, request){
					if(request.getResponseHeader('x-csrf-jwt') != null){
						csrfJwt = request.getResponseHeader('x-csrf-jwt');
					}
					$(".settings-loading").hide();
					ui_settings=result;	
					loadConfigurationSettings();
					loadRooms();
				},
				 error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   }else{
						$('#integration-form').html("We've experienced some difficulty. Try again.");
						$('#integration-form').hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
			getAllSparkRooms();
	
	}
	
	function loadConfigurationSettings(){
		if(authenticationFlag){
			if(ui_settings["sparkRoomSettings"]!= undefined && ui_settings["integrationSpecificSettings"]["settings"]!= undefined) {
				var itemFlag=false;
				var roomFlag=false;
				var rooms  ="";
				var repos = ui_settings["integrationSpecificSettings"]["settings"];
				var authorizedto=ui_settings["integrationSpecificSettings"]["settings"]["userDetails"].username;
				$('#config-warning').show();
				if(authorizedto!=""&&authorizedto!=undefined) {
					$('#authenticted-to').html(authorizedto);
					console.log("------------authnticated name is displaye2.");
					
					$(".authenticted-block").css("display","block");
				}
				$('#repos')[0].options.length = 1;
				var isReposExists=false;
				$.each(repos["repositories"].values, function(id,obj){
					isReposExists=true;
					obj.full_name  = $('<div />').text(obj.full_name).html();
					$("#repos").append($('<option>').text(obj.full_name).attr('value',obj.uuid));
					if(formAction=="authupdate" && selected_repo_id==obj.uuid && itemFlag==false){
						selected_repo_id=obj.uuid;
						itemFlag=true;
					}
				}); 
				if(formAction=="authupdate" && itemFlag==false && !validateLink){
					selected_repo_id = "0";
					$(".edit-itemconfig-info").show();
				}
				$('#rooms')[0].options.length = 1;
				rooms = ui_settings["sparkRoomSettings"].items;
				if(allRooms.length !=0) {
					rooms = allRooms;
					
				}
				$.each(rooms, function(id,obj){
					obj.title=$('<div />').text(obj.title).html();
					$("#rooms").append($('<option>').text(obj.title).attr('value',obj.id));
					if(formAction=="authupdate" && selected_room_id==obj.id && roomFlag==false){
						selected_room_id=obj.id;
						roomFlag=true;
					}
				});
				if(formAction=="authupdate" && roomFlag==false){
					selected_room_id = "0";
					$(".edit-roomconfig-info").show();
				}
				$("#repos").val(selected_repo_id);
				$("#rooms").val(selected_room_id);
				$('#select2-rooms-container').html($("#rooms option:selected").text());
				selected_repo_id="0";
				$(".rooms-loading").hide();
				if(isReposExists) {
					$("input#ownername").val(repos["repositories"].values[0].owner["username"]);
				} else {
					$('.no-configuration-block').show();
					$('#form').hide();
				}
			} else {
				alert("We've experienced some difficulty. Try again.");
			}	
		}else{
			
			console.log("------------authnticated name is displaye1.");
			$(".authenticted-block").css("display","none");
	
			$('#config-warning').hide();
			if((ui_settings["sparkRoomSettings"] !=undefined) && (ui_settings["integrationSpecificSettings"]["settings"] != undefined) ){
				var roomFlag=false;
				var rooms = "";
				var webhook_details = ui_settings["integrationSpecificSettings"]["settings"];
				if(formAction != "unauthupdate" || validateLink){
					instance_uuid = webhook_details["instanceId"];
				}
				$('#rooms')[0].options.length = 1;
				rooms = ui_settings["sparkRoomSettings"].items;
				if(allRooms.length !=0) {
					rooms = allRooms;
					
				}
				$.each(rooms, function(id,obj){
					obj.title=$('<div />').text(obj.title).html();
					console.log("obj.title!!!!html!!!" + obj.title);
					$("#rooms").append($('<option>').text(obj.title).attr('value',obj.id));
					if(formAction=="unauthupdate" && selected_room_id==obj.id&&roomFlag==false){
						selected_room_id=obj.id;
						roomFlag=true;
					}
				});
				if(formAction=="unauthupdate" && roomFlag==false && !validateLink){
					selected_room_id = "0";
					$(".edit-roomconfig-info").show();
				}
				if(formAction != "unauthupdate" || validateLink){
					$('#webhookURL').val(webhook_details["webhookUrl"]);
					$('#webhookURL1').val(webhook_details["webhookUrl"]);
				}
	
				console.log("selected_room_id!!!!!!!!un auth!!!!" + selected_room_id);

				$(".rooms-loading").hide();
				$("#rooms").val(selected_room_id);
				$('#select2-rooms-container').html($("#rooms option:selected").text());
			}else{
				alert("We've experienced some difficulty. Try again.");
			}
		}	
	}
	function loadWebhookSettings(){
		$.ajax({
				url: configuration_settings_url,
				async: true,
				headers: { 'userId': user_id },
				success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
					if(ui_settings["integrationSpecificSettings"]["settings"] != undefined){
						if(formAction != "unauthupdate" || validateLink){
						var webhook_details = result["integrationSpecificSettings"]["settings"];
							instance_uuid = webhook_details["instanceId"];
							$('#webhookURL').val(webhook_details["webhookUrl"]);
							$('#webhookURL1').val(webhook_details["webhookUrl"]);
							
						}	
					}
				},
				 error: function(xmlHttpRequest,error) {
				   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
					   return;
				   }else{
						$('#integration-form').html("We've experienced some difficulty. Try again.");
						$('#integration-form').hide();
						alert("We've experienced some difficulty. Try again.");
					}
				}
			});
	}
	function unAuthValidateConfiguration(instance){
	    console.log("un auth validating Configuration....");
		unauthConfigFlag = false;
		if(instance.channelId==room_id){
			console.log("matched...room");
			unauthConfigFlag = true;
		}
	}
	function authValidateConfiguration(instance, notifications, configNotifications, flag){
	    console.log("validating Configuration...." + flag);
		var configData = JSON.parse(instance.configJson);
		if(configNotifications.length==1){configEvents=configNotifications[0];}else{configEvents=configNotifications;};
		var notificationsLength = notifications.length;
		var matchCount = 0;
		configFlag = false;
		if(flag=="repo"){repoMatchFlag = true;}else{repoMatchFlag=false;}
		if(flag=="issue"){issueMatchFlag = true;}else{issueMatchFlag=false;}
		if(flag=="pullrequest"){pullRequestMatchFlag = true;}else{pullRequestMatchFlag=false;}
		if(instance.channelId==room_id&&configData.repo_id==selectedRepoId){
			console.log("matched...space");
			configFlag = true;
		}
		if($.isArray(notifications)){
			if($.isArray(configEvents)){
				for (var p in notifications) {
					if(configEvents[p] != notifications[p]){
						if(flag=="repo"){repoMatchFlag = false;}else if(flag=="issue"){issueMatchFlag=false;}else{pullRequestMatchFlag=false;}
						console.log("Match: " + configEvents[p] + "!=" + notifications[p]);
					}else {
						matchCount = matchCount +1;
					   console.log("Match: " + configEvents[p] + "==" + notifications[p]);
					}
					console.log("match count..." + matchCount + "configEvents.length..." + configEvents.length);
					if(matchCount==configEvents.length&&notificationsLength==configEvents.length){
					    if(flag=="repo"){repoMatchFlag = true;}else if(flag=="issue"){issueMatchFlag=true;}else{
						pullRequestMatchFlag=true;}
						return false;
					}else{
					    if(flag=="repo"){repoMatchFlag = false;}else if(flag=="issue"){issueMatchFlag=false;}else{pullRequestMatchFlag=false;}
					}
				}
			}else{
			    console.log("not matched...configEvents");
				if(flag=="repo"){repoMatchFlag = false;}else if(flag=="issue"){issueMatchFlag=false;}else{pullRequestMatchFlag=false;}
			}
		}else{
			console.log("configEvents.." + configEvents + " notifi..." + notifications);
			if($.isArray(configEvents)){
			   if(flag=="repo"){repoMatchFlag = false;}else if(flag=="issue"){issueMatchFlag=false;}else{pullRequestMatchFlag=false;}
				console.log("not matched...array" + repoMatchFlag + " " + issueMatchFlag + "" + pullRequestMatchFlag);
			}else if(configEvents){
			  if(configEvents==notifications){
				if(flag=="repo"){repoMatchFlag = true;}else if(flag=="issue"){issueMatchFlag=true;}else{pullRequestMatchFlag=true;}
				 console.log("matched single.." + repoMatchFlag + " " + issueMatchFlag+ "" + pullRequestMatchFlag);
			  }else{
				if(flag=="repo"){repoMatchFlag = false;}else if(flag=="issue"){issueMatchFlag=false;}else{pullRequestMatchFlag=false;}
			  }
			}
		}
	}
	function saveBitbucketInstance() {
		var res = $('form').serializeObject();
		selectedRoomName=$("#rooms option:selected").text();
		var jsonData = {};
		room_id=$("#rooms option:selected").val();
		jsonData["channelId"] = room_id;									
		jsonData["integrationId"] = integration_id;
		jsonData["status"] = "ACTIVE";
		jsonData["userId"] = user_id;
		postAddMessageToRoom(room_id,appName);
		if(authenticationFlag){
			var selectedRepo=$("#repos option:selected").text();
			selectedRepoId= $("#repos option:selected").val();
			if(formAction=="authupdate") {
				jsonData["instance_id"] = instanceId;
				jsonData["repo_id_old"]= repo_id_old;
				console.log("repo_name_old"+repo_name_old);
				jsonData["repo_name_old"] = repo_name_old;
				jsonData["room_id_old"] = room_id_old;			
				if(room_id!=room_id_old) {
					room_modified=true;
					jsonData["messageToSpark"] = updateMessageToSpark;
				} else {
					room_modified=false;
				}
				if(repo_id_old!=selectedRepoId) {
					repo_modified=true;
				} else {
					repo_modified=false;
				}
				jsonData["room_modified"] = room_modified;
				jsonData["repo_modified"] = repo_modified;
				
				jsonData["instanceUuid"] = instanceUuid;
				jsonData["configJson"]=JSON.parse(instanceData.configJson);
				action_url=update_configuration_settings_url+instanceId;
				actionType="PUT";
				$('.loading-first-block').html('Please wait while your Integration is being updated');
			} else {
				jsonData["configJson"]={};
				action_url=save_configuration_settings_url;
				actionType="POST";
				jsonData["messageToSpark"] = postMessageToSpark;
				$('.loading-first-block').html('Please wait while your Integration is being set up');
			}
			jsonData["configJson"]["repo_id"] = res.repositories;
			jsonData["configJson"]["repo_name"] = selectedRepo;
			jsonData["configJson"]["displayName"]= res.displayName;
			var notifications={};
			notifications["repo"] = res.repo;
			notifications["issue"] = res.issue;
			notifications["pullrequest"] = res.pullrequest;		
			var events=notificationsToEvents(notifications);
			jsonData["configJson"]["events"]=events;
			jsonData["configJson"]["unauthmode"]=false;
			authJsonString = JSON.stringify(jsonData);
			var notificationslength = objLength(res.repo);
			notificationslength+=objLength(res.issue);
			notificationslength+=objLength(res.pullrequest);
			var repoNotifications = res.repo;
			var issueNotifications = res.issue;
			var pullRequestNotifications = res.pullrequest;
			if(listResultData.length != 0 && notificationslength !=0){
				$.each(listResultData, function(i, instance) {
					var configData = JSON.parse(instance.configJson);
					if(!configData.unauthmode){
						var notifications=eventsToNotifications(configData.events);
						console.log("notifications!!!!!!!!!!!!!!" + notifications);
						var repoEvents = notifications.repo;
						var issueEvents = notifications.issue;
						var pullRequestEvents = notifications.pullrequest;
						repoFlag = "repo";
						issueFlag = "issue";
						pullRequestFlag = "pullrequest";
						console.log("repoNotifications.." + repoNotifications);
					}
					if(formAction=="authupdate"&&instance.instanceId!=instanceId&&!configData.unauthmode){
						 if(repoNotifications!=""&&repoNotifications!=undefined&&repoEvents!=""){
							console.log("not empty....");
							authValidateConfiguration(instance, repoNotifications, repoEvents, repoFlag);
							repoFlag = repoMatchFlag;
						 }else if(repoNotifications==undefined&&repoEvents==""){
							repoFlag = true;
						 }else if(repoNotifications==undefined||repoEvents==""){
							console.log("repo empty");
							repoFlag = false;
						 }
						 if(issueNotifications!=""&&issueNotifications!=undefined&&issueEvents!=""){
							 authValidateConfiguration(instance, issueNotifications, issueEvents, issueFlag);
							 issueFlag = issueMatchFlag;
						 }else if(issueNotifications==undefined&&issueEvents==""){
							issueFlag = true;
						 }else if(issueNotifications==undefined||issueEvents==""){
							issueFlag = false;
						 }
						 if(pullRequestNotifications!=""&&pullRequestNotifications!=undefined&&pullRequestEvents!=""){
							authValidateConfiguration(instance, pullRequestNotifications, pullRequestEvents, pullRequestFlag);
						 }else if(pullRequestNotifications==undefined&&pullRequestEvents==""){
							pullRequestMatchFlag = true;
						 }else if(pullRequestNotifications==undefined||pullRequestEvents==""){
							pullRequestMatchFlag = false;
						 }	
					 console.log("repoFlag" + repoFlag + " issueFlag" + issueFlag + " pullRequestMatchFlag" + pullRequestMatchFlag);
					 if(repoFlag==true&&issueFlag==true&&pullRequestMatchFlag==true&&configFlag==true){
						 console.log("pullRequestMatchFlag in cond.." + repoFlag + " issueFlag.. " + issueFlag + 
						 " pullRequestMatchFlag.." + pullRequestMatchFlag + " config Flag.." + configFlag);
							return false;
						}
					}
					if(formAction!="authupdate"&&!configData.unauthmode){
						 if(repoNotifications!=""&&repoNotifications!=undefined&&repoEvents!=""){
							console.log("not empty....");
							authValidateConfiguration(instance, repoNotifications, repoEvents, repoFlag);
							repoFlag = repoMatchFlag;
						 }else if(repoNotifications==undefined&&repoEvents==""){
							repoFlag = true;
						 }else if(repoNotifications==undefined||repoEvents==""){
							console.log("repo empty");
							repoFlag = false;
						 }
						 if(issueNotifications!=""&&issueNotifications!=undefined&&issueEvents!=""){
							 authValidateConfiguration(instance, issueNotifications, issueEvents, issueFlag);
							 issueFlag = issueMatchFlag;
						 }else if(issueNotifications==undefined&&issueEvents==""){
							issueFlag = true;
						 }else if(issueNotifications==undefined||issueEvents==""){
							issueFlag = false;
						 }
						 if(pullRequestNotifications!=""&&pullRequestNotifications!=undefined&&pullRequestEvents!=""){
							authValidateConfiguration(instance, pullRequestNotifications, pullRequestEvents, pullRequestFlag);
						 }else if(pullRequestNotifications==undefined&&pullRequestEvents==""){
							pullRequestMatchFlag = true;
						 }else if(pullRequestNotifications==undefined||pullRequestEvents==""){
							pullRequestMatchFlag = false;
						 }
					 console.log("repoFlag.." + repoFlag + " issueFlag" + issueFlag);
					 if(repoFlag==true&&issueFlag==true&&pullRequestMatchFlag==true&&configFlag==true){
						 console.log("pullRequestMatchFlag in cond.." + repoFlag + " issueFlag.. " + issueFlag + 
						 " pullRequestMatchFlag.." + pullRequestMatchFlag + " config Flag.." + configFlag);
							return false;
						}
					}
				});
			}
			console.log("repoFlag.." + repoFlag + " issueFlag.." + issueFlag + " pullRequestMatchFlag.." + pullRequestMatchFlag);
			if($('#repos').val()==0){
				alert("Please select Repository");
			} else if($('#rooms').val()==0 || $('#rooms').val()==null){
				alert("Please select a space");
			} else if(notificationslength==0) {
				alert("Please select at least 1 notification");
			} else if(listResultData.length != 0 && repoFlag==true && issueFlag==true && pullRequestMatchFlag==true && configFlag==true){
				if(formAction=="authupdate"){
					$.each(listResultData, function(i, instance) {
						var configData = JSON.parse(instance.configJson);
						if(!configData.unauthmode){
							var notifications=eventsToNotifications(configData.events);
							var repoEvents = notifications.repo;
							var issueEvents = notifications.issue;
							var pullRequestEvents = notifications.pullrequest;
							repoFlag = "repo";
							issueFlag = "issue";
							pullRequestFlag = "pullrequest";
						}
						if(formAction=="authupdate"&&instance.instanceId==instanceId){
							  if(repoNotifications!=""&&repoNotifications!=undefined&&repoEvents!=""){
								console.log("not empty....");
								authValidateConfiguration(instance, repoNotifications, repoEvents, repoFlag);
								repoFlag = repoMatchFlag;
							 }else if(repoNotifications==undefined&&repoEvents==""){
								repoFlag = true;
							 }else if(repoNotifications==undefined||repoEvents==""){
								console.log("repo empty");
								repoFlag = false;
							 }
							 if(issueNotifications!=""&&issueNotifications!=undefined&&issueEvents!=""){
								 authValidateConfiguration(instance, issueNotifications, issueEvents, issueFlag);
								 issueFlag = issueMatchFlag;
							 }else if(issueNotifications==undefined&&issueEvents==""){
								issueFlag = true;
							 }else if(issueNotifications==undefined||issueEvents==""){
								issueFlag = false;
							 }
							 if(pullRequestNotifications!=""&&pullRequestNotifications!=undefined&&pullRequestEvents!=""){
								authValidateConfiguration(instance, pullRequestNotifications, pullRequestEvents, pullRequestFlag);
							 }else if(pullRequestNotifications==undefined&&pullRequestEvents==""){
								pullRequestMatchFlag = true;
							 }else if(pullRequestNotifications==undefined||pullRequestEvents==""){
								pullRequestMatchFlag = false;
							 }	
							 if(room_modified || repo_modified || !repoFlag || !issueFlag || !pullRequestMatchFlag)
								$('#same-configuration').foundation('open');
							 else
								saveBitbucketAuthInstance();
						}
					});
				}else{
					$('#same-configuration').foundation('open');
				}
			}else {
				saveBitbucketAuthInstance();
			}
		}else{
			if(formAction=="unauthupdate") {
				jsonData["instance_id"] = instanceId;
				if(room_id!=room_id_old) {
					room_modified=true;
					jsonData["messageToSpark"] = updateMessageToSpark;
				} else {
					room_modified=false;
				}
				jsonData["room_modified"] = room_modified;
				jsonData["configJson"]=JSON.parse(instanceData.configJson);
				action_url=update_configuration_settings_url+instanceId;
				actionType="PUT";
				$('.loading-first-block').html('Please wait while your Integration is being updated');
				} else {
					jsonData["configJson"]={};
					jsonData["messageToSpark"] = postMessageToSpark;
					action_url=save_configuration_settings_url;
					actionType="POST";
					$('.loading-first-block').html('Please wait while your Integration is being set up');
				}
				jsonData["configJson"]["displayName"]= res.displayName;
				jsonData["configJson"]["webhookUrl"]=$("#webhookURL").val();
				jsonData["configJson"]["unauthmode"]=true;
				if(isCloudUnauth){
					jsonData["configJson"]["cloudUnauth"]=true;
				}
				jsonData["instanceUuid"]=instance_uuid;
				jsonData["messageFormat"]="bitbucket Bot :"+"Hello...User";
				unAuthJsonString = JSON.stringify(jsonData);
				if(listResultData.length != 0){
					$.each(listResultData, function(i, instance) {
						var configData = JSON.parse(instance.configJson);
						if(formAction=="unauthupdate"&&instance.instanceId!=instanceId&&configData.unauthmode){
						 unAuthValidateConfiguration(instance);
						 if(unauthConfigFlag==true){
								return false;
							}
						}
						if(formAction!="unauthupdate"&&configData.unauthmode){
						 unAuthValidateConfiguration(instance);
						  if(unauthConfigFlag==true){
								return false;
							}
						}
					});
				}
				
				
				if($('#rooms').val()==0 || $('#rooms').val()==null){
					alert("Please select a space");
				}else if(listResultData.length != 0 && unauthConfigFlag==true){
					if(formAction=="unauthupdate"){
						if(room_modified)
							$('#same-configuration').foundation('open');
						else
							saveBitbucketUnAuthInstance();
					}else{
						$('#same-configuration').foundation('open');
					}
				}else{
					console.log("no same configuration exist.");
					saveBitbucketUnAuthInstance();
				}
		}
	}
	function saveBitbucketUnAuthInstance(){
		console.log("saveBitbucketUnAuthInstance!!!!!!!!!");
		$('#same-configuration').foundation('close');
		$('.loading-second-block').html('Selected Space is '+ selectedRoomName);
		$('#loading-block').foundation('open');
		$.ajax({url: action_url,
			async:true,
			headers: { 'userId': user_id },
			type: actionType,
			data: unAuthJsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				$('.success-integration-first-block').html('Your configuration has been set up. Ensure that you have followed any additional instructions provided.');
				$('#success-integration').foundation('open');
				$('#loading-block').foundation('close');					
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					$('#loading-block').foundation('close');
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		$('.loading-first-block').html('Please wait just a moment while your app is loading');
		$('.loading-second-block').html('');
	}
	function saveBitbucketAuthInstance(){
		console.log("saveBitbucketAuthInstance!!!!!!!!!");
		$('#same-configuration').foundation('close');
		$('.loading-second-block').html('Selected Space is '+ selectedRoomName);
		$('#loading-block').foundation('open');
		$.ajax({url: action_url,
			async:true,
			headers: { 'userId': user_id , 'x-csrf-jwt': csrfJwt},
			type: actionType,
			data: authJsonString,
			contentType: "application/json",
			dataType: "json",
			success: function(result, textStatus, request){
				if(request.getResponseHeader('x-csrf-jwt') != null){
					csrfJwt = request.getResponseHeader('x-csrf-jwt');
				}
				$('.success-integration-first-block').html("Your configuration has been set up and is ready to use.");//put html text
				addInstanceValidate(result);
			},
			error: function(xmlHttpRequest, error) {
			   if(xmlHttpRequest.readyState == 0 || xmlHttpRequest.status == 0) {
				   return;
			   } else{
					$('#loading-block').foundation('close');
					alert("We've experienced some difficulty. Try again.");
				}
			}
		});
		$('.loading-first-block').html('Please wait just a moment while your app is loading');
		$('.loading-second-block').html('');
	}
</script>
</head>

<body data-whatinput="mouse">
	<div class="integration-app" id="bitbucket">
		
		<div class="rows large-12 medium-12 columns warning-msg" style="display:none;"></div>
		<div class="rows large-12 medium-12 columns client-app-warning" style="display:none;"></div>
		<div id="loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait just a moment while your app is loading</div>
				<div class="loading-second-block">name and space name</div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="list-loading-block" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="loading"><img class="spark-icon" src="" alt="....."></div>
			<div class="loading-div-background">
				<div class="loading-first-block">Please wait...</div>
				<div class="loading-second-block"></div>
				<div class="loading-bar"><div class="loading-background"></div>	</div>
			</div>
		</div>
		<div id="success-integration" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="success-loading">
				<img class="spark-icon" src="" alt=".....">
			</div>
			<div class="well-done-text">Well done!</div>
			<div class="success-integration-first-block">Your configuration has been set up and is ready to use.</div>
			<div class="large-5 medium-5 columns buttons-block">
				<div class="success-integration-second-block">
					
					<button class="secondary button" id="done-button">Done</button>
				</div>
			</div>
		</div>
		<div class="reveal" id="remove-integration-popup" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="large-12 columns desktop-block">			    
				<div class="row">
					<div class="large-2 medium-2 columns"><img alt="" id="bitbucket-icon" src=""/></div>
					<div class="large-6 medium-6 columns" style="float:left;">
						<label id="displayName-label"></label>
						<label id="addedon-label"></label>
					</div>
				</div><br>
				<div class="msg-labels"><label id="remove-msg"></label> <label id="remove-auth"></label></div>				
				<button class="close-button" data-close aria-label="Close modal" type="button">
					<span aria-hidden="true">&times;</span>
				</button><br><br>
				<button class="button remove-integration-btn" id="remove-integration-btn" style="float:right">Remove</button>
			</div>
			<div class="large-12 columns mobile-block">	
				<div class="msg-labels"><label id="remove-msg-mobile"></label> <label id="remove-auth-mobile"></label></div>				
				<div class="option-buttons remove-integration-buttons">
					<label id="cancel-remove-integration" class="remove-popup-cancel"> 
						<a href="#" >Cancel</a>
					</label>
					<label class="remove-popup-remove remove-integration-btn">
						<a href="#">Remove</a>
					</label>
				</div>
			</div>
		</div>
		<div id="same-configuration" class="reveal" data-reveal data-options="closeOnClick:false;closeOnEsc:false;">
			<div class="same-config-text">An identical configuration to the same Cisco Spark space you have selected already exists. Are you sure you want to configure one more?</div>
			<div class="large-5 medium-5 columns buttons-block">
				<button class="secondary button same-config-yes">Yes</button>
				<button class="secondary button same-config-no">No</button>
			</div>
		</div>
		<div class="large-12 columns">
			<div class='cisco_users_permission_errorclk' style="display:none;">
				
			</div>
		</div>
		
		<div class="bitbucket-links" style="display:none; margin-left:-7px;">
			<div class="bitbucket-config-note" style="margin:0 0 0 7px;"><p><b>To setup Bitbucket for Cisco Spark, choose one of three ways below.</b></P><br>
			</div>
			<div class="row large-12 medium-12 columns auth bitbucket-margin"> 
				<div class="large-10 medium-10 columns"><p> Bitbucket Cloud - Authed </p>
				<p>-Requires Bitbucket authentication <br>-Customize notifications in the Cisco Spark Depot</p><p></p>
				</div>
				<div class="large-2 medium-2 columns ciscoAuthLinkDiv ">
					<button class="button secondary auth-link text ciscousrhide " id="add-config" style="margin-right:0px;padding: 0.6rem 1.8rem;">Add</button>
					<span class='cisco_users_permission_error'></span>
				</div>
				<!--<span class='cisco_users_permission_error'></span>-->
		
			</div>
			<div class="note-on-permission" style="margin: 2px 0px 0 0;">
				<div class="">
					<p><span class="" id="add-auth-note-expand-close" title=""> &nbsp;</span><span id="note-permission-config-label">Authentication Permissions Explained</span></p><br>
				</div>
				<div id="add-note-permission" style="display:none;">
					<div class="large-12 columns sub-config-block">
						<p>While connecting for the first time, Cisco Spark will ask permissions to access your Bitbucket repositories so we can configure and manage messages received from Bitbucket. Per the scopes provided by Bitbucket, the only way we can access all your public and private repositories is using the <b>repo</b> scope which ends up giving both read and write privileges to all your public and private repo data.</p><br>
						<p>Note: Although you will be giving write permission to your repo data, Cisco Spark will only use the read permission to get a list of your public and private repositories and use the write permission to configure the webhook on Bitbucket.</p>
					</div>
					<div class="large-12 columns sub-config-block">
						<p>At any time you can remove the permissions given to Cisco Spark by following the below steps.</p><br>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 1</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to your Bitbucket Settings: <a href="https://bitbucket.com/settings" target="_blank"><u>bitbucket.com/settings</u>.</a></p>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 2</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to <b>Authorized Applications</b>, click <b>Revoke</b> next to Cisco Spark.</p>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 3</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click <b>I understand</b>, and revoke access.</p>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="row large-12 medium-12 columns unauth-cloud bitbucket-margin">
				<div class="large-10 medium-10 columns"><p>Bitbucket Cloud - Unauthed</p>
				<p>-Does not require Bitbucket authentication<br>-Customize notifications in Bitbucket</p></div>
				<div class="large-2 medium-2 columns"><button class="button secondary unauth-link1 text" style="margin-right:0px;padding: 0.6rem 1.8rem;">Add</button>
				</div>
			</div><br>
			<div class="row large-12 medium-12 columns unauth bitbucket-margin">
				<div class="large-10 medium-10 columns">
					<p>Bitbucket Server</p>
					<p>-Does not require Bitbucket authentication</p>
				</div>
				<div class="large-2 medium-2 columns"><button class="button secondary unauth-link text" style="margin-right:0px;padding: 0.6rem 1.8rem;">Add</button>
				</div>
			</div> <br>
		</div>
		<div class="integrations" id="integrations-block">
			<div id="instance-loading-block" class="row instance-loading-block" style="display: none;">
				<div class="instances-loading">&nbsp;</div>
				<div class="instances-loading-text"></div>
			</div>
			<div id="home" class="home">
				<div class="row add-config-block">
					<div class="large-12 medium-12 columns">							
						<div class="large-6 medium-6 columns config-name"><p><b>My Bitbucket configurations</b></p></div>
								
					</div>
				</div>
				<div id="instance-list-block" class="row instance-list-block"></div>
			</div>
		</div>
	<!--	<div class="note-on-permission" style="display:none;">
			<div class=""><br>
				<p><span class="" id="add-auth-note-expand-close" title=""> &nbsp;</span><span id="note-permission-config-label"><b>Authentication Permissions Explained</b></span></p><br>
			</div>
			<div id="add-note-permission" style="display:none;">
				<div class="large-12 columns sub-config-block">
					<p>While connecting for the first time, Cisco Spark will ask permissions to access your Bitbucket repositories so we can configure and manage messages received from Bitbucket. Per the scopes provided by Bitbucket, the only way we can access all your public and private repositories is using the <b>repo</b> scope which ends up giving both read and write privileges to all your public and private repo data.</p><br>
					<p><b>Note: Although you will be giving write permission to your repo data, Cisco Spark will only use the read permission to get a list of your public and private repositories and use the write permission to configure the webhook on Bitbucket.</p>
				</div>
				<div class="large-12 columns sub-config-block">
					<p>At any time you can remove the permissions given to Cisco Spark by following the below steps.</p><br>
					<div class="large-12 columns sub-config-block">
						<div class="large-1 medium-1 columns step">
							<label>Step 1</label>
						</div>
						<div class="large-11 medium-11 columns step-text">							
							<p>Go to your Bitbucket Settings: <a href="https://bitbucket.com/settings" target="_blank"><u>bitbucket.com/settings</u>.</a></p>
						</div>
					</div>
					<div class="large-12 columns sub-config-block">
						<div class="large-1 medium-1 columns step">
							<label>Step 2</label>
						</div>
						<div class="large-11 medium-11 columns step-text">							
							<p>Go to <b>Authorized Applications</b>, click <b>Revoke</b> next to Cisco Spark.</p>
						</div>
					</div>
					<div class="large-12 columns sub-config-block">
						<div class="large-1 medium-1 columns step">
							<label>Step 3</label>
						</div>
						<div class="large-11 medium-11 columns step-text">							
							<p>Click <b>I understand</b>, and revoke access.</p>
						</div>
					</div>
				</div>
			</div>
		</div> -->
		<div class="large-12 columns" id="integration-form" >
			<div class="large-12 medium-12 columns edit-itemconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured repository does not exist.</span></p>
			</div>
			<div class="large-12 medium-12 columns edit-roomconfig-info" style="display:none">
				<p><span class="info-icon" title=""> &nbsp;</span><span>Previously configured space does not exist.</span></p>
			</div>
			<div class="authenticted-block">Authenticated to Bitbucket as: <span id="authenticted-to"></span></div>
			<div class="no-configuration-block" style="display:none">There are no repositories available in your Bitbucket Account. Please create repostories in your account and configure<br></div>
			<form name="form" id="form" method="post">
				<div class="row app-config-block bitbucket-auth">
					<div class="large-12 columns first sub-config-block">					
						<h3 class="heading-01">Bitbucket Cloud - Authed configuration</h3>
						<div class="large-10 medium-10 columns items-config" style="float:left;">
							<div class="large-3 medium-4 columns"><label class="label-config">Bitbucket Repository
								<span class="has-tip tip-right" id="tooltip" title="Repository for which you'd like to receive notifications"
								data-tooltip><img class="tool-tip"></span>
							</label></div>			
							<div class="large-6 medium-6 columns dropdown-config text left">
								<select name="repositories"  id="repos" class="dropdown"><option value="0">Select</option></select>
								<div class="settings-loading" style="display: none;"></div>	
							</div>
						</div>						
					</div>
					<div class="large-12 columns events-config">
						<div class="large-12 medium-12 columns events">
							<label>Notifications: Pull requests</label>
							<div id="pull-requests" class="events-sub">
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="repo_created" name="pullrequest" value="created"/><label for="repo_created">Created</label></div>
									<div class="large-4 medium-4 columns checkbox"><input type="checkbox" id="repo_commented" name="pullrequest" value="updated"/><label for="repo_commented">Updated</label></div>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="repo_merged" name="pullrequest" value="fulfilled"/><label for="repo_merged">Merged</label></div>	
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="repo_declined" name="pullrequest" value="rejected"/><label for="repo_declined">Declined</label></div>
								</div>
							</div>
						</div>
						<div class="large-12 medium-12 columns">&nbsp;</div>
						<div class="large-12 medium-12 columns events">
							<label>Notifications: Issues</label>
							<div class="events-sub" id="issues">								
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="issue_created" name="issue" value="created"/><label for="issue_created">Created</label></div>
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="issue_updated" name="issue" value="updated"/><label for="issue_updated">Updated</label></div>
								</div>
								<div class="large-12 medium-12 columns">
									<div class="large-4 medium-4 columns checkbox"><input type="checkbox" id="issue_commented" name="issue" value="comment_created"/><label for="issue_commented">Commented</label></div>
								</div>
							</div>
						</div>
						<div class="large-12 medium-12 columns">&nbsp;</div>
						<div class="large-12 medium-12 columns events">	
							<label>Notifications: Commits</label>
							<div id="commits" class="events-sub">
								<div class="large-12 medium-12 columns">
									<div class="large-3 medium-3 columns checkbox"><input type="checkbox" id="commits_pushed" name="repo" value="push"/><label for="commits_pushed">Pushed</label></div>
									<div class="large-4 medium-4 columns checkbox"><input type="checkbox" id="commits_comment_created" name="repo" value="commit_comment_created"/><label for="commits_comment_created">Commented</label></div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="row app-config-block bitbucket-unauth" style="display:none;">
					<div class="large-12 medium-12 columns"><label class="heading-01">Bitbucket Server configuration</label></div>
					
					<div id="showConfig">
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 1</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Login to your Bitbucket account as admin. Click on the <b>Settings</b> icon.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot5.png" >					
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 2</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on<b> add-ons</b> in the left panel.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot6.png" >					
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 3</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Search for <b>Post Webhooks for Bitbucket</b> plugin in the search box and click <b>Install</b>.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot8.png" >					
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 4</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on the repository under your <b>Repositories</b> as shown below.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot1.png" >					
							</div>
						</div>
						<br/>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 5</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>In the left panel, click the <b>Settings</b> tab and click on <b>Webhooks</b> as shown below.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot2.png" >
							</div>
						</div>	
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 6</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on the <b>Add Webhook</b> tab as shown below.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot3.png" >
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 7</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<div class="large-9 columns">
									<div class="large-2 medium-2 columns">
											<label class="label-config">Webhook URL</label>
									</div>
									<div class="large-9 medium-10 columns">
										<input type="text" id="webhookURL" readonly="" name="webhookURL">	
										<a href="javascript:void(0)" id="copy">Copy URL</a>	<br>
									</div>
								</div><br><br>
								<p>Enter <b>Title</b> of your choice and paste the above <b>Webhook URL</b> into the url. Then, click Save.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Screenshot4.png" >
							</div>
						</div>
						
					</div>
				</div> 
				<div class="row app-config-block bitbucket-unauth1" style="display:none;">
					<div class="large-12 medium-12 columns"><label class="heading-01">Bitbucket Cloud - Unauthed configuration</label></div>
					<div class="large-12 medium-12 columns">
						<p>	<span class="" id="expand-close-config-unauth" title=""> &nbsp;</span><span id="config-label">Please follow the below steps to add this configuration. You can add/edit/delete multiple configurations at any time.</span></p><br>
					</div>
					<div id="showConfig1">
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 1</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p> Click <a href="https://bitbucket.org/account/signin/?next=/LogIN/" target="_blank"><u>here</u></a> to login to your Bitbucket Cloud Account.</p>				
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 2</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on <b>Repositories</b> to look at your repositories.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/bitbucketcloud01.png" >					
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 3</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on any of your repositories.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/bitbucketcloud021.png" >					
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 4</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on the <b>Settings</b> tab and then on <b>Webhooks</b> as depicted.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/bitbucketcloud02.png" >
							</div>
						</div>	
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 5</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click on the <b>Add Webhook</b> button.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/bitbucketcloud04.png" >
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 6</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<div class="large-9 columns">
									<div class="large-2 medium-2 columns">
											<label class="label-config">Webhook URL</label>
									</div>
									<div class="large-9 medium-10 columns">
										<input type="text" id="webhookURL1" readonly="" name="webhookURL">	
										<a href="javascript:void(0)" id="copy-bitbucket-unauth">Copy URL</a>	<br>
									</div>
								</div><br><br>
								<p>Copy the above <b>Webhook URL</b> and then paste it in the <b>URL</b> textbox. Select the button <b>Choose from a full list of triggers</b> and then choose the events from the check boxes for which you would like to receive notificaitons. Click on the Save button to save your configuration.</p><br>
								<img alt="" src="https://183.82.99.100:8443/CiscoWebcontent/images/bitbucket/Bitbucket_step8.png">
							</div>
						</div> 
					</div>
				</div> 
		
				<div class="row spark-config-block">
					<div class="large-10 medium-10 columns">
						<h3 class="heading-01">Cisco Spark configuration</h3>
						<div class="large-8 columns sub-config-block">
							<div class="large-2 medium-3 columns small-mobile">
								<label>Space
									<span class="has-tip tip-right" id="tooltip" title="Space in which you'd like to receive notifications. Spaces with at least 1 message will appear here." data-tooltip><img class="tool-tip"></span>
								</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<select name="room" id="rooms" class="custom-select">
									<option value='0'>Please select a space</option>
								</select>
							</div>
							<div class="spaces-refresh" title="Refresh the spaces"></div>
							<div class="rooms-loading" style="display: none;"></div>
						</div>
						<div class="large-8 columns sub-config-block left">
							<div class="large-2 medium-3 columns small-mobile config-optional">
								<label>Configuration name (optional)</label>
							</div>
							<div class="large-5 medium-5 columns text left input-small-mobile">
								<input type="text" name="displayName" id="displayName" class="integration-name"	value="">
							</div>							
						</div>
					</div>
					
				<div class="bitbucket-instructions" style="display:none;">
				<div class="large-12 medium-12 columns" style="margin: 0 0 0 -12px;">
					<p>	<span class="" id="expand-close" title=""> &nbsp;</span><span><b class="bitbucket-note">Additional Instructions</b></span></p><br>
				</div>
				<div id="bitbucket-showSetup" style="display:none;">
					<div class="large-12 medium-12 columns">
						<p><span class="" id="add-org-expand-close" title=""> &nbsp;</span><span id="add-org-config-label"><b>Add a new Bitbucket organization to Cisco Spark anytime</b></span>	</p><br>
					</div>
					<div id="add-bitbucket-org" style="display:none;">
						<div class="large-12 columns sub-config-block">
							<p>Anytime you join a new organization in Bitbucket, you need to provide access privileges to Cisco Spark if you want to receive the notifications for that organization as well.</p><br>
							<h6>Follow the below steps to grant access to a new organization.</h6>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 1</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to your Bitbucket Settings: <a href="https://bitbucket.org/settings" target="_blank"><u>bitbucket.org/settings</u>.</a></p>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 2</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to <b>Authorized Applications</b>, click <b>Cisco Spark</b>.</p>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 3</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Under <b>Organization Access</b>, click <b>Grant Access</b> next to your new organization.</p>
							</div>
						</div><br>
					</div>
					<div class="large-12 medium-12 columns">
						<p><span class="" id="note-permission-expand-close" title=""> &nbsp;</span><span id="note-permission-config-label"><b>Permissions Explained</b></span></p><br>
					</div>
					<div id="note-about-permission" style="display:none;">
						<div class="large-12 columns sub-config-block">
							<p>The permissions given to Cisco Spark are read and write access to all the public and private repository data, read and write user data, full access to repository webhooks and services (no direct code access) and full access to organization webhooks (no direct access). Click <a href="https://confluence.atlassian.com/bitbucket/oauth-on-bitbucket-cloud-238027431.html" target="_blank">here</a> for more details.</p>
							<br>
							<p>Note: Although you have given write permission to your repo data, Cisco Spark will only use the read permission to get a list of all your public and private repositories and use the write permission to configure the webhook on Bitbucket.</p><br/>
							<p>At any time you can remove the permissions given to Cisco Spark by following the below steps.</p>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 1</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to your Bitbucket Settings: <a href="https://bitbucket.com/settings" target="_blank"><u>bitbucket.org/settings</u>.</a></p>
								</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 2</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Go to <b>Authorized Applications</b>, click <b>Revoke</b> next to Cisco Spark.</p>
							</div>
						</div>
						<div class="large-12 columns sub-config-block">
							<div class="large-1 medium-1 columns step">
								<label>Step 3</label>
							</div>
							<div class="large-11 medium-11 columns step-text">							
								<p>Click <b>I understand</b>, and revoke access.</p>
							</div>
						</div><br><br><br>
					 </div>
			
				   </div>
				  </div> 
				</div>
				<div class="row integration-config-block">
					<div class="large-5 medium-5 columns"> &nbsp;</div>
					<div class="large-4 medium-4 columns left">
						<button id="cancel-button" class="button">Cancel</button>
						<button id="submit-button" class="button secondary text">Add Integration</button>
					</div>
				</div>
			</form>
		</div>
	</div>
</body>
</html>